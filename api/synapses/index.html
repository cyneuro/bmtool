
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for BMTool - A collection of modules to make developing Neuron and BMTK models easier">
      
      
        <meta name="author" content="Neural Engineering Laboratory at the University of Missouri">
      
      
        <link rel="canonical" href="https://cyneuro.github.io/bmtool/api/synapses/">
      
      
        <link rel="prev" href="../singlecell/">
      
      
        <link rel="next" href="../connectors/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Synapses - BMTool Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#synapses-api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="BMTool Documentation" class="md-header__button md-logo" aria-label="BMTool Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BMTool Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Synapses
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/cyneuro/bmtool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    cyneuro/bmtool
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../getting-started/" class="md-tabs__link">
        
  
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../modules/singlecell/" class="md-tabs__link">
          
  
  
  Modules

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../cli/" class="md-tabs__link">
        
  
  
    
  
  CLI

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/single-cell/" class="md-tabs__link">
          
  
  
  Examples

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../singlecell/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="BMTool Documentation" class="md-nav__button md-logo" aria-label="BMTool Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    BMTool Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cyneuro/bmtool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    cyneuro/bmtool
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Modules
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Modules
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/singlecell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Single Cell
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/synapses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Synapses
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/connectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connectors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    BMPlot
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    BMPlot
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/bmplot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/bmplot/connections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connection Plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/bmplot/spikes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spike Plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/bmplot/lfp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LFP/ECP Plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/bmplot/entrainment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entrainment Plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Analysis
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Analysis
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/analysis/spikes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spike Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/analysis/lfp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LFP/ECP Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/analysis/entrainment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entrainment Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/analysis/netcon_reports/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Connectivity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/slurm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SLURM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modules/graphs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Graphs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Single Cell
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Single Cell
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/single-cell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/single_cell/single_cell_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Single Cell Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/single_cell/Simple_cell_tuning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Simple Cell Tuning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/single_cell/bmtk_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Single Cell with BMTK
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Synapses
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Synapses
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/synapses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/synapses/synaptic_tuner/bmtk_chem_syn_tuner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BMTK Chemical Synapse Tuner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/synapses/synaptic_tuner/neuron_chem_syn_tuner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Neuron Chemical Synapse Tuner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/synapses/gap_junction_tuner/gap_junction_tuner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gap Junction Tuner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Connectors
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Connectors
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/connectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/connectors/connectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connectors Tutorial
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/connectors/GaussianDropoff_tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gaussian Dropoff Tutorial
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    BMPlot
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    BMPlot
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/bmplot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/bmplot/bmplot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BMPlot Tutorial
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Analysis
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Analysis
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/analysis/spiking/using_spikes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spikes Module
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/analysis/spectrogram/spectrogram_with_bmtool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Plot Spectrogram
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/analysis/phase_locking_value/spike_phase_entrainment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Phase Locking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/analysis/phase_locking_value/phase_locking_value.ipynb" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Phase Locking (Dev)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/analysis/netcon_report/netcon_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Synapse Report
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    SLURM
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    SLURM
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/slurm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/notebooks/SLURM/using_BlockRunner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Block Runner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../singlecell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Single Cell
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Synapses
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Synapses
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#synapse-tuning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Synapse Tuning
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Synapse Tuning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner" class="md-nav__link">
    <span class="md-ellipsis">
      
        SynapseTuner
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SynapseTuner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._update_spec_syn_param" class="md-nav__link">
    <span class="md-ellipsis">
      
        _update_spec_syn_param
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._set_up_cell" class="md-nav__link">
    <span class="md-ellipsis">
      
        _set_up_cell
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._set_up_synapse" class="md-nav__link">
    <span class="md-ellipsis">
      
        _set_up_synapse
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._set_up_recorders" class="md-nav__link">
    <span class="md-ellipsis">
      
        _set_up_recorders
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner.SingleEvent" class="md-nav__link">
    <span class="md-ellipsis">
      
        SingleEvent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._get_syn_prop" class="md-nav__link">
    <span class="md-ellipsis">
      
        _get_syn_prop
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._set_syn_prop" class="md-nav__link">
    <span class="md-ellipsis">
      
        _set_syn_prop
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._simulate_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        _simulate_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner.InteractiveTuner" class="md-nav__link">
    <span class="md-ellipsis">
      
        InteractiveTuner
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner.stp_frequency_response" class="md-nav__link">
    <span class="md-ellipsis">
      
        stp_frequency_response
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gap-junction-tuning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gap Junction Tuning
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gap Junction Tuning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner" class="md-nav__link">
    <span class="md-ellipsis">
      
        GapJunctionTuner
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GapJunctionTuner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.model" class="md-nav__link">
    <span class="md-ellipsis">
      
        model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.plot_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.coupling_coefficient" class="md-nav__link">
    <span class="md-ellipsis">
      
        coupling_coefficient
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.InteractiveTuner" class="md-nav__link">
    <span class="md-ellipsis">
      
        InteractiveTuner
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimization-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimization Results
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optimization Results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizationResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        SynapseOptimizationResult
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#synapse-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Synapse Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Synapse Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        SynapseOptimizer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SynapseOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._normalize_params" class="md-nav__link">
    <span class="md-ellipsis">
      
        _normalize_params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._denormalize_params" class="md-nav__link">
    <span class="md-ellipsis">
      
        _denormalize_params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._calculate_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        _calculate_metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._default_cost_function" class="md-nav__link">
    <span class="md-ellipsis">
      
        _default_cost_function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._objective_function" class="md-nav__link">
    <span class="md-ellipsis">
      
        _objective_function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer.optimize_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer.plot_optimization_results" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_optimization_results
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gap-junction-optimization-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gap Junction Optimization Results
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gap Junction Optimization Results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapOptimizationResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        GapOptimizationResult
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gap-junction-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gap Junction Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gap Junction Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        GapJunctionOptimizer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GapJunctionOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer._objective_function" class="md-nav__link">
    <span class="md-ellipsis">
      
        _objective_function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer.optimize_resistance" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_resistance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer.plot_optimization_results" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_optimization_results
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer.parameter_sweep" class="md-nav__link">
    <span class="md-ellipsis">
      
        parameter_sweep
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../connectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connectors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4" >
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    BMPlot
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    BMPlot
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bmplot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bmplot/connections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connection Plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bmplot/spikes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spike Plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bmplot/lfp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LFP/ECP Plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bmplot/entrainment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entrainment Plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_5" >
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Analysis
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Analysis
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/spikes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spike Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/lfp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LFP/ECP Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/entrainment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entrainment Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/netcon_reports/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Network Connectivity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../slurm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SLURM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../graphs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Graphs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#synapse-tuning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Synapse Tuning
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Synapse Tuning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner" class="md-nav__link">
    <span class="md-ellipsis">
      
        SynapseTuner
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SynapseTuner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._update_spec_syn_param" class="md-nav__link">
    <span class="md-ellipsis">
      
        _update_spec_syn_param
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._set_up_cell" class="md-nav__link">
    <span class="md-ellipsis">
      
        _set_up_cell
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._set_up_synapse" class="md-nav__link">
    <span class="md-ellipsis">
      
        _set_up_synapse
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._set_up_recorders" class="md-nav__link">
    <span class="md-ellipsis">
      
        _set_up_recorders
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner.SingleEvent" class="md-nav__link">
    <span class="md-ellipsis">
      
        SingleEvent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._get_syn_prop" class="md-nav__link">
    <span class="md-ellipsis">
      
        _get_syn_prop
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._set_syn_prop" class="md-nav__link">
    <span class="md-ellipsis">
      
        _set_syn_prop
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner._simulate_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        _simulate_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner.InteractiveTuner" class="md-nav__link">
    <span class="md-ellipsis">
      
        InteractiveTuner
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseTuner.stp_frequency_response" class="md-nav__link">
    <span class="md-ellipsis">
      
        stp_frequency_response
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gap-junction-tuning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gap Junction Tuning
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gap Junction Tuning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner" class="md-nav__link">
    <span class="md-ellipsis">
      
        GapJunctionTuner
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GapJunctionTuner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.model" class="md-nav__link">
    <span class="md-ellipsis">
      
        model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.plot_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.coupling_coefficient" class="md-nav__link">
    <span class="md-ellipsis">
      
        coupling_coefficient
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionTuner.InteractiveTuner" class="md-nav__link">
    <span class="md-ellipsis">
      
        InteractiveTuner
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimization-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimization Results
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optimization Results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizationResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        SynapseOptimizationResult
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#synapse-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Synapse Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Synapse Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        SynapseOptimizer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SynapseOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._normalize_params" class="md-nav__link">
    <span class="md-ellipsis">
      
        _normalize_params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._denormalize_params" class="md-nav__link">
    <span class="md-ellipsis">
      
        _denormalize_params
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._calculate_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        _calculate_metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._default_cost_function" class="md-nav__link">
    <span class="md-ellipsis">
      
        _default_cost_function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer._objective_function" class="md-nav__link">
    <span class="md-ellipsis">
      
        _objective_function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer.optimize_parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.SynapseOptimizer.plot_optimization_results" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_optimization_results
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gap-junction-optimization-results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gap Junction Optimization Results
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gap Junction Optimization Results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapOptimizationResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        GapOptimizationResult
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gap-junction-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gap Junction Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gap Junction Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        GapJunctionOptimizer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GapJunctionOptimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer._objective_function" class="md-nav__link">
    <span class="md-ellipsis">
      
        _objective_function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer.optimize_resistance" class="md-nav__link">
    <span class="md-ellipsis">
      
        optimize_resistance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer.plot_optimization_results" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_optimization_results
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bmtool.synapses.GapJunctionOptimizer.parameter_sweep" class="md-nav__link">
    <span class="md-ellipsis">
      
        parameter_sweep
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="synapses-api-reference">Synapses API Reference</h1>
<p>This page provides API reference documentation for the Synapses module, which contains tools for creating, tuning and optimizing synaptic connections in NEURON models.</p>
<h2 id="synapse-tuning">Synapse Tuning</h2>


<div class="doc doc-object doc-class">



<h3 id="bmtool.synapses.SynapseTuner" class="doc doc-heading">
            <code>bmtool.synapses.SynapseTuner</code>


</h3>


    <div class="doc doc-contents first">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>bmtool/synapses.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SynapseTuner</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">conn_type_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">current_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
        <span class="n">mechanisms_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">templates_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">general_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">json_folder_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">other_vars_to_record</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slider_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hoc_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the SynapseTuner class with connection type settings, mechanisms, and template directories.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mechanisms_dir : Optional[str]</span>
<span class="sd">            Directory path containing the compiled mod files needed for NEURON mechanisms.</span>
<span class="sd">        templates_dir : Optional[str]</span>
<span class="sd">            Directory path containing cell template files (.hoc or .py) loaded into NEURON.</span>
<span class="sd">        conn_type_settings : Optional[dict]</span>
<span class="sd">            A dictionary containing connection-specific settings, such as synaptic properties and details.</span>
<span class="sd">        connection : Optional[str]</span>
<span class="sd">            Name of the connection type to be used from the conn_type_settings dictionary.</span>
<span class="sd">        general_settings : Optional[dict]</span>
<span class="sd">            General settings dictionary including parameters like simulation time step, duration, and temperature.</span>
<span class="sd">        json_folder_path : Optional[str]</span>
<span class="sd">            Path to folder containing JSON files with additional synaptic properties to update settings.</span>
<span class="sd">        current_name : str, optional</span>
<span class="sd">            Name of the synaptic current variable to be recorded (default is &#39;i&#39;).</span>
<span class="sd">        other_vars_to_record : Optional[list]</span>
<span class="sd">            List of additional synaptic variables to record during the simulation (e.g., &#39;Pr&#39;, &#39;Use&#39;).</span>
<span class="sd">        slider_vars : Optional[list]</span>
<span class="sd">            List of synaptic variables you would like sliders set up for the STP sliders method by default will use all parameters in spec_syn_param.</span>
<span class="sd">        hoc_cell : Optional[object]</span>
<span class="sd">            An already loaded NEURON cell object. If provided, template loading and cell setup will be skipped.</span>
<span class="sd">        network : Optional[str]</span>
<span class="sd">            Name of the specific network dataset to access from the loaded edges data (e.g., &#39;network_to_network&#39;).</span>
<span class="sd">            If not provided, will use all available networks. When a config file is provided, this enables</span>
<span class="sd">            the network dropdown feature in InteractiveTuner for switching between different networks.</span>

<span class="sd">        Network Dropdown Feature:</span>
<span class="sd">        -------------------------</span>
<span class="sd">        When initialized with a BMTK config file, the tuner automatically:</span>
<span class="sd">        1. Loads all available network datasets from the config</span>
<span class="sd">        2. Creates a network dropdown in InteractiveTuner (if multiple networks exist)</span>
<span class="sd">        3. Allows dynamic switching between networks, which rebuilds connection types</span>
<span class="sd">        4. Updates connection dropdown options when network is changed</span>
<span class="sd">        5. Preserves current connection if it exists in the new network, otherwise selects the first available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="o">=</span> <span class="n">hoc_cell</span>
        <span class="c1"># Store config and network information for network dropdown functionality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>  <span class="c1"># Store config path for network dropdown functionality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store available networks from config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span> <span class="o">=</span> <span class="n">network</span>  <span class="c1"># Store current network selection</span>
        <span class="c1"># Cache for loaded dynamics params JSON by filename to avoid repeated disk reads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_syn_params_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">h</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s2">&quot;stdrun.hoc&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mechanisms_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">templates_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either a config file, both mechanisms_dir and templates_dir, or a hoc_cell must be provided.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">neuron</span><span class="o">.</span><span class="n">load_mechanisms</span><span class="p">(</span><span class="n">mechanisms_dir</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">templates_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># loads both mech and templates</span>
                <span class="n">load_templates_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                <span class="c1"># Load available networks from config for network dropdown feature</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_available_networks</span><span class="p">()</span>
                <span class="c1"># Prebuild connection type settings for each available network to</span>
                <span class="c1"># make network switching in the UI fast. This will make __init__ slower</span>
                <span class="c1"># but dramatically speed up response when changing the network dropdown.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prebuilt_conn_type_settings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_prebuilt_conn_type_settings</span><span class="p">[</span><span class="n">net</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_build_conn_type_settings_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">net</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: error prebuilding conn_type_settings for networks: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">conn_type_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building conn_type_settings from BMTK config files...&quot;</span><span class="p">)</span>
                <span class="c1"># If we prebuilt per-network settings, use the one for the requested network</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prebuilt_conn_type_settings&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">network</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prebuilt_conn_type_settings&quot;</span><span class="p">,</span> <span class="p">{}</span>
                <span class="p">):</span>
                    <span class="n">conn_type_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebuilt_conn_type_settings</span><span class="p">[</span><span class="n">network</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">conn_type_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_conn_type_settings_from_config</span><span class="p">(</span>
                        <span class="n">config</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">network</span>
                    <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conn_type_settings</span><span class="p">)</span><span class="si">}</span><span class="s2"> connection types: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="c1"># If connection is not specified, use the first available connection</span>
                <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">conn_type_settings</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No connection specified, using first available: </span><span class="si">{</span><span class="n">connection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;conn_type_settings must be provided if config is not specified.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;connection must be provided or inferable from conn_type_settings.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">connection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conn_type_settings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connection &#39;</span><span class="si">{</span><span class="n">connection</span><span class="si">}</span><span class="s2">&#39; not found in conn_type_settings.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">conn_type_settings</span>
        <span class="k">if</span> <span class="n">json_folder_path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;updating settings from json path </span><span class="si">{</span><span class="n">json_folder_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_spec_syn_param</span><span class="p">(</span><span class="n">json_folder_path</span><span class="p">)</span>
        <span class="c1"># Use default general settings if not provided</span>
        <span class="k">if</span> <span class="n">general_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">DEFAULT_GENERAL_SETTINGS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Merge defaults with user-provided</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">DEFAULT_GENERAL_SETTINGS</span><span class="p">,</span> <span class="o">**</span><span class="n">general_settings</span><span class="p">}</span>

        <span class="c1"># Store the initial connection name and set up connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_cell_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;post_cell&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;vclamp&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_name</span> <span class="o">=</span> <span class="n">current_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other_vars_to_record</span> <span class="o">=</span> <span class="n">other_vars_to_record</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Add input_mode attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Store reference to last generated figure</span>

        <span class="c1"># Store original slider_vars for connection switching</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_slider_vars</span> <span class="o">=</span> <span class="n">slider_vars</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">slider_vars</span><span class="p">:</span>
            <span class="c1"># Start by filtering based on keys in slider_vars</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">slider_vars</span>
            <span class="p">}</span>
            <span class="c1"># Iterate over slider_vars and check for missing keys in self.synaptic_props</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">slider_vars</span><span class="p">:</span>
                <span class="c1"># If the key is missing from synaptic_props, get the value using getattr</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_cell</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_synapse</span><span class="p">()</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in syn </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span>

        <span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
        <span class="n">h</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>  <span class="c1"># Time step (resolution) of the simulation in ms</span>
        <span class="n">h</span><span class="o">.</span><span class="n">steps_per_ms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">h</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">h</span><span class="o">.</span><span class="n">celsius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;celsius&quot;</span><span class="p">]</span>

        <span class="c1"># get some stuff set up we need for both SingleEvent and Interactive Tuner</span>
        <span class="c1"># Only set up cell if hoc_cell was not provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_cell</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_synapse</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetStim</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetStim</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">VClamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetCon</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;delay&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetCon</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;delay&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_recorders</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_conn_type_settings_from_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">node_set</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build conn_type_settings from BMTK simulation and circuit config files using the method used by relation matrix function in util.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        config_path : str</span>
<span class="sd">            Path to the simulation config JSON file.</span>
<span class="sd">        node_set : Optional[str]</span>
<span class="sd">            Specific node set to filter connections for. If None, processes all connections.</span>
<span class="sd">        network : Optional[str]</span>
<span class="sd">            Name of the specific network dataset to access (e.g., &#39;network_to_network&#39;).</span>
<span class="sd">            If None, processes all available networks.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        Dict[str, dict]</span>
<span class="sd">            Dictionary with connection names as keys and connection settings as values.</span>

<span class="sd">        NOTE: a lot of this code could probs be made a bit more simple or just removed i kinda tried a bunch of things and it works now</span>
<span class="sd">        but is kinda complex and some code is probs note needed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Load configuration and get nodes and edges using util.py methods</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="c1"># Ensure the config dict knows its source path so path substitutions can be resolved</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># load_config may return a dict; store path used so callers can resolve $COMPONENTS_DIR</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;config_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_path</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">load_nodes_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">load_edges_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

        <span class="n">conn_type_settings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># If a specific network is requested, only process that one</span>
        <span class="k">if</span> <span class="n">network</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">network</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Network &#39;</span><span class="si">{</span><span class="n">network</span><span class="si">}</span><span class="s2">&#39; not found in edges. Available networks: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">conn_type_settings</span>
            <span class="n">edge_datasets</span> <span class="o">=</span> <span class="p">{</span><span class="n">network</span><span class="p">:</span> <span class="n">edges</span><span class="p">[</span><span class="n">network</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edge_datasets</span> <span class="o">=</span> <span class="n">edges</span>

        <span class="c1"># Process each edge dataset using the util.py approach</span>
        <span class="k">for</span> <span class="n">edge_dataset_name</span><span class="p">,</span> <span class="n">edge_df</span> <span class="ow">in</span> <span class="n">edge_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">edge_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Create merged DataFrames with source and target node information like util.py does</span>
            <span class="n">source_node_df</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">target_node_df</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># First, try to deterministically parse the edge_dataset_name for patterns like &#39;&lt;src&gt;_to_&lt;tgt&gt;&#39;</span>
            <span class="c1"># e.g., &#39;network_to_network&#39;, &#39;extnet_to_network&#39;</span>
            <span class="k">if</span> <span class="s2">&quot;_to_&quot;</span> <span class="ow">in</span> <span class="n">edge_dataset_name</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_to_&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">src_name</span><span class="p">,</span> <span class="n">tgt_name</span> <span class="o">=</span> <span class="n">parts</span>
                    <span class="k">if</span> <span class="n">src_name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">source_node_df</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">src_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;source_&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tgt_name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">target_node_df</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">tgt_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;target_&quot;</span><span class="p">)</span>

            <span class="c1"># If not found by parsing name, fall back to inspecting a sample edge row which contains</span>
            <span class="c1"># explicit &#39;source_population&#39; and &#39;target_population&#39; fields (this avoids reversing source/target)</span>
            <span class="k">if</span> <span class="n">source_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_node_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sample_edge</span> <span class="o">=</span> <span class="n">edge_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">sample_edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Use explicit population names from the edge entry</span>
                    <span class="n">source_pop_name</span> <span class="o">=</span> <span class="n">sample_edge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_population&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">target_pop_name</span> <span class="o">=</span> <span class="n">sample_edge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_population&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">source_pop_name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">source_node_df</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">source_pop_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;source_&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_pop_name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">target_node_df</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">target_pop_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;target_&quot;</span><span class="p">)</span>

            <span class="c1"># As a last resort, attempt to heuristically match by prefix/suffix of the dataset name</span>
            <span class="k">if</span> <span class="n">source_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_node_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pop_name</span><span class="p">,</span> <span class="n">node_df</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">source_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pop_name</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">pop_name</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">source_node_df</span> <span class="o">=</span> <span class="n">node_df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;source_&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">target_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pop_name</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">pop_name</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">target_node_df</span> <span class="o">=</span> <span class="n">node_df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;target_&quot;</span><span class="p">)</span>

            <span class="c1"># If we still don&#39;t have the node data, skip this edge dataset</span>
            <span class="k">if</span> <span class="n">source_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_node_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not find node data for edge dataset </span><span class="si">{</span><span class="n">edge_dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Merge edge data with source node info</span>
            <span class="n">edges_with_source</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">edge_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                <span class="n">source_node_df</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;source_node_id&quot;</span><span class="p">,</span>
                <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Merge with target node info</span>
            <span class="n">edges_with_nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">edges_with_source</span><span class="p">,</span>
                <span class="n">target_node_df</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;target_node_id&quot;</span><span class="p">,</span>
                <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Get unique edge types from the merged dataset</span>
            <span class="k">if</span> <span class="s2">&quot;edge_type_id&quot;</span> <span class="ow">in</span> <span class="n">edges_with_nodes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">edge_types</span> <span class="o">=</span> <span class="n">edges_with_nodes</span><span class="p">[</span><span class="s2">&quot;edge_type_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edge_types</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Single edge type</span>

            <span class="c1"># Process each edge type</span>
            <span class="k">for</span> <span class="n">edge_type_id</span> <span class="ow">in</span> <span class="n">edge_types</span><span class="p">:</span>
                <span class="c1"># Filter edges for this type</span>
                <span class="k">if</span> <span class="s2">&quot;edge_type_id&quot;</span> <span class="ow">in</span> <span class="n">edges_with_nodes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">edge_type_data</span> <span class="o">=</span> <span class="n">edges_with_nodes</span><span class="p">[</span>
                        <span class="n">edges_with_nodes</span><span class="p">[</span><span class="s2">&quot;edge_type_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">edge_type_id</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_type_data</span> <span class="o">=</span> <span class="n">edges_with_nodes</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_type_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Get representative edge for this type</span>
                <span class="n">edge_info</span> <span class="o">=</span> <span class="n">edge_type_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Skip gap junctions</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;is_gap_junction&quot;</span> <span class="ow">in</span> <span class="n">edge_info</span>
                    <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">edge_info</span><span class="p">[</span><span class="s2">&quot;is_gap_junction&quot;</span><span class="p">])</span>
                    <span class="ow">and</span> <span class="n">edge_info</span><span class="p">[</span><span class="s2">&quot;is_gap_junction&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># Get population names from the merged data (this is the key improvement!)</span>
                <span class="n">source_pop</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_pop_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">target_pop</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_pop_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># Get target cell template from the merged data</span>
                <span class="n">target_model_template</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_model_template&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target_model_template</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;hoc:&quot;</span><span class="p">):</span>
                    <span class="n">target_cell_type</span> <span class="o">=</span> <span class="n">target_model_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;hoc:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_cell_type</span> <span class="o">=</span> <span class="n">target_model_template</span>

                <span class="c1"># Create connection name using the actual population names</span>
                <span class="k">if</span> <span class="n">source_pop</span> <span class="ow">and</span> <span class="n">target_pop</span><span class="p">:</span>
                    <span class="n">conn_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source_pop</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">target_pop</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">conn_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">edge_dataset_name</span><span class="si">}</span><span class="s2">_type_</span><span class="si">{</span><span class="n">edge_type_id</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="c1"># Get synaptic model template</span>
                <span class="n">model_template</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_template&quot;</span><span class="p">,</span> <span class="s2">&quot;exp2syn&quot;</span><span class="p">)</span>

                <span class="c1"># Build connection settings early so we can attach metadata like dynamics file name</span>
                <span class="n">conn_settings</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;spec_settings&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;post_cell&quot;</span><span class="p">:</span> <span class="n">target_cell_type</span><span class="p">,</span>
                        <span class="s2">&quot;vclamp_amp&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">70.0</span><span class="p">,</span>  <span class="c1"># Default voltage clamp amplitude</span>
                        <span class="s2">&quot;sec_x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># Default location on section</span>
                        <span class="s2">&quot;sec_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Default to soma</span>
                        <span class="c1"># level_of_detail may be overridden by dynamics params below</span>
                        <span class="s2">&quot;level_of_detail&quot;</span><span class="p">:</span> <span class="n">model_template</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;spec_syn_param&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="p">}</span>

                <span class="c1"># Load synaptic parameters from dynamics_params file if available.</span>
                <span class="c1"># NOTE: the edge DataFrame produced by load_edges_from_config/load_sonata_edges_to_dataframe</span>
                <span class="c1"># already contains the &#39;dynamics_params&#39; column (from the CSV) or the</span>
                <span class="c1"># flattened H5 dynamics_params attributes (prefixed with &#39;dynamics_params/&#39;).</span>
                <span class="c1"># Prefer the direct &#39;dynamics_params&#39; column value from the merged DataFrame</span>
                <span class="c1"># rather than performing ad-hoc string parsing here.</span>
                <span class="n">syn_params</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">dynamics_file_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Prefer a top-level &#39;dynamics_params&#39; column if present</span>
                <span class="k">if</span> <span class="s2">&quot;dynamics_params&quot;</span> <span class="ow">in</span> <span class="n">edge_info</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dynamics_params&quot;</span><span class="p">)):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dynamics_params&quot;</span><span class="p">)</span>
                    <span class="c1"># Some CSV loaders can produce bytes or numpy types; coerce to str</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dynamics_file_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">dynamics_file_name</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># If we found a dynamics file name, use it directly (skip token parsing)</span>
                <span class="k">if</span> <span class="n">dynamics_file_name</span> <span class="ow">and</span> <span class="n">dynamics_file_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;NULL&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">conn_settings</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;dynamics_params_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dynamics_file_name</span>
                        <span class="c1"># use a cache to avoid re-reading the same JSON multiple times</span>
                        <span class="k">if</span> <span class="n">dynamics_file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_syn_params_cache</span><span class="p">:</span>
                            <span class="n">syn_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_syn_params_cache</span><span class="p">[</span><span class="n">dynamics_file_name</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">syn_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_synaptic_params_from_config</span><span class="p">(</span>
                                <span class="n">config</span><span class="p">,</span> <span class="n">dynamics_file_name</span>
                            <span class="p">)</span>
                            <span class="c1"># cache result (even if empty dict) to avoid repeated lookups</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_syn_params_cache</span><span class="p">[</span><span class="n">dynamics_file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">syn_params</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Warning: could not load dynamics_params file &#39;</span><span class="si">{</span><span class="n">dynamics_file_name</span><span class="si">}</span><span class="s2">&#39; for edge </span><span class="si">{</span><span class="n">edge_dataset_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                <span class="c1"># If a dynamics params JSON filename was provided, prefer using its basename</span>
                <span class="c1"># as the connection name so that the UI matches the JSON definitions.</span>
                <span class="k">if</span> <span class="n">dynamics_file_name</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">json_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dynamics_file_name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># Ensure uniqueness in conn_type_settings</span>
                        <span class="k">if</span> <span class="n">json_base</span> <span class="ow">in</span> <span class="n">conn_type_settings</span><span class="p">:</span>
                            <span class="c1"># Append edge_type_id to disambiguate</span>
                            <span class="n">json_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">json_base</span><span class="si">}</span><span class="s2">_type_</span><span class="si">{</span><span class="n">edge_type_id</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">conn_name</span> <span class="o">=</span> <span class="n">json_base</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="c1"># If the dynamics params defined a level_of_detail, override the default</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">syn_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;level_of_detail&quot;</span> <span class="ow">in</span> <span class="n">syn_params</span><span class="p">:</span>
                    <span class="n">conn_settings</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;level_of_detail&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">syn_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;level_of_detail&quot;</span><span class="p">,</span> <span class="n">model_template</span>
                    <span class="p">)</span>

                <span class="c1"># Add synaptic parameters, excluding level_of_detail</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">syn_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;level_of_detail&quot;</span><span class="p">:</span>
                        <span class="n">conn_settings</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fallback: some SONATA/H5 edge files expose dynamics params as flattened</span>
                    <span class="c1"># columns named like &#39;dynamics_params/&lt;param&gt;&#39;. If no filename was given,</span>
                    <span class="c1"># gather any such columns from edge_info and use them as spec_syn_param.</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;dynamics_params/&quot;</span><span class="p">):</span>
                            <span class="n">param_key</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">edge_info</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                                    <span class="n">conn_settings</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">][</span><span class="n">param_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="c1"># Ignore malformed entries</span>
                                <span class="k">pass</span>

                <span class="c1"># Add weight from edge info if available</span>
                <span class="k">if</span> <span class="s2">&quot;syn_weight&quot;</span> <span class="ow">in</span> <span class="n">edge_info</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">edge_info</span><span class="p">[</span><span class="s2">&quot;syn_weight&quot;</span><span class="p">]):</span>
                    <span class="n">conn_settings</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">][</span><span class="s2">&quot;initW&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">edge_info</span><span class="p">[</span><span class="s2">&quot;syn_weight&quot;</span><span class="p">])</span>

                <span class="c1"># Handle afferent section information</span>
                <span class="k">if</span> <span class="s2">&quot;afferent_section_id&quot;</span> <span class="ow">in</span> <span class="n">edge_info</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span>
                    <span class="n">edge_info</span><span class="p">[</span><span class="s2">&quot;afferent_section_id&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">conn_settings</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">edge_info</span><span class="p">[</span><span class="s2">&quot;afferent_section_id&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="s2">&quot;afferent_section_pos&quot;</span> <span class="ow">in</span> <span class="n">edge_info</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span>
                    <span class="n">edge_info</span><span class="p">[</span><span class="s2">&quot;afferent_section_pos&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">conn_settings</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;sec_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                        <span class="n">edge_info</span><span class="p">[</span><span class="s2">&quot;afferent_section_pos&quot;</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="c1"># Store in connection settings</span>
                <span class="n">conn_type_settings</span><span class="p">[</span><span class="n">conn_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn_settings</span>

        <span class="k">return</span> <span class="n">conn_type_settings</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_available_networks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load available network names from the config file for the network dropdown feature.</span>

<span class="sd">        This method is automatically called during initialization when a config file is provided.</span>
<span class="sd">        It populates the available_networks list which enables the network dropdown in</span>
<span class="sd">        InteractiveTuner when multiple networks are available.</span>

<span class="sd">        Network Dropdown Behavior:</span>
<span class="sd">        -------------------------</span>
<span class="sd">        - If only one network exists: No network dropdown is shown</span>
<span class="sd">        - If multiple networks exist: Network dropdown appears next to connection dropdown</span>
<span class="sd">        - Networks are loaded from the edges data in the config file</span>
<span class="sd">        - Current network defaults to the first available if not specified during init</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">load_edges_from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Set current network to first available if not specified</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not load networks from config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_synaptic_params_from_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dynamics_params</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load synaptic parameters from dynamics params file using config information.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        config : dict</span>
<span class="sd">            BMTK configuration dictionary</span>
<span class="sd">        dynamics_params : str</span>
<span class="sd">            Dynamics parameters filename</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        dict</span>
<span class="sd">            Synaptic parameters dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the synaptic models directory from config</span>
            <span class="n">synaptic_models_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;components&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synaptic_models_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">synaptic_models_dir</span><span class="p">:</span>
                <span class="c1"># Handle path variables</span>
                <span class="k">if</span> <span class="n">synaptic_models_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">):</span>
                    <span class="c1"># This is a placeholder, try to resolve it</span>
                    <span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config_path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                    <span class="n">synaptic_models_dir</span> <span class="o">=</span> <span class="n">synaptic_models_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;$COMPONENTS_DIR&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s2">&quot;components&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">synaptic_models_dir</span> <span class="o">=</span> <span class="n">synaptic_models_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$BASE_DIR&quot;</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">)</span>

                <span class="n">dynamics_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">synaptic_models_dir</span><span class="p">,</span> <span class="n">dynamics_params</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dynamics_file</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dynamics_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Dynamics params file not found: </span><span class="si">{</span><span class="n">dynamics_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Error loading synaptic parameters: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_connections_from_config</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to list all available connections from a BMTK config file without creating a tuner.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        config_path : str</span>
<span class="sd">            Path to the simulation config JSON file.</span>
<span class="sd">        network : Optional[str]</span>
<span class="sd">            Name of the specific network dataset to access (e.g., &#39;network_to_network&#39;).</span>
<span class="sd">            If None, processes all available networks.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        Dict[str, dict]</span>
<span class="sd">            Dictionary with connection names as keys and connection info as values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a temporary instance just to use the parsing methods</span>
        <span class="n">temp_tuner</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>  <span class="c1"># Create without calling __init__</span>
        <span class="n">conn_type_settings</span> <span class="o">=</span> <span class="n">temp_tuner</span><span class="o">.</span><span class="n">_build_conn_type_settings_from_config</span><span class="p">(</span>
            <span class="n">config_path</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">network</span>
        <span class="p">)</span>

        <span class="c1"># Create a summary of connections with key info</span>
        <span class="n">connections_summary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">conn_name</span><span class="p">,</span> <span class="n">settings</span> <span class="ow">in</span> <span class="n">conn_type_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">connections_summary</span><span class="p">[</span><span class="n">conn_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;post_cell&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;post_cell&quot;</span><span class="p">],</span>
                <span class="s2">&quot;synapse_type&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;level_of_detail&quot;</span><span class="p">],</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">connections_summary</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_switch_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_connection</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch to a different connection type and update all related properties.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        new_connection : str</span>
<span class="sd">            Name of the new connection type to switch to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_connection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection &#39;</span><span class="si">{</span><span class="n">new_connection</span><span class="si">}</span><span class="s2">&#39; not found in conn_type_settings.&quot;</span><span class="p">)</span>

        <span class="c1"># Update current connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span> <span class="o">=</span> <span class="n">new_connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">[</span><span class="n">new_connection</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">]</span>

        <span class="c1"># Update slider vars for new connection</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;original_slider_vars&quot;</span><span class="p">):</span>
            <span class="c1"># Filter slider vars based on new connection&#39;s parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_slider_vars</span>
            <span class="p">}</span>

            <span class="c1"># Check for missing keys and try to get them from the synapse</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_slider_vars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># We&#39;ll get this after recreating the synapse</span>
                        <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Warning: Could not access &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; for connection &#39;</span><span class="si">{</span><span class="n">new_connection</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span>

        <span class="c1"># Need to recreate the cell if it&#39;s different</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check if we need a different cell type</span>
            <span class="n">new_cell_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;post_cell&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_current_cell_type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_cell_type</span> <span class="o">!=</span> <span class="n">new_cell_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_current_cell_type</span> <span class="o">=</span> <span class="n">new_cell_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_cell</span><span class="p">()</span>

        <span class="c1"># Recreate synapse for new connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_synapse</span><span class="p">()</span>

        <span class="c1"># Update any missing slider vars from the new synapse</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;original_slider_vars&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_slider_vars</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Warning: Could not access &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; for connection &#39;</span><span class="si">{</span><span class="n">new_connection</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

        <span class="c1"># Recreate NetCon connections with new synapse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetCon</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;delay&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetCon</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;delay&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Recreate voltage clamp with potentially new cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">VClamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">))</span>

        <span class="c1"># Recreate recorders for new synapse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_recorders</span><span class="p">()</span>

        <span class="c1"># Reset NEURON state</span>
        <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully switched to connection: </span><span class="si">{</span><span class="n">new_connection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_switch_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_network</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch to a different network and rebuild conn_type_settings for the new network.</span>

<span class="sd">        This method is called when the user selects a different network from the network</span>
<span class="sd">        dropdown in InteractiveTuner. It performs a complete rebuild of the connection</span>
<span class="sd">        types available for the new network.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        new_network : str</span>
<span class="sd">            Name of the new network to switch to.</span>

<span class="sd">        Network Switching Process:</span>
<span class="sd">        -------------------------</span>
<span class="sd">        1. Validates the new network exists in available_networks</span>
<span class="sd">        2. Rebuilds conn_type_settings using the new network&#39;s edge data</span>
<span class="sd">        3. Updates the connection dropdown with new network&#39;s available connections</span>
<span class="sd">        4. Preserves current connection if it exists in new network</span>
<span class="sd">        5. Falls back to first available connection if current doesn&#39;t exist</span>
<span class="sd">        6. Recreates synapses and NEURON objects for the new connection</span>
<span class="sd">        7. Updates UI components to reflect the changes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_network</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: Network &#39;</span><span class="si">{</span><span class="n">new_network</span><span class="si">}</span><span class="s2">&#39; not found in available networks: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">new_network</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># No change needed</span>

        <span class="c1"># Update current network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span> <span class="o">=</span> <span class="n">new_network</span>

        <span class="c1"># Switch conn_type_settings using prebuilt data if available, otherwise build on-demand</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Switching connections for network: </span><span class="si">{</span><span class="n">new_network</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prebuilt_conn_type_settings&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">new_network</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebuilt_conn_type_settings</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebuilt_conn_type_settings</span><span class="p">[</span><span class="n">new_network</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback: build on-demand (slower)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_conn_type_settings_from_config</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">new_network</span>
                <span class="p">)</span>

            <span class="c1"># Update available connections and select first one if current doesn&#39;t exist</span>
            <span class="n">available_connections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_connections</span> <span class="ow">and</span> <span class="n">available_connections</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span> <span class="o">=</span> <span class="n">available_connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connection &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="si">}</span><span class="s2">&#39; not available in new network. Switched to: </span><span class="si">{</span><span class="n">available_connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Switch to the (potentially new) connection</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully switched to network: </span><span class="si">{</span><span class="n">new_network</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available connections: </span><span class="si">{</span><span class="n">available_connections</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_spec_syn_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update specific synaptic parameters using JSON files located in the specified folder.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        json_folder_path : str</span>
<span class="sd">            Path to folder containing JSON files, where each JSON file corresponds to a connection type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">conn_type</span><span class="p">,</span> <span class="n">settings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">json_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json_folder_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">conn_type</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_file_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
                    <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON file for </span><span class="si">{</span><span class="n">conn_type</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_up_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the neuron cell based on the specified connection settings.</span>
<span class="sd">        This method is only called when hoc_cell is not provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;post_cell&quot;</span><span class="p">])()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_up_synapse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the synapse on the target cell according to the synaptic parameters in `conn_type_settings`.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - `_set_up_cell()` should be called before setting up the synapse.</span>
<span class="sd">        - Synapse location, type, and properties are specified within `spec_syn_param` and `spec_settings`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;level_of_detail&quot;</span><span class="p">])(</span>
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]](</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;sec_x&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Make sure the mod file exist you are trying to load check spelling!&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> cannot be assigned as it does not exist in the synapse. Check your mod file or spec_syn_param.&quot;</span>
                    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_up_recorders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up recording vectors to capture simulation data.</span>

<span class="sd">        The method sets up recorders for:</span>
<span class="sd">        - Synaptic current specified by `current_name`</span>
<span class="sd">        - Other specified synaptic variables (`other_vars_to_record`)</span>
<span class="sd">        - Time, soma voltage, and voltage clamp current for all simulations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_vars_to_record</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
            <span class="n">ref_attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_ref_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">ref_attr</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">ref_attr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">ref_attr</span><span class="si">}</span><span class="s2"> not found in the syn object. Use vars() to inspect available attributes.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Record synaptic current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
        <span class="n">ref_attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_ref_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">ref_attr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">]</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">ref_attr</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Synaptic current recorder not set up correctly.&quot;</span><span class="p">)</span>

        <span class="c1"># Record time, synaptic events, soma voltage, and voltage clamp current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tspk</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soma_v</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivcl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">_ref_t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc2</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soma_v</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivcl</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">_ref_i</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">SingleEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_and_print</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate a single synaptic event by delivering an input stimulus to the synapse.</span>

<span class="sd">        The method sets up the neuron cell, synapse, stimulus, and voltage clamp,</span>
<span class="sd">        and then runs the NEURON simulation for a single event. The single synaptic event will occur at general_settings[&#39;tstart&#39;]</span>
<span class="sd">        Will display graphs and synaptic properies works best with a jupyter notebook</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># user slider values if the sliders are set up</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dynamic_sliders&quot;</span><span class="p">):</span>
            <span class="n">syn_props</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">slider</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">slider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_syn_prop</span><span class="p">(</span><span class="o">**</span><span class="n">syn_props</span><span class="p">)</span>

        <span class="c1"># sets values based off optimizer</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;using_optimizer&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Set up the stimulus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">tstop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set up voltage clamp</span>
        <span class="n">vcldur</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span> <span class="n">h</span><span class="o">.</span><span class="n">tstop</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">dur</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcldur</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Run simulation</span>
        <span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">tstop</span>
        <span class="n">h</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">])</span>
        <span class="n">syn_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_syn_prop</span><span class="p">(</span>
            <span class="n">rise_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;rise_interval&quot;</span><span class="p">],</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span>
        <span class="p">)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">syn_props</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># Convert to pA</span>
        <span class="n">current_integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>  <span class="c1"># pAms</span>

        <span class="k">if</span> <span class="n">plot_and_print</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_model</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">],</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Integral in pA*ms: </span><span class="si">{</span><span class="n">current_integral</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rise_time</span> <span class="o">=</span> <span class="n">syn_props</span><span class="p">[</span><span class="s2">&quot;rise_time&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span> <span class="o">=</span> <span class="n">syn_props</span><span class="p">[</span><span class="s2">&quot;decay_time&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_first</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the index of the first non-zero element in a given array.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        x : np.array</span>
<span class="sd">            The input array to search.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        int</span>
<span class="sd">            Index of the first non-zero element, or None if none exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_syn_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rise_interval</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate synaptic properties such as peak amplitude, latency, rise time, decay time, and half-width.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        rise_interval : tuple of floats, optional</span>
<span class="sd">            Fractional rise time interval to calculate (default is (0.2, 0.8)).</span>
<span class="sd">        dt : float, optional</span>
<span class="sd">            Time step of the simulation (default is NEURON&#39;s `h.dt`).</span>
<span class="sd">        short : bool, optional</span>
<span class="sd">            If True, only return baseline and sign without calculating full properties.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary containing the synaptic properties: baseline, sign, peak amplitude, latency, rise time,</span>
<span class="sd">            decay time, and half-width.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span><span class="p">:</span>
            <span class="n">isyn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivcl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isyn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">]</span>
        <span class="n">isyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">isyn</span><span class="p">)</span>
        <span class="n">tspk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tspk</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">tspk</span> <span class="o">=</span> <span class="n">tspk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ispk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">tspk</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="n">isyn</span><span class="p">[</span><span class="n">ispk</span><span class="p">]</span>
        <span class="n">isyn</span> <span class="o">=</span> <span class="n">isyn</span><span class="p">[</span><span class="n">ispk</span><span class="p">:]</span> <span class="o">-</span> <span class="n">baseline</span>
        <span class="c1"># print(np.abs(isyn))</span>
        <span class="c1"># print(np.argmax(np.abs(isyn)))</span>
        <span class="c1"># print(isyn[np.argmax(np.abs(isyn))])</span>
        <span class="c1"># print(np.sign(isyn[np.argmax(np.abs(isyn))]))</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">isyn</span><span class="p">))])</span>
        <span class="k">if</span> <span class="n">short</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="n">baseline</span><span class="p">,</span> <span class="s2">&quot;sign&quot;</span><span class="p">:</span> <span class="n">sign</span><span class="p">}</span>
        <span class="n">isyn</span> <span class="o">*=</span> <span class="n">sign</span>
        <span class="c1"># print(isyn)</span>
        <span class="c1"># peak amplitude</span>
        <span class="n">ipk</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">isyn</span><span class="p">)</span>
        <span class="n">ipk</span> <span class="o">=</span> <span class="n">ipk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">isyn</span><span class="p">[</span><span class="n">ipk</span><span class="p">]</span>
        <span class="c1"># latency</span>
        <span class="n">istart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">isyn</span><span class="p">[:</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">istart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># rise time</span>
        <span class="n">rt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">istart</span> <span class="p">:</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rise_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">peak</span><span class="p">)</span>
        <span class="n">rt2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">istart</span> <span class="p">:</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rise_interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">peak</span><span class="p">)</span>
        <span class="n">rise_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">rt2</span> <span class="o">-</span> <span class="n">rt1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="c1"># decay time</span>
        <span class="n">iend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">ipk</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">iend</span> <span class="o">=</span> <span class="n">isyn</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">iend</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">iend</span> <span class="o">+</span> <span class="n">ipk</span>
        <span class="n">decay_len</span> <span class="o">=</span> <span class="n">iend</span> <span class="o">-</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t</span> <span class="o">/</span> <span class="n">tau</span><span class="p">),</span>
            <span class="n">dt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">decay_len</span><span class="p">),</span>
            <span class="n">isyn</span><span class="p">[</span><span class="n">ipk</span> <span class="p">:</span> <span class="n">iend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">decay_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">decay_time</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># half-width</span>
        <span class="n">hw1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">istart</span> <span class="p">:</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">peak</span><span class="p">)</span>
        <span class="n">hw2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">ipk</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">peak</span><span class="p">)</span>
        <span class="n">hw2</span> <span class="o">=</span> <span class="n">isyn</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="n">hw2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">hw2</span> <span class="o">+</span> <span class="n">ipk</span>
        <span class="n">half_width</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">hw2</span> <span class="o">-</span> <span class="n">hw1</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="n">baseline</span><span class="p">,</span>
            <span class="s2">&quot;sign&quot;</span><span class="p">:</span> <span class="n">sign</span><span class="p">,</span>
            <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="n">latency</span><span class="p">,</span>
            <span class="s2">&quot;amp&quot;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span>
            <span class="s2">&quot;rise_time&quot;</span><span class="p">:</span> <span class="n">rise_time</span><span class="p">,</span>
            <span class="s2">&quot;decay_time&quot;</span><span class="p">:</span> <span class="n">decay_time</span><span class="p">,</span>
            <span class="s2">&quot;half_width&quot;</span><span class="p">:</span> <span class="n">half_width</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the results of the simulation, including synaptic current, soma voltage,</span>
<span class="sd">        and any additional recorded variables.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        xlim : tuple</span>
<span class="sd">            A tuple specifying the limits of the x-axis for the plot (start_time, end_time).</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - The function determines how many plots to generate based on the number of variables recorded.</span>
<span class="sd">        - Synaptic current and either voltage clamp or soma voltage will always be plotted.</span>
<span class="sd">        - If other variables are provided in `other_vars_to_record`, they are also plotted.</span>
<span class="sd">        - The function adjusts the plot layout and removes any extra subplots that are not needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the number of plots to generate (at least 2: current and voltage)</span>
        <span class="n">num_vars_to_plot</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_vars_to_record</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_vars_to_record</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Set up figure based on number of plots (2x2 grid max)</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_vars_to_plot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># This ensures we have enough rows</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Plot synaptic current (always included)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">]</span>
        <span class="n">syn_prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_syn_prop</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">current</span> <span class="o">-</span> <span class="n">syn_prop</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">]</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">current</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ispk</span><span class="p">)):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ispk</span><span class="p">[</span><span class="n">num</span><span class="p">]],</span> <span class="n">current</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ispk</span><span class="p">[</span><span class="n">num</span><span class="p">]],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Synaptic Current (pA)&quot;</span><span class="p">)</span>

        <span class="c1"># Plot voltage clamp or soma voltage (always included)</span>
        <span class="n">ispk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivcl</span><span class="p">[</span><span class="n">ispk</span><span class="p">]</span>
            <span class="n">ivcl_plt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivcl</span><span class="p">)</span> <span class="o">-</span> <span class="n">baseline</span>
            <span class="n">ivcl_plt</span><span class="p">[:</span><span class="n">ispk</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ivcl_plt</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;VClamp Current (pA)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">soma_v_plt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soma_v</span><span class="p">)</span>
            <span class="n">soma_v_plt</span><span class="p">[:</span><span class="n">ispk</span><span class="p">]</span> <span class="o">=</span> <span class="n">soma_v_plt</span><span class="p">[</span><span class="n">ispk</span><span class="p">]</span>

            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">soma_v_plt</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Soma Voltage (mV)&quot;</span><span class="p">)</span>

        <span class="c1"># Plot any other variables from other_vars_to_record, if provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_vars_to_record</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">other_vars_to_record</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Adjust the layout</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">[:</span><span class="n">num_vars_to_plot</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">num_vars_to_plot</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Add x-label to the last row</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (ms)&quot;</span><span class="p">)</span>

        <span class="c1"># Remove extra subplots if less than 4 plots are present</span>
        <span class="k">if</span> <span class="n">num_vars_to_plot</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_vars_to_plot</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">)):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="c1"># plt.tight_layout()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_drive_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">250.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configures trains of 12 action potentials at a specified frequency and delay period</span>
<span class="sd">        between pulses 8 and 9.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        freq : float, optional</span>
<span class="sd">            Frequency of the pulse train in Hz. Default is 50 Hz.</span>
<span class="sd">        delay : float, optional</span>
<span class="sd">            Delay period in milliseconds between the 8th and 9th pulses. Default is 250 ms.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        tstop : float</span>
<span class="sd">            The time at which the last pulse stops.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - This function is based on experiments from the Allen Database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># lets also set the train drive and delay here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_freq</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_delay</span> <span class="o">=</span> <span class="n">delay</span>

        <span class="n">n_init_pulse</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">n_ending_pulse</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">n_init_pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">n_ending_pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_init_pulse</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">+</span> <span class="n">delay</span>
        <span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">n_ending_pulse</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">interval</span>
        <span class="k">return</span> <span class="n">tstop</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_response_amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the amplitude of synaptic responses for each pulse in a train.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        amp : list</span>
<span class="sd">            A list containing the peak amplitudes for each pulse in the recorded synaptic current.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method:</span>
<span class="sd">        1. Extracts and normalizes the synaptic current</span>
<span class="sd">        2. Identifies spike times and segments the current accordingly</span>
<span class="sd">        3. Calculates the peak response amplitude for each segment</span>
<span class="sd">        4. Records the indices of peak amplitudes for visualization</span>

<span class="sd">        The amplitude values are returned in the original current units (before pA conversion).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">isyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_python</span><span class="p">())</span>
        <span class="n">tspk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspk</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">tstop</span><span class="p">)</span>
        <span class="n">syn_prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_syn_prop</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="c1"># print(&quot;syn_prp[sign] = &quot; + str(syn_prop[&#39;sign&#39;]))</span>
        <span class="n">isyn</span> <span class="o">=</span> <span class="n">isyn</span> <span class="o">-</span> <span class="n">syn_prop</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">]</span>
        <span class="n">isyn</span> <span class="o">*=</span> <span class="n">syn_prop</span><span class="p">[</span><span class="s2">&quot;sign&quot;</span><span class="p">]</span>
        <span class="n">ispk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">tspk</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;delay&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="p">[</span><span class="n">isyn</span><span class="p">[</span><span class="n">ispk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">ispk</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ispk</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="c1"># indexs of where the max of the synaptic current is at. This is then plotted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">ispk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">ispk</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="n">ispk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ispk</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="c1"># Sometimes the sim can cutoff at the peak of synaptic activity. So we just reduce the range by 1 and ingore that point</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="p">[</span><span class="n">isyn</span><span class="p">[</span><span class="n">ispk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">ispk</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ispk</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">ispk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">ispk</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="n">ispk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ispk</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">amp</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_max_amp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the maximum amplitude from the response data and returns the max in pA</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        amp : array-like</span>
<span class="sd">            Array containing the amplitudes of synaptic responses.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        max_amp : float</span>
<span class="sd">            The maximum or minimum amplitude based on the sign of the response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_amp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
        <span class="n">min_amp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_amp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_amp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">min_amp</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># scale unit</span>
        <span class="k">return</span> <span class="n">max_amp</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># scale unit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_ppr_induction_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">normalize_by_trial</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">print_math</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates paired-pulse ratio, induction, recovery, and simple PPR metrics from response amplitudes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        amp : array-like</span>
<span class="sd">            Array containing the amplitudes of synaptic responses to a pulse train.</span>
<span class="sd">        normalize_by_trial : bool, optional</span>
<span class="sd">            If True, normalize the amplitudes within each trial. Default is True.</span>
<span class="sd">        print_math : bool, optional</span>
<span class="sd">            If True, print detailed calculation steps and explanations. Default is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - ppr: Paired-pulse ratio (2nd pulse - 1st pulse) normalized by 90th percentile amplitude</span>
<span class="sd">            - induction: Measure of facilitation/depression during initial pulses</span>
<span class="sd">            - recovery: Measure of recovery after the delay period</span>
<span class="sd">            - simple_ppr: Simple paired-pulse ratio (2nd pulse / 1st pulse)</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        - PPR &gt; 0 indicates facilitation, PPR &lt; 0 indicates depression</span>
<span class="sd">        - Simple PPR &gt; 1 indicates facilitation, Simple PPR &lt; 1 indicates depression</span>
<span class="sd">        - Induction &gt; 0 indicates facilitation, Induction &lt; 0 indicates depression</span>
<span class="sd">        - Recovery compares the response after delay to the initial pulses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">amp</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># scale up</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">amp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Calculate 90th percentile amplitude for normalization</span>
        <span class="n">percentile_90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">format_array</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Format an array to 2 significant figures for cleaner output.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="n">suppress_small</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">print_math</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Short Term Plasticity Results for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">train_freq</span><span class="si">}</span><span class="s2">Hz with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">train_delay</span><span class="si">}</span><span class="s2"> Delay&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simple PPR: Above 1 is facilitating, below 1 is depressing&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PPR:        Above 0 is facilitating, below 0 is depressing.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Induction:  Above 0 is facilitating, below 0 is depressing.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recovery:   A measure of how fast STP decays.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Simple PPR Calculation: Avg 2nd pulse / Avg 1st pulse</span>
            <span class="n">simple_ppr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Simple Paired Pulse Ratio (PPR)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Calculation: Avg 2nd pulse / Avg 1st pulse&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;    Values: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">simple_ppr</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># PPR Calculation: (Avg 2nd pulse - Avg 1st pulse) / 90th percentile amplitude</span>
            <span class="n">ppr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="n">percentile_90</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Paired Pulse Response (PPR)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Calculation: (Avg 2nd pulse - Avg 1st pulse) / 90th percentile amplitude&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;    Values: (</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) / </span><span class="si">{</span><span class="n">percentile_90</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">ppr</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Induction Calculation: (Avg (6th, 7th, 8th pulses) - Avg 1st pulse) / 90th percentile amplitude</span>
            <span class="n">induction</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="n">percentile_90</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Induction&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;    Calculation: (Avg(6th, 7th, 8th pulses) - Avg 1st pulse) / 90th percentile amplitude&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;    Values: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span><span class="w"> </span><span class="p">:</span><span class="mi">1</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">percentile_90</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">induction</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Recovery Calculation: (Avg (9th, 10th, 11th, 12th pulses) - Avg (1st, 2nd, 3rd, 4th pulses)) / 90th percentile amplitude</span>
            <span class="n">recovery</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]))</span> <span class="o">/</span> <span class="n">percentile_90</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recovery&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;    Calculation: (Avg(9th, 10th, 11th, 12th pulses) - Avg(1st to 4th pulses)) / 90th percentile amplitude&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;    Values: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span><span class="w"> </span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">percentile_90</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">recovery</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate final metrics</span>
        <span class="n">ppr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="n">percentile_90</span>
        <span class="n">induction</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="n">percentile_90</span>
        <span class="n">recovery</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]))</span> <span class="o">/</span> <span class="n">percentile_90</span>
        <span class="n">simple_ppr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ppr</span><span class="p">,</span> <span class="n">induction</span><span class="p">,</span> <span class="n">recovery</span><span class="p">,</span> <span class="n">simple_ppr</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_syn_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the synaptic parameters based on user inputs from sliders.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Synaptic properties (such as weight, Use, tau_f, tau_d) as keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_simulate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_frequency</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">vclamp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the simulation with the specified input frequency, delay, and voltage clamp settings.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        input_frequency : float</span>
<span class="sd">            Frequency of the input drive train in Hz.</span>
<span class="sd">        delay : float</span>
<span class="sd">            Delay period in milliseconds between the 8th and 9th pulses.</span>
<span class="sd">        vclamp : bool or None, optional</span>
<span class="sd">            Whether to use voltage clamp. If None, the current setting is used. Default is None.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method handles two different input modes:</span>
<span class="sd">        - Standard train mode with 8 initial pulses followed by a delay and 4 additional pulses</span>
<span class="sd">        - Continuous input mode where stimulation continues for a specified duration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_drive_train</span><span class="p">(</span><span class="n">input_frequency</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span>

            <span class="n">vcldur</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">dur</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcldur</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">(</span><span class="mi">70</span> <span class="o">*</span> <span class="n">mV</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">continuerun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">*</span> <span class="n">ms</span><span class="p">)</span>
            <span class="c1"># h.run()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Continuous input mode: ensure simulation runs long enough for the full stimulation duration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">300</span>
            <span class="p">)</span>  <span class="c1"># 300ms buffer time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">input_frequency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">input_frequency</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">(</span><span class="mi">70</span> <span class="o">*</span> <span class="n">mV</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">continuerun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">*</span> <span class="n">ms</span><span class="p">)</span>
            <span class="c1"># h.run()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">InteractiveTuner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up interactive sliders for tuning short-term plasticity (STP) parameters in a Jupyter Notebook.</span>

<span class="sd">        This method creates an interactive UI with sliders for:</span>
<span class="sd">        - Network selection dropdown (if multiple networks available and config provided)</span>
<span class="sd">        - Connection type selection dropdown</span>
<span class="sd">        - Input frequency</span>
<span class="sd">        - Delay between pulse trains</span>
<span class="sd">        - Duration of stimulation (for continuous input mode)</span>
<span class="sd">        - Synaptic parameters (e.g., Use, tau_f, tau_d) based on the syn model</span>

<span class="sd">        It also provides buttons for:</span>
<span class="sd">        - Running a single event simulation</span>
<span class="sd">        - Running a train input simulation</span>
<span class="sd">        - Toggling voltage clamp mode</span>
<span class="sd">        - Switching between standard and continuous input modes</span>

<span class="sd">        Network Dropdown Feature:</span>
<span class="sd">        ------------------------</span>
<span class="sd">        When the SynapseTuner is initialized with a BMTK config file containing multiple networks:</span>
<span class="sd">        - A network dropdown appears next to the connection dropdown</span>
<span class="sd">        - Users can dynamically switch between networks (e.g., &#39;network_to_network&#39;, &#39;external_to_network&#39;)</span>
<span class="sd">        - Switching networks rebuilds available connections and updates the connection dropdown</span>
<span class="sd">        - The current connection is preserved if it exists in the new network</span>
<span class="sd">        - If multiple networks exist but only one is specified during init, that network is used as default</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        Ideal for exploratory parameter tuning and interactive visualization of</span>
<span class="sd">        synapse behavior with different parameter values and stimulation protocols.</span>
<span class="sd">        The network dropdown feature enables comprehensive exploration of multi-network</span>
<span class="sd">        BMTK simulations without needing to reinitialize the tuner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Widgets setup (Sliders)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
        <span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="mi">125</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">]</span>
        <span class="n">durations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
        <span class="n">freq0</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">delay0</span> <span class="o">=</span> <span class="mi">250</span>
        <span class="n">duration0</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="n">vlamp_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span>

        <span class="c1"># Connection dropdown</span>
        <span class="n">connection_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">w_connection</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
            <span class="n">options</span><span class="o">=</span><span class="n">connection_options</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Connection:&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Network dropdown - only shown if config was provided and multiple networks are available</span>
        <span class="c1"># This enables users to switch between different network datasets dynamically</span>
        <span class="n">w_network</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">w_network</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
                <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_network</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Network:&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="n">w_run</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run Train&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;history&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
        <span class="n">w_single</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Single Event&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;check&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
        <span class="n">w_vclamp</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">vlamp_status</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Voltage Clamp&quot;</span><span class="p">,</span>
            <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;fast-backward&quot;</span><span class="p">,</span>
            <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Voltage clamp amplitude input</span>
        <span class="n">default_vclamp_amp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">],</span> <span class="s2">&quot;vclamp_amp&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.0</span><span class="p">)</span>
        <span class="n">w_vclamp_amp</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">default_vclamp_amp</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;V_clamp (mV):&quot;</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;150px&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">w_input_mode</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Continuous input&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;eject&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;info&quot;</span>
        <span class="p">)</span>
        <span class="n">w_input_freq</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">SelectionSlider</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">freq0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Input Freq&quot;</span><span class="p">)</span>

        <span class="c1"># Sliders for delay and duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">SelectionSlider</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">delays</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">delay0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Delay&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">SelectionSlider</span><span class="p">(</span>
            <span class="n">options</span><span class="o">=</span><span class="n">durations</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">duration0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Duration&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Save functionality widgets</span>
        <span class="n">save_path_text</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="s2">&quot;plot.png&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Save path:&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;300px&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">save_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Save Plot&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">save_plot</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;last_figure&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create a new figure with just the first subplot (synaptic current)</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

                    <span class="c1"># Get the axes from the original figure</span>
                    <span class="n">original_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_axes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">first_ax</span> <span class="o">=</span> <span class="n">original_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># Copy the data from the first subplot</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">first_ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">():</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">(),</span>
                                <span class="n">line</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                                <span class="n">label</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
                            <span class="p">)</span>

                        <span class="c1"># Copy axis labels and title</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">first_ax</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">())</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">first_ax</span><span class="o">.</span><span class="n">get_ylabel</span><span class="p">())</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">first_ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">())</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">first_ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                        <span class="c1"># Save the new figure</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path_text</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>  <span class="c1"># Close the temporary figure</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synaptic current plot saved to </span><span class="si">{</span><span class="n">save_path_text</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No subplots found in the figure&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No plot to save&quot;</span><span class="p">)</span>

        <span class="n">save_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">save_plot</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">create_dynamic_sliders</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Create sliders based on current connection&#39;s parameters&quot;&quot;&quot;</span>
            <span class="n">sliders</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>  <span class="c1"># Only create sliders for numeric values</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> was set to zero, going to try to set a range of values, try settings the </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> to a nonzero value if you dont like the range!&quot;</span>
                            <span class="p">)</span>
                            <span class="n">slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                                <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">key</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                                <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">value</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">value</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">key</span>
                            <span class="p">)</span>
                        <span class="n">sliders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">slider</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skipping slider for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> due to not being a synaptic variable&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sliders</span>

        <span class="c1"># Generate sliders dynamically based on valid numeric entries in self.slider_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span> <span class="o">=</span> <span class="n">create_dynamic_sliders</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Setting up slider! The sliders ranges are set by their init value so try changing that if you dont like the slider range!&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create output widget for displaying results</span>
        <span class="n">output_widget</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">run_single_event</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">clear_output</span><span class="p">()</span>
            <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># Update voltage clamp amplitude if voltage clamp is enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span><span class="p">:</span>
                <span class="c1"># Update the voltage clamp amplitude settings</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_vclamp_amp</span><span class="o">.</span><span class="n">value</span>
                <span class="c1"># Update general settings if they exist</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;general_settings&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_vclamp_amp</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># Update synaptic properties based on slider values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Clear previous results and run simulation</span>
            <span class="n">output_widget</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">output_widget</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SingleEvent</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">on_connection_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle connection dropdown change&quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_connection</span> <span class="o">=</span> <span class="n">w_connection</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">new_connection</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">:</span>
                    <span class="c1"># Switch to new connection</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">new_connection</span><span class="p">)</span>

                    <span class="c1"># Recreate dynamic sliders for new connection</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span> <span class="o">=</span> <span class="n">create_dynamic_sliders</span><span class="p">()</span>

                    <span class="c1"># Update UI</span>
                    <span class="n">update_ui_layout</span><span class="p">()</span>
                    <span class="n">update_ui</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error switching connection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">on_network_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Handle network dropdown change events.</span>

<span class="sd">            This callback is triggered when the user selects a different network from</span>
<span class="sd">            the network dropdown. It coordinates the complete switching process:</span>
<span class="sd">            1. Calls _switch_network() to rebuild connections for the new network</span>
<span class="sd">            2. Updates the connection dropdown options with new network&#39;s connections</span>
<span class="sd">            3. Recreates dynamic sliders for new connection parameters</span>
<span class="sd">            4. Refreshes the entire UI to reflect all changes</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">w_network</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_network</span> <span class="o">=</span> <span class="n">w_network</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">new_network</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span><span class="p">:</span>
                    <span class="c1"># Switch to new network</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_switch_network</span><span class="p">(</span><span class="n">new_network</span><span class="p">)</span>

                    <span class="c1"># Update connection dropdown options with new network&#39;s connections</span>
                    <span class="n">connection_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">w_connection</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">connection_options</span>
                    <span class="k">if</span> <span class="n">connection_options</span><span class="p">:</span>
                        <span class="n">w_connection</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span>

                    <span class="c1"># Recreate dynamic sliders for new connection</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span> <span class="o">=</span> <span class="n">create_dynamic_sliders</span><span class="p">()</span>

                    <span class="c1"># Update UI</span>
                    <span class="n">update_ui_layout</span><span class="p">()</span>
                    <span class="n">update_ui</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error switching network: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">update_ui_layout</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Update the UI layout with new sliders and network dropdown.</span>

<span class="sd">            This function reconstructs the entire UI layout including:</span>
<span class="sd">            - Network dropdown (if available) and connection dropdown in the top row</span>
<span class="sd">            - Button controls and input mode toggles</span>
<span class="sd">            - Parameter sliders arranged in columns</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">nonlocal</span> <span class="n">ui</span><span class="p">,</span> <span class="n">slider_columns</span>

            <span class="c1"># Add the dynamic sliders to the UI</span>
            <span class="n">slider_widgets</span> <span class="o">=</span> <span class="p">[</span><span class="n">slider</span> <span class="k">for</span> <span class="n">slider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

            <span class="k">if</span> <span class="n">slider_widgets</span><span class="p">:</span>
                <span class="n">half</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slider_widgets</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">col1</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">(</span><span class="n">slider_widgets</span><span class="p">[:</span><span class="n">half</span><span class="p">])</span>
                <span class="n">col2</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">(</span><span class="n">slider_widgets</span><span class="p">[</span><span class="n">half</span><span class="p">:])</span>
                <span class="n">slider_columns</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">slider_columns</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([])</span>

            <span class="c1"># Create button row with voltage clamp controls</span>
            <span class="k">if</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>  <span class="c1"># Show voltage clamp amplitude input when toggle is on</span>
                <span class="n">button_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_run</span><span class="p">,</span> <span class="n">w_single</span><span class="p">,</span> <span class="n">w_vclamp</span><span class="p">,</span> <span class="n">w_vclamp_amp</span><span class="p">,</span> <span class="n">w_input_mode</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Hide voltage clamp amplitude input when toggle is off</span>
                <span class="n">button_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_run</span><span class="p">,</span> <span class="n">w_single</span><span class="p">,</span> <span class="n">w_vclamp</span><span class="p">,</span> <span class="n">w_input_mode</span><span class="p">])</span>

            <span class="c1"># Construct the top row - include network dropdown if available</span>
            <span class="c1"># This creates a horizontal layout with network dropdown (if present) and connection dropdown</span>
            <span class="k">if</span> <span class="n">w_network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">connection_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_network</span><span class="p">,</span> <span class="n">w_connection</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">connection_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_connection</span><span class="p">])</span>
            <span class="n">slider_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_input_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="p">])</span>
            <span class="n">save_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">save_path_text</span><span class="p">,</span> <span class="n">save_button</span><span class="p">])</span>

            <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">connection_row</span><span class="p">,</span> <span class="n">button_row</span><span class="p">,</span> <span class="n">slider_row</span><span class="p">,</span> <span class="n">slider_columns</span><span class="p">,</span> <span class="n">save_row</span><span class="p">])</span>

        <span class="c1"># Function to update UI based on input mode</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">update_ui</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">clear_output</span><span class="p">()</span>
            <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># Update voltage clamp amplitude if voltage clamp is enabled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_vclamp_amp</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;general_settings&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_vclamp_amp</span><span class="o">.</span><span class="n">value</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">=</span> <span class="n">w_input_mode</span><span class="o">.</span><span class="n">value</span>
            <span class="n">syn_props</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">slider</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">slider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_syn_prop</span><span class="p">(</span><span class="o">**</span><span class="n">syn_props</span><span class="p">)</span>

            <span class="c1"># Clear previous results and run simulation</span>
            <span class="n">output_widget</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">output_widget</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_mode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_model</span><span class="p">(</span><span class="n">w_input_freq</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_model</span><span class="p">(</span><span class="n">w_input_freq</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_amplitude</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_model</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_ppr_induction_recovery</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>

        <span class="c1"># Function to switch between delay and duration sliders</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">switch_slider</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">w_input_mode</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>  <span class="c1"># Hide delay slider</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Show duration slider</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Show delay slider</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>  <span class="c1"># Hide duration slider</span>

        <span class="c1"># Function to handle voltage clamp toggle</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">on_vclamp_toggle</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle voltage clamp toggle changes to show/hide amplitude input&quot;&quot;&quot;</span>
            <span class="n">update_ui_layout</span><span class="p">()</span>
            <span class="n">clear_output</span><span class="p">()</span>
            <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>

        <span class="c1"># Link widgets to their callback functions</span>
        <span class="n">w_connection</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_connection_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="c1"># Link network dropdown callback only if network dropdown was created</span>
        <span class="k">if</span> <span class="n">w_network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w_network</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_network_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="n">w_input_mode</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">switch_slider</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="n">w_vclamp</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_vclamp_toggle</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

        <span class="c1"># Hide the duration slider initially until the user selects it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>  <span class="c1"># Hide duration slider</span>

        <span class="n">w_single</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">run_single_event</span><span class="p">)</span>
        <span class="n">w_run</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">update_ui</span><span class="p">)</span>

        <span class="c1"># Initial UI setup</span>
        <span class="n">slider_columns</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([])</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([])</span>
        <span class="n">update_ui_layout</span><span class="p">()</span>

        <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
        <span class="n">update_ui</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stp_frequency_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
        <span class="n">delay</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">log_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze synaptic response across different stimulation frequencies.</span>

<span class="sd">        This method systematically tests how the synapse model responds to different</span>
<span class="sd">        stimulation frequencies, calculating key short-term plasticity (STP) metrics</span>
<span class="sd">        for each frequency.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        freqs : list, optional</span>
<span class="sd">            List of frequencies to analyze (in Hz). Default covers a wide range from 1-200 Hz.</span>
<span class="sd">        delay : float, optional</span>
<span class="sd">            Delay between pulse trains in ms. Default is 250 ms.</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            Whether to plot the results. Default is True.</span>
<span class="sd">        log_plot : bool, optional</span>
<span class="sd">            Whether to use logarithmic scale for frequency axis. Default is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing frequency-dependent metrics with keys:</span>
<span class="sd">            - &#39;frequencies&#39;: List of tested frequencies</span>
<span class="sd">            - &#39;ppr&#39;: Paired-pulse ratios at each frequency</span>
<span class="sd">            - &#39;simple_ppr&#39;: Simple paired-pulse ratios (2nd/1st pulse) at each frequency</span>
<span class="sd">            - &#39;induction&#39;: Induction values at each frequency</span>
<span class="sd">            - &#39;recovery&#39;: Recovery values at each frequency</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method is particularly useful for characterizing the frequency-dependent</span>
<span class="sd">        behavior of synapses, such as identifying facilitating vs. depressing regimes</span>
<span class="sd">        or the frequency at which a synapse transitions between these behaviors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="n">freqs</span><span class="p">,</span>
            <span class="s2">&quot;ppr&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;induction&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;simple_ppr&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="c1"># Store original state</span>
        <span class="n">original_ispk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span>

        <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Analyzing frequencies&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_model</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_amplitude</span><span class="p">()</span>
            <span class="n">ppr</span><span class="p">,</span> <span class="n">induction</span><span class="p">,</span> <span class="n">recovery</span><span class="p">,</span> <span class="n">simple_ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_ppr_induction_recovery</span><span class="p">(</span>
                <span class="n">amp</span><span class="p">,</span> <span class="n">print_math</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ppr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ppr</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">induction</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">recovery</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;simple_ppr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">simple_ppr</span><span class="p">))</span>

        <span class="c1"># Restore original state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="n">original_ispk</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_frequency_analysis</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">log_plot</span><span class="o">=</span><span class="n">log_plot</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_frequency_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">log_plot</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the frequency-dependent synaptic properties.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        results : dict</span>
<span class="sd">            Dictionary containing frequency analysis results with keys:</span>
<span class="sd">            - &#39;frequencies&#39;: List of tested frequencies</span>
<span class="sd">            - &#39;ppr&#39;: Paired-pulse ratios at each frequency</span>
<span class="sd">            - &#39;simple_ppr&#39;: Simple paired-pulse ratios at each frequency</span>
<span class="sd">            - &#39;induction&#39;: Induction values at each frequency</span>
<span class="sd">            - &#39;recovery&#39;: Recovery values at each frequency</span>
<span class="sd">        log_plot : bool</span>
<span class="sd">            Whether to use logarithmic scale for frequency axis</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        Creates a figure with three subplots showing:</span>
<span class="sd">        1. Paired-pulse ratios (both normalized and simple) vs. frequency</span>
<span class="sd">        2. Induction vs. frequency</span>
<span class="sd">        3. Recovery vs. frequency</span>

<span class="sd">        Each plot includes a horizontal reference line at y=0 or y=1 to indicate</span>
<span class="sd">        the boundary between facilitation and depression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># Plot both PPR measures</span>
        <span class="k">if</span> <span class="n">log_plot</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ppr&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Normalized PPR&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;simple_ppr&quot;</span><span class="p">],</span> <span class="s2">&quot;s-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Simple PPR&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ppr&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Normalized PPR&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;simple_ppr&quot;</span><span class="p">],</span> <span class="s2">&quot;s-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Simple PPR&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Paired Pulse Ratio&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PPR vs Frequency&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Plot Induction</span>
        <span class="k">if</span> <span class="n">log_plot</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Induction&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Induction vs Frequency&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Plot Recovery</span>
        <span class="k">if</span> <span class="n">log_plot</span><span class="p">:</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Recovery&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Recovery vs Frequency&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_synaptic_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stp_frequency</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">stp_delay</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a comprehensive table of synaptic parameters for all connections.</span>

<span class="sd">        This method iterates through all available connections, runs simulations to</span>
<span class="sd">        characterize each synapse, and compiles the results into a pandas DataFrame.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        stp_frequency : float, optional</span>
<span class="sd">            Frequency in Hz to use for STP (short-term plasticity) analysis. Default is 50.0 Hz.</span>
<span class="sd">        stp_delay : float, optional</span>
<span class="sd">            Delay in ms between pulse trains for STP analysis. Default is 250.0 ms.</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            Whether to display the resulting table. Default is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame containing synaptic parameters for each connection with columns:</span>
<span class="sd">            - connection: Connection name</span>
<span class="sd">            - rise_time: 20-80% rise time (ms)</span>
<span class="sd">            - decay_time: Decay time constant (ms)</span>
<span class="sd">            - latency: Response latency (ms)</span>
<span class="sd">            - half_width: Response half-width (ms)</span>
<span class="sd">            - peak_amplitude: Peak synaptic current amplitude (pA)</span>
<span class="sd">            - baseline: Baseline current (pA)</span>
<span class="sd">            - ppr: Paired-pulse ratio (normalized)</span>
<span class="sd">            - simple_ppr: Simple paired-pulse ratio (2nd/1st pulse)</span>
<span class="sd">            - induction: STP induction measure</span>
<span class="sd">            - recovery: STP recovery measure</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method temporarily switches between connections to characterize each one,</span>
<span class="sd">        then restores the original connection. The STP metrics are calculated at the</span>
<span class="sd">        specified frequency and delay.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store original connection to restore later</span>
        <span class="n">original_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span>

        <span class="c1"># Initialize results list</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">)</span><span class="si">}</span><span class="s2"> connections...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">conn_name</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Analyzing connections&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Switch to this connection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">conn_name</span><span class="p">)</span>

                <span class="c1"># Run single event analysis</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SingleEvent</span><span class="p">(</span><span class="n">plot_and_print</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Get synaptic properties from the single event</span>
                <span class="n">syn_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_syn_prop</span><span class="p">()</span>

                <span class="c1"># Run STP analysis at specified frequency</span>
                <span class="n">stp_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stp_frequency_response</span><span class="p">(</span>
                    <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">stp_frequency</span><span class="p">],</span> <span class="n">delay</span><span class="o">=</span><span class="n">stp_delay</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_plot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="c1"># Extract STP metrics for this frequency</span>
                <span class="n">freq_idx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Only one frequency tested</span>
                <span class="n">ppr</span> <span class="o">=</span> <span class="n">stp_results</span><span class="p">[</span><span class="s2">&quot;ppr&quot;</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>
                <span class="n">induction</span> <span class="o">=</span> <span class="n">stp_results</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>
                <span class="n">recovery</span> <span class="o">=</span> <span class="n">stp_results</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>
                <span class="n">simple_ppr</span> <span class="o">=</span> <span class="n">stp_results</span><span class="p">[</span><span class="s2">&quot;simple_ppr&quot;</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>

                <span class="c1"># Compile results for this connection</span>
                <span class="n">conn_results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;connection&quot;</span><span class="p">:</span> <span class="n">conn_name</span><span class="p">,</span>
                    <span class="s2">&quot;rise_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rise_time</span><span class="p">),</span>
                    <span class="s2">&quot;decay_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span><span class="p">),</span>
                    <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latency&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;half_width&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;half_width&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;peak_amplitude&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ppr</span><span class="p">),</span>
                    <span class="s2">&quot;simple_ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">simple_ppr</span><span class="p">),</span>
                    <span class="s2">&quot;induction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">induction</span><span class="p">),</span>
                    <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">recovery</span><span class="p">),</span>
                <span class="p">}</span>

                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn_results</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to analyze connection &#39;</span><span class="si">{</span><span class="n">conn_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Add partial results if possible</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;connection&quot;</span><span class="p">:</span> <span class="n">conn_name</span><span class="p">,</span>
                        <span class="s2">&quot;rise_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;decay_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;half_width&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;peak_amplitude&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;simple_ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;induction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="c1"># Restore original connection</span>
        <span class="k">if</span> <span class="n">original_connection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">original_connection</span><span class="p">)</span>

        <span class="c1"># Create DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># Set connection as index for better display</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="c1"># Display the table</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Synaptic Parameters Table:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

            <span class="c1"># Optional: Create a simple bar plot for key metrics</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Synaptic Parameters Across Connections (STP at </span><span class="si">{</span><span class="n">stp_frequency</span><span class="si">}</span><span class="s2">Hz)&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Plot rise/decay times</span>
                <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;rise_time&quot;</span><span class="p">,</span> <span class="s2">&quot;decay_time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rise and Decay Times&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time (ms)&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

                <span class="c1"># Plot PPR metrics</span>
                <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;ppr&quot;</span><span class="p">,</span> <span class="s2">&quot;simple_ppr&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Paired-Pulse Ratios&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

                <span class="c1"># Plot induction</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;STP Induction&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Induction&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

                <span class="c1"># Plot recovery</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;STP Recovery&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Recovery&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not create plots: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">conn_type_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">current_name</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">mechanisms_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">templates_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">general_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_folder_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">other_vars_to_record</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slider_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hoc_cell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the SynapseTuner class with connection type settings, mechanisms, and template directories.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>mechanisms_dir : Optional[str]
    Directory path containing the compiled mod files needed for NEURON mechanisms.
templates_dir : Optional[str]
    Directory path containing cell template files (.hoc or .py) loaded into NEURON.
conn_type_settings : Optional[dict]
    A dictionary containing connection-specific settings, such as synaptic properties and details.
connection : Optional[str]
    Name of the connection type to be used from the conn_type_settings dictionary.
general_settings : Optional[dict]
    General settings dictionary including parameters like simulation time step, duration, and temperature.
json_folder_path : Optional[str]
    Path to folder containing JSON files with additional synaptic properties to update settings.
current_name : str, optional
    Name of the synaptic current variable to be recorded (default is 'i').
other_vars_to_record : Optional[list]
    List of additional synaptic variables to record during the simulation (e.g., 'Pr', 'Use').
slider_vars : Optional[list]
    List of synaptic variables you would like sliders set up for the STP sliders method by default will use all parameters in spec_syn_param.
hoc_cell : Optional[object]
    An already loaded NEURON cell object. If provided, template loading and cell setup will be skipped.
network : Optional[str]
    Name of the specific network dataset to access from the loaded edges data (e.g., 'network_to_network').
    If not provided, will use all available networks. When a config file is provided, this enables
    the network dropdown feature in InteractiveTuner for switching between different networks.</p>
</details>

<details class="network-dropdown-feature:" open>
  <summary>Network Dropdown Feature:</summary>
  <p>When initialized with a BMTK config file, the tuner automatically:
1. Loads all available network datasets from the config
2. Creates a network dropdown in InteractiveTuner (if multiple networks exist)
3. Allows dynamic switching between networks, which rebuilds connection types
4. Updates connection dropdown options when network is changed
5. Preserves current connection if it exists in the new network, otherwise selects the first available</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">conn_type_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">current_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
    <span class="n">mechanisms_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">templates_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">general_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">json_folder_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">other_vars_to_record</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">slider_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hoc_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">network</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the SynapseTuner class with connection type settings, mechanisms, and template directories.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    mechanisms_dir : Optional[str]</span>
<span class="sd">        Directory path containing the compiled mod files needed for NEURON mechanisms.</span>
<span class="sd">    templates_dir : Optional[str]</span>
<span class="sd">        Directory path containing cell template files (.hoc or .py) loaded into NEURON.</span>
<span class="sd">    conn_type_settings : Optional[dict]</span>
<span class="sd">        A dictionary containing connection-specific settings, such as synaptic properties and details.</span>
<span class="sd">    connection : Optional[str]</span>
<span class="sd">        Name of the connection type to be used from the conn_type_settings dictionary.</span>
<span class="sd">    general_settings : Optional[dict]</span>
<span class="sd">        General settings dictionary including parameters like simulation time step, duration, and temperature.</span>
<span class="sd">    json_folder_path : Optional[str]</span>
<span class="sd">        Path to folder containing JSON files with additional synaptic properties to update settings.</span>
<span class="sd">    current_name : str, optional</span>
<span class="sd">        Name of the synaptic current variable to be recorded (default is &#39;i&#39;).</span>
<span class="sd">    other_vars_to_record : Optional[list]</span>
<span class="sd">        List of additional synaptic variables to record during the simulation (e.g., &#39;Pr&#39;, &#39;Use&#39;).</span>
<span class="sd">    slider_vars : Optional[list]</span>
<span class="sd">        List of synaptic variables you would like sliders set up for the STP sliders method by default will use all parameters in spec_syn_param.</span>
<span class="sd">    hoc_cell : Optional[object]</span>
<span class="sd">        An already loaded NEURON cell object. If provided, template loading and cell setup will be skipped.</span>
<span class="sd">    network : Optional[str]</span>
<span class="sd">        Name of the specific network dataset to access from the loaded edges data (e.g., &#39;network_to_network&#39;).</span>
<span class="sd">        If not provided, will use all available networks. When a config file is provided, this enables</span>
<span class="sd">        the network dropdown feature in InteractiveTuner for switching between different networks.</span>

<span class="sd">    Network Dropdown Feature:</span>
<span class="sd">    -------------------------</span>
<span class="sd">    When initialized with a BMTK config file, the tuner automatically:</span>
<span class="sd">    1. Loads all available network datasets from the config</span>
<span class="sd">    2. Creates a network dropdown in InteractiveTuner (if multiple networks exist)</span>
<span class="sd">    3. Allows dynamic switching between networks, which rebuilds connection types</span>
<span class="sd">    4. Updates connection dropdown options when network is changed</span>
<span class="sd">    5. Preserves current connection if it exists in the new network, otherwise selects the first available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="o">=</span> <span class="n">hoc_cell</span>
    <span class="c1"># Store config and network information for network dropdown functionality</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>  <span class="c1"># Store config path for network dropdown functionality</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store available networks from config file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span> <span class="o">=</span> <span class="n">network</span>  <span class="c1"># Store current network selection</span>
    <span class="c1"># Cache for loaded dynamics params JSON by filename to avoid repeated disk reads</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_syn_params_cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">h</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s2">&quot;stdrun.hoc&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mechanisms_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">templates_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Either a config file, both mechanisms_dir and templates_dir, or a hoc_cell must be provided.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">neuron</span><span class="o">.</span><span class="n">load_mechanisms</span><span class="p">(</span><span class="n">mechanisms_dir</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">templates_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># loads both mech and templates</span>
            <span class="n">load_templates_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="c1"># Load available networks from config for network dropdown feature</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_available_networks</span><span class="p">()</span>
            <span class="c1"># Prebuild connection type settings for each available network to</span>
            <span class="c1"># make network switching in the UI fast. This will make __init__ slower</span>
            <span class="c1"># but dramatically speed up response when changing the network dropdown.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prebuilt_conn_type_settings</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_prebuilt_conn_type_settings</span><span class="p">[</span><span class="n">net</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_build_conn_type_settings_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">net</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: error prebuilding conn_type_settings for networks: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">conn_type_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building conn_type_settings from BMTK config files...&quot;</span><span class="p">)</span>
            <span class="c1"># If we prebuilt per-network settings, use the one for the requested network</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prebuilt_conn_type_settings&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">network</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_prebuilt_conn_type_settings&quot;</span><span class="p">,</span> <span class="p">{}</span>
            <span class="p">):</span>
                <span class="n">conn_type_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prebuilt_conn_type_settings</span><span class="p">[</span><span class="n">network</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conn_type_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_conn_type_settings_from_config</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">,</span> <span class="n">network</span><span class="o">=</span><span class="n">network</span>
                <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conn_type_settings</span><span class="p">)</span><span class="si">}</span><span class="s2"> connection types: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># If connection is not specified, use the first available connection</span>
            <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">conn_type_settings</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No connection specified, using first available: </span><span class="si">{</span><span class="n">connection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;conn_type_settings must be provided if config is not specified.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;connection must be provided or inferable from conn_type_settings.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conn_type_settings</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connection &#39;</span><span class="si">{</span><span class="n">connection</span><span class="si">}</span><span class="s2">&#39; not found in conn_type_settings.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">conn_type_settings</span>
    <span class="k">if</span> <span class="n">json_folder_path</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;updating settings from json path </span><span class="si">{</span><span class="n">json_folder_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_spec_syn_param</span><span class="p">(</span><span class="n">json_folder_path</span><span class="p">)</span>
    <span class="c1"># Use default general settings if not provided</span>
    <span class="k">if</span> <span class="n">general_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">DEFAULT_GENERAL_SETTINGS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Merge defaults with user-provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">DEFAULT_GENERAL_SETTINGS</span><span class="p">,</span> <span class="o">**</span><span class="n">general_settings</span><span class="p">}</span>

    <span class="c1"># Store the initial connection name and set up connection</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span> <span class="o">=</span> <span class="n">connection</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_cell_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;post_cell&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;vclamp&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_name</span> <span class="o">=</span> <span class="n">current_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">other_vars_to_record</span> <span class="o">=</span> <span class="n">other_vars_to_record</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Add input_mode attribute</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Store reference to last generated figure</span>

    <span class="c1"># Store original slider_vars for connection switching</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">original_slider_vars</span> <span class="o">=</span> <span class="n">slider_vars</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">slider_vars</span><span class="p">:</span>
        <span class="c1"># Start by filtering based on keys in slider_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">slider_vars</span>
        <span class="p">}</span>
        <span class="c1"># Iterate over slider_vars and check for missing keys in self.synaptic_props</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">slider_vars</span><span class="p">:</span>
            <span class="c1"># If the key is missing from synaptic_props, get the value using getattr</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_cell</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_synapse</span><span class="p">()</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in syn </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synaptic_props</span>

    <span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
    <span class="n">h</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>  <span class="c1"># Time step (resolution) of the simulation in ms</span>
    <span class="n">h</span><span class="o">.</span><span class="n">steps_per_ms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">h</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">h</span><span class="o">.</span><span class="n">celsius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;celsius&quot;</span><span class="p">]</span>

    <span class="c1"># get some stuff set up we need for both SingleEvent and Interactive Tuner</span>
    <span class="c1"># Only set up cell if hoc_cell was not provided</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_cell</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_synapse</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetStim</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetStim</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">VClamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetCon</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;delay&quot;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nc2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">NetCon</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;delay&quot;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_recorders</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner._update_spec_syn_param" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_update_spec_syn_param</span><span class="p">(</span><span class="n">json_folder_path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Update specific synaptic parameters using JSON files located in the specified folder.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>json_folder_path : str
    Path to folder containing JSON files, where each JSON file corresponds to a connection type.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_update_spec_syn_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_folder_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update specific synaptic parameters using JSON files located in the specified folder.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    json_folder_path : str</span>
<span class="sd">        Path to folder containing JSON files, where each JSON file corresponds to a connection type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">conn_type</span><span class="p">,</span> <span class="n">settings</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">json_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json_folder_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">conn_type</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
                <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON file for </span><span class="si">{</span><span class="n">conn_type</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner._set_up_cell" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_set_up_cell</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set up the neuron cell based on the specified connection settings.
This method is only called when hoc_cell is not provided.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_set_up_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the neuron cell based on the specified connection settings.</span>
<span class="sd">    This method is only called when hoc_cell is not provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;post_cell&quot;</span><span class="p">])()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner._set_up_synapse" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_set_up_synapse</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set up the synapse on the target cell according to the synaptic parameters in <code>conn_type_settings</code>.</p>


<details class="notes:" open>
  <summary>Notes:</summary>
  <ul>
<li><code>_set_up_cell()</code> should be called before setting up the synapse.</li>
<li>Synapse location, type, and properties are specified within <code>spec_syn_param</code> and <code>spec_settings</code>.</li>
</ul>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_set_up_synapse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the synapse on the target cell according to the synaptic parameters in `conn_type_settings`.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - `_set_up_cell()` should be called before setting up the synapse.</span>
<span class="sd">    - Synapse location, type, and properties are specified within `spec_syn_param` and `spec_settings`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;level_of_detail&quot;</span><span class="p">])(</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]](</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;sec_x&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Make sure the mod file exist you are trying to load check spelling!&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> cannot be assigned as it does not exist in the synapse. Check your mod file or spec_syn_param.&quot;</span>
                <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner._set_up_recorders" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_set_up_recorders</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set up recording vectors to capture simulation data.</p>
<p>The method sets up recorders for:
- Synaptic current specified by <code>current_name</code>
- Other specified synaptic variables (<code>other_vars_to_record</code>)
- Time, soma voltage, and voltage clamp current for all simulations.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_set_up_recorders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up recording vectors to capture simulation data.</span>

<span class="sd">    The method sets up recorders for:</span>
<span class="sd">    - Synaptic current specified by `current_name`</span>
<span class="sd">    - Other specified synaptic variables (`other_vars_to_record`)</span>
<span class="sd">    - Time, soma voltage, and voltage clamp current for all simulations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_vars_to_record</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
        <span class="n">ref_attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_ref_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">ref_attr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">ref_attr</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">ref_attr</span><span class="si">}</span><span class="s2"> not found in the syn object. Use vars() to inspect available attributes.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Record synaptic current</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
    <span class="n">ref_attr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_ref_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">ref_attr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">]</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">ref_attr</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Synaptic current recorder not set up correctly.&quot;</span><span class="p">)</span>

    <span class="c1"># Record time, synaptic events, soma voltage, and voltage clamp current</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tspk</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">soma_v</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ivcl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">_ref_t</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspk</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nc2</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspk</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">soma_v</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ivcl</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">_ref_i</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner.SingleEvent" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">SingleEvent</span><span class="p">(</span><span class="n">plot_and_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Simulate a single synaptic event by delivering an input stimulus to the synapse.</p>
<p>The method sets up the neuron cell, synapse, stimulus, and voltage clamp,
and then runs the NEURON simulation for a single event. The single synaptic event will occur at general_settings['tstart']
Will display graphs and synaptic properies works best with a jupyter notebook</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">SingleEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_and_print</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulate a single synaptic event by delivering an input stimulus to the synapse.</span>

<span class="sd">    The method sets up the neuron cell, synapse, stimulus, and voltage clamp,</span>
<span class="sd">    and then runs the NEURON simulation for a single event. The single synaptic event will occur at general_settings[&#39;tstart&#39;]</span>
<span class="sd">    Will display graphs and synaptic properies works best with a jupyter notebook</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># user slider values if the sliders are set up</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dynamic_sliders&quot;</span><span class="p">):</span>
        <span class="n">syn_props</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">slider</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">slider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_syn_prop</span><span class="p">(</span><span class="o">**</span><span class="n">syn_props</span><span class="p">)</span>

    <span class="c1"># sets values based off optimizer</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;using_optimizer&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># Set up the stimulus</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">tstop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Set up voltage clamp</span>
    <span class="n">vcldur</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span> <span class="n">h</span><span class="o">.</span><span class="n">tstop</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">dur</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcldur</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># Run simulation</span>
    <span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">tstop</span>
    <span class="n">h</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">])</span>
    <span class="n">syn_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_syn_prop</span><span class="p">(</span>
        <span class="n">rise_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;rise_interval&quot;</span><span class="p">],</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span>
    <span class="p">)</span>
    <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span> <span class="o">-</span> <span class="n">syn_props</span><span class="p">[</span><span class="s2">&quot;baseline&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># Convert to pA</span>
    <span class="n">current_integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>  <span class="c1"># pAms</span>

    <span class="k">if</span> <span class="n">plot_and_print</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_model</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Integral in pA*ms: </span><span class="si">{</span><span class="n">current_integral</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">rise_time</span> <span class="o">=</span> <span class="n">syn_props</span><span class="p">[</span><span class="s2">&quot;rise_time&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span> <span class="o">=</span> <span class="n">syn_props</span><span class="p">[</span><span class="s2">&quot;decay_time&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner._get_syn_prop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_syn_prop</span><span class="p">(</span><span class="n">rise_interval</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate synaptic properties such as peak amplitude, latency, rise time, decay time, and half-width.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>rise_interval : tuple of floats, optional
    Fractional rise time interval to calculate (default is (0.2, 0.8)).
dt : float, optional
    Time step of the simulation (default is NEURON's <code>h.dt</code>).
short : bool, optional
    If True, only return baseline and sign without calculating full properties.</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>dict
    A dictionary containing the synaptic properties: baseline, sign, peak amplitude, latency, rise time,
    decay time, and half-width.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_syn_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rise_interval</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate synaptic properties such as peak amplitude, latency, rise time, decay time, and half-width.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    rise_interval : tuple of floats, optional</span>
<span class="sd">        Fractional rise time interval to calculate (default is (0.2, 0.8)).</span>
<span class="sd">    dt : float, optional</span>
<span class="sd">        Time step of the simulation (default is NEURON&#39;s `h.dt`).</span>
<span class="sd">    short : bool, optional</span>
<span class="sd">        If True, only return baseline and sign without calculating full properties.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing the synaptic properties: baseline, sign, peak amplitude, latency, rise time,</span>
<span class="sd">        decay time, and half-width.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span><span class="p">:</span>
        <span class="n">isyn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivcl</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">isyn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rec_vectors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_name</span><span class="p">]</span>
    <span class="n">isyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">isyn</span><span class="p">)</span>
    <span class="n">tspk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tspk</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tspk</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">tspk</span> <span class="o">=</span> <span class="n">tspk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">ispk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">tspk</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span>
    <span class="n">baseline</span> <span class="o">=</span> <span class="n">isyn</span><span class="p">[</span><span class="n">ispk</span><span class="p">]</span>
    <span class="n">isyn</span> <span class="o">=</span> <span class="n">isyn</span><span class="p">[</span><span class="n">ispk</span><span class="p">:]</span> <span class="o">-</span> <span class="n">baseline</span>
    <span class="c1"># print(np.abs(isyn))</span>
    <span class="c1"># print(np.argmax(np.abs(isyn)))</span>
    <span class="c1"># print(isyn[np.argmax(np.abs(isyn))])</span>
    <span class="c1"># print(np.sign(isyn[np.argmax(np.abs(isyn))]))</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">isyn</span><span class="p">))])</span>
    <span class="k">if</span> <span class="n">short</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="n">baseline</span><span class="p">,</span> <span class="s2">&quot;sign&quot;</span><span class="p">:</span> <span class="n">sign</span><span class="p">}</span>
    <span class="n">isyn</span> <span class="o">*=</span> <span class="n">sign</span>
    <span class="c1"># print(isyn)</span>
    <span class="c1"># peak amplitude</span>
    <span class="n">ipk</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">isyn</span><span class="p">)</span>
    <span class="n">ipk</span> <span class="o">=</span> <span class="n">ipk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">isyn</span><span class="p">[</span><span class="n">ipk</span><span class="p">]</span>
    <span class="c1"># latency</span>
    <span class="n">istart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">isyn</span><span class="p">[:</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">latency</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">istart</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># rise time</span>
    <span class="n">rt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">istart</span> <span class="p">:</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rise_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">peak</span><span class="p">)</span>
    <span class="n">rt2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">istart</span> <span class="p">:</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rise_interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">peak</span><span class="p">)</span>
    <span class="n">rise_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">rt2</span> <span class="o">-</span> <span class="n">rt1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="c1"># decay time</span>
    <span class="n">iend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">ipk</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">iend</span> <span class="o">=</span> <span class="n">isyn</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">iend</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">iend</span> <span class="o">+</span> <span class="n">ipk</span>
    <span class="n">decay_len</span> <span class="o">=</span> <span class="n">iend</span> <span class="o">-</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t</span> <span class="o">/</span> <span class="n">tau</span><span class="p">),</span>
        <span class="n">dt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">decay_len</span><span class="p">),</span>
        <span class="n">isyn</span><span class="p">[</span><span class="n">ipk</span> <span class="p">:</span> <span class="n">iend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">p0</span><span class="o">=</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">decay_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">decay_time</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># half-width</span>
    <span class="n">hw1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">istart</span> <span class="p">:</span> <span class="n">ipk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">peak</span><span class="p">)</span>
    <span class="n">hw2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_first</span><span class="p">(</span><span class="n">isyn</span><span class="p">[</span><span class="n">ipk</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">peak</span><span class="p">)</span>
    <span class="n">hw2</span> <span class="o">=</span> <span class="n">isyn</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="n">hw2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">hw2</span> <span class="o">+</span> <span class="n">ipk</span>
    <span class="n">half_width</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">hw2</span> <span class="o">-</span> <span class="n">hw1</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="n">baseline</span><span class="p">,</span>
        <span class="s2">&quot;sign&quot;</span><span class="p">:</span> <span class="n">sign</span><span class="p">,</span>
        <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="n">latency</span><span class="p">,</span>
        <span class="s2">&quot;amp&quot;</span><span class="p">:</span> <span class="n">peak</span><span class="p">,</span>
        <span class="s2">&quot;rise_time&quot;</span><span class="p">:</span> <span class="n">rise_time</span><span class="p">,</span>
        <span class="s2">&quot;decay_time&quot;</span><span class="p">:</span> <span class="n">decay_time</span><span class="p">,</span>
        <span class="s2">&quot;half_width&quot;</span><span class="p">:</span> <span class="n">half_width</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner._set_syn_prop" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_set_syn_prop</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Sets the synaptic parameters based on user inputs from sliders.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>**kwargs : dict
    Synaptic properties (such as weight, Use, tau_f, tau_d) as keyword arguments.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_set_syn_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the synaptic parameters based on user inputs from sliders.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Synaptic properties (such as weight, Use, tau_f, tau_d) as keyword arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner._simulate_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_simulate_model</span><span class="p">(</span><span class="n">input_frequency</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">vclamp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Runs the simulation with the specified input frequency, delay, and voltage clamp settings.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>input_frequency : float
    Frequency of the input drive train in Hz.
delay : float
    Delay period in milliseconds between the 8th and 9th pulses.
vclamp : bool or None, optional
    Whether to use voltage clamp. If None, the current setting is used. Default is None.</p>
</details>

<details class="notes:" open>
  <summary>Notes:</summary>
  <p>This method handles two different input modes:
- Standard train mode with 8 initial pulses followed by a delay and 4 additional pulses
- Continuous input mode where stimulation continues for a specified duration</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_simulate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_frequency</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">vclamp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the simulation with the specified input frequency, delay, and voltage clamp settings.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    input_frequency : float</span>
<span class="sd">        Frequency of the input drive train in Hz.</span>
<span class="sd">    delay : float</span>
<span class="sd">        Delay period in milliseconds between the 8th and 9th pulses.</span>
<span class="sd">    vclamp : bool or None, optional</span>
<span class="sd">        Whether to use voltage clamp. If None, the current setting is used. Default is None.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    This method handles two different input modes:</span>
<span class="sd">    - Standard train mode with 8 initial pulses followed by a delay and 4 additional pulses</span>
<span class="sd">    - Continuous input mode where stimulation continues for a specified duration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_mode</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_drive_train</span><span class="p">(</span><span class="n">input_frequency</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span>

        <span class="n">vcldur</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vcl</span><span class="o">.</span><span class="n">dur</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcldur</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">(</span><span class="mi">70</span> <span class="o">*</span> <span class="n">mV</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">continuerun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">*</span> <span class="n">ms</span><span class="p">)</span>
        <span class="c1"># h.run()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Continuous input mode: ensure simulation runs long enough for the full stimulation duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">300</span>
        <span class="p">)</span>  <span class="c1"># 300ms buffer time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">input_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">input_frequency</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nstim2</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">(</span><span class="mi">70</span> <span class="o">*</span> <span class="n">mV</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">continuerun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">*</span> <span class="n">ms</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner.InteractiveTuner" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">InteractiveTuner</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Sets up interactive sliders for tuning short-term plasticity (STP) parameters in a Jupyter Notebook.</p>
<p>This method creates an interactive UI with sliders for:
- Network selection dropdown (if multiple networks available and config provided)
- Connection type selection dropdown
- Input frequency
- Delay between pulse trains
- Duration of stimulation (for continuous input mode)
- Synaptic parameters (e.g., Use, tau_f, tau_d) based on the syn model</p>
<p>It also provides buttons for:
- Running a single event simulation
- Running a train input simulation
- Toggling voltage clamp mode
- Switching between standard and continuous input modes</p>


<details class="network-dropdown-feature:" open>
  <summary>Network Dropdown Feature:</summary>
  <p>When the SynapseTuner is initialized with a BMTK config file containing multiple networks:
- A network dropdown appears next to the connection dropdown
- Users can dynamically switch between networks (e.g., 'network_to_network', 'external_to_network')
- Switching networks rebuilds available connections and updates the connection dropdown
- The current connection is preserved if it exists in the new network
- If multiple networks exist but only one is specified during init, that network is used as default</p>
</details>

<details class="notes:" open>
  <summary>Notes:</summary>
  <p>Ideal for exploratory parameter tuning and interactive visualization of
synapse behavior with different parameter values and stimulation protocols.
The network dropdown feature enables comprehensive exploration of multi-network
BMTK simulations without needing to reinitialize the tuner.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">InteractiveTuner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up interactive sliders for tuning short-term plasticity (STP) parameters in a Jupyter Notebook.</span>

<span class="sd">    This method creates an interactive UI with sliders for:</span>
<span class="sd">    - Network selection dropdown (if multiple networks available and config provided)</span>
<span class="sd">    - Connection type selection dropdown</span>
<span class="sd">    - Input frequency</span>
<span class="sd">    - Delay between pulse trains</span>
<span class="sd">    - Duration of stimulation (for continuous input mode)</span>
<span class="sd">    - Synaptic parameters (e.g., Use, tau_f, tau_d) based on the syn model</span>

<span class="sd">    It also provides buttons for:</span>
<span class="sd">    - Running a single event simulation</span>
<span class="sd">    - Running a train input simulation</span>
<span class="sd">    - Toggling voltage clamp mode</span>
<span class="sd">    - Switching between standard and continuous input modes</span>

<span class="sd">    Network Dropdown Feature:</span>
<span class="sd">    ------------------------</span>
<span class="sd">    When the SynapseTuner is initialized with a BMTK config file containing multiple networks:</span>
<span class="sd">    - A network dropdown appears next to the connection dropdown</span>
<span class="sd">    - Users can dynamically switch between networks (e.g., &#39;network_to_network&#39;, &#39;external_to_network&#39;)</span>
<span class="sd">    - Switching networks rebuilds available connections and updates the connection dropdown</span>
<span class="sd">    - The current connection is preserved if it exists in the new network</span>
<span class="sd">    - If multiple networks exist but only one is specified during init, that network is used as default</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    Ideal for exploratory parameter tuning and interactive visualization of</span>
<span class="sd">    synapse behavior with different parameter values and stimulation protocols.</span>
<span class="sd">    The network dropdown feature enables comprehensive exploration of multi-network</span>
<span class="sd">    BMTK simulations without needing to reinitialize the tuner.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Widgets setup (Sliders)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
    <span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="mi">125</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">]</span>
    <span class="n">durations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
    <span class="n">freq0</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">delay0</span> <span class="o">=</span> <span class="mi">250</span>
    <span class="n">duration0</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">vlamp_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span>

    <span class="c1"># Connection dropdown</span>
    <span class="n">connection_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">w_connection</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
        <span class="n">options</span><span class="o">=</span><span class="n">connection_options</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Connection:&quot;</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Network dropdown - only shown if config was provided and multiple networks are available</span>
    <span class="c1"># This enables users to switch between different network datasets dynamically</span>
    <span class="n">w_network</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">w_network</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
            <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_network</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Network:&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="n">w_run</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run Train&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;history&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;primary&quot;</span><span class="p">)</span>
    <span class="n">w_single</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Single Event&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;check&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
    <span class="n">w_vclamp</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">vlamp_status</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Voltage Clamp&quot;</span><span class="p">,</span>
        <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;fast-backward&quot;</span><span class="p">,</span>
        <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Voltage clamp amplitude input</span>
    <span class="n">default_vclamp_amp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">],</span> <span class="s2">&quot;vclamp_amp&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.0</span><span class="p">)</span>
    <span class="n">w_vclamp_amp</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_vclamp_amp</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;V_clamp (mV):&quot;</span><span class="p">,</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;150px&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">w_input_mode</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Continuous input&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;eject&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;info&quot;</span>
    <span class="p">)</span>
    <span class="n">w_input_freq</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">SelectionSlider</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">freq0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Input Freq&quot;</span><span class="p">)</span>

    <span class="c1"># Sliders for delay and duration</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">SelectionSlider</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">delays</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">delay0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Delay&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">SelectionSlider</span><span class="p">(</span>
        <span class="n">options</span><span class="o">=</span><span class="n">durations</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">duration0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Duration&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Save functionality widgets</span>
    <span class="n">save_path_text</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="s2">&quot;plot.png&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Save path:&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s2">&quot;300px&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">save_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Save Plot&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;save&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_plot</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;last_figure&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create a new figure with just the first subplot (synaptic current)</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

                <span class="c1"># Get the axes from the original figure</span>
                <span class="n">original_axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_axes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">first_ax</span> <span class="o">=</span> <span class="n">original_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Copy the data from the first subplot</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">first_ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">():</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">(),</span>
                            <span class="n">line</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">get_label</span><span class="p">(),</span>
                        <span class="p">)</span>

                    <span class="c1"># Copy axis labels and title</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">first_ax</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">first_ax</span><span class="o">.</span><span class="n">get_ylabel</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">first_ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">first_ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># Save the new figure</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path_text</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>  <span class="c1"># Close the temporary figure</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synaptic current plot saved to </span><span class="si">{</span><span class="n">save_path_text</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No subplots found in the figure&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No plot to save&quot;</span><span class="p">)</span>

    <span class="n">save_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">save_plot</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_dynamic_sliders</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create sliders based on current connection&#39;s parameters&quot;&quot;&quot;</span>
        <span class="n">sliders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slider_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>  <span class="c1"># Only create sliders for numeric values</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> was set to zero, going to try to set a range of values, try settings the </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> to a nonzero value if you dont like the range!&quot;</span>
                        <span class="p">)</span>
                        <span class="n">slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">key</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">value</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">value</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">key</span>
                        <span class="p">)</span>
                    <span class="n">sliders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">slider</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skipping slider for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> due to not being a synaptic variable&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sliders</span>

    <span class="c1"># Generate sliders dynamically based on valid numeric entries in self.slider_vars</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span> <span class="o">=</span> <span class="n">create_dynamic_sliders</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;Setting up slider! The sliders ranges are set by their init value so try changing that if you dont like the slider range!&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create output widget for displaying results</span>
    <span class="n">output_widget</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_single_event</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">()</span>
        <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Update voltage clamp amplitude if voltage clamp is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span><span class="p">:</span>
            <span class="c1"># Update the voltage clamp amplitude settings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_vclamp_amp</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># Update general settings if they exist</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;general_settings&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_vclamp_amp</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Update synaptic properties based on slider values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Clear previous results and run simulation</span>
        <span class="n">output_widget</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">output_widget</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SingleEvent</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_connection_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle connection dropdown change&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_connection</span> <span class="o">=</span> <span class="n">w_connection</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">new_connection</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">:</span>
                <span class="c1"># Switch to new connection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">new_connection</span><span class="p">)</span>

                <span class="c1"># Recreate dynamic sliders for new connection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span> <span class="o">=</span> <span class="n">create_dynamic_sliders</span><span class="p">()</span>

                <span class="c1"># Update UI</span>
                <span class="n">update_ui_layout</span><span class="p">()</span>
                <span class="n">update_ui</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error switching connection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_network_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle network dropdown change events.</span>

<span class="sd">        This callback is triggered when the user selects a different network from</span>
<span class="sd">        the network dropdown. It coordinates the complete switching process:</span>
<span class="sd">        1. Calls _switch_network() to rebuild connections for the new network</span>
<span class="sd">        2. Updates the connection dropdown options with new network&#39;s connections</span>
<span class="sd">        3. Recreates dynamic sliders for new connection parameters</span>
<span class="sd">        4. Refreshes the entire UI to reflect all changes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">w_network</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_network</span> <span class="o">=</span> <span class="n">w_network</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">new_network</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span><span class="p">:</span>
                <span class="c1"># Switch to new network</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_switch_network</span><span class="p">(</span><span class="n">new_network</span><span class="p">)</span>

                <span class="c1"># Update connection dropdown options with new network&#39;s connections</span>
                <span class="n">connection_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">w_connection</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">connection_options</span>
                <span class="k">if</span> <span class="n">connection_options</span><span class="p">:</span>
                    <span class="n">w_connection</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span>

                <span class="c1"># Recreate dynamic sliders for new connection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span> <span class="o">=</span> <span class="n">create_dynamic_sliders</span><span class="p">()</span>

                <span class="c1"># Update UI</span>
                <span class="n">update_ui_layout</span><span class="p">()</span>
                <span class="n">update_ui</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error switching network: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_ui_layout</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the UI layout with new sliders and network dropdown.</span>

<span class="sd">        This function reconstructs the entire UI layout including:</span>
<span class="sd">        - Network dropdown (if available) and connection dropdown in the top row</span>
<span class="sd">        - Button controls and input mode toggles</span>
<span class="sd">        - Parameter sliders arranged in columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">ui</span><span class="p">,</span> <span class="n">slider_columns</span>

        <span class="c1"># Add the dynamic sliders to the UI</span>
        <span class="n">slider_widgets</span> <span class="o">=</span> <span class="p">[</span><span class="n">slider</span> <span class="k">for</span> <span class="n">slider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">slider_widgets</span><span class="p">:</span>
            <span class="n">half</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">slider_widgets</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">col1</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">(</span><span class="n">slider_widgets</span><span class="p">[:</span><span class="n">half</span><span class="p">])</span>
            <span class="n">col2</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">(</span><span class="n">slider_widgets</span><span class="p">[</span><span class="n">half</span><span class="p">:])</span>
            <span class="n">slider_columns</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slider_columns</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([])</span>

        <span class="c1"># Create button row with voltage clamp controls</span>
        <span class="k">if</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>  <span class="c1"># Show voltage clamp amplitude input when toggle is on</span>
            <span class="n">button_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_run</span><span class="p">,</span> <span class="n">w_single</span><span class="p">,</span> <span class="n">w_vclamp</span><span class="p">,</span> <span class="n">w_vclamp_amp</span><span class="p">,</span> <span class="n">w_input_mode</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Hide voltage clamp amplitude input when toggle is off</span>
            <span class="n">button_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_run</span><span class="p">,</span> <span class="n">w_single</span><span class="p">,</span> <span class="n">w_vclamp</span><span class="p">,</span> <span class="n">w_input_mode</span><span class="p">])</span>

        <span class="c1"># Construct the top row - include network dropdown if available</span>
        <span class="c1"># This creates a horizontal layout with network dropdown (if present) and connection dropdown</span>
        <span class="k">if</span> <span class="n">w_network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">connection_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_network</span><span class="p">,</span> <span class="n">w_connection</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">connection_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_connection</span><span class="p">])</span>
        <span class="n">slider_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">w_input_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="p">])</span>
        <span class="n">save_row</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">save_path_text</span><span class="p">,</span> <span class="n">save_button</span><span class="p">])</span>

        <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">connection_row</span><span class="p">,</span> <span class="n">button_row</span><span class="p">,</span> <span class="n">slider_row</span><span class="p">,</span> <span class="n">slider_columns</span><span class="p">,</span> <span class="n">save_row</span><span class="p">])</span>

    <span class="c1"># Function to update UI based on input mode</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_ui</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">()</span>
        <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># Update voltage clamp amplitude if voltage clamp is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;spec_settings&quot;</span><span class="p">][</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_vclamp_amp</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;general_settings&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_vclamp_amp</span><span class="o">.</span><span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">=</span> <span class="n">w_input_mode</span><span class="o">.</span><span class="n">value</span>
        <span class="n">syn_props</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="n">slider</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">slider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_sliders</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_syn_prop</span><span class="p">(</span><span class="o">**</span><span class="n">syn_props</span><span class="p">)</span>

        <span class="c1"># Clear previous results and run simulation</span>
        <span class="n">output_widget</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">output_widget</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_model</span><span class="p">(</span><span class="n">w_input_freq</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_model</span><span class="p">(</span><span class="n">w_input_freq</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_amplitude</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_model</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_ppr_induction_recovery</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>

    <span class="c1"># Function to switch between delay and duration sliders</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">switch_slider</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">w_input_mode</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>  <span class="c1"># Hide delay slider</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Show duration slider</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_delay</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Show delay slider</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>  <span class="c1"># Hide duration slider</span>

    <span class="c1"># Function to handle voltage clamp toggle</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_vclamp_toggle</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle voltage clamp toggle changes to show/hide amplitude input&quot;&quot;&quot;</span>
        <span class="n">update_ui_layout</span><span class="p">()</span>
        <span class="n">clear_output</span><span class="p">()</span>
        <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>

    <span class="c1"># Link widgets to their callback functions</span>
    <span class="n">w_connection</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_connection_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="c1"># Link network dropdown callback only if network dropdown was created</span>
    <span class="k">if</span> <span class="n">w_network</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w_network</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_network_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="n">w_input_mode</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">switch_slider</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="n">w_vclamp</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_vclamp_toggle</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

    <span class="c1"># Hide the duration slider initially until the user selects it</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">w_duration</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>  <span class="c1"># Hide duration slider</span>

    <span class="n">w_single</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">run_single_event</span><span class="p">)</span>
    <span class="n">w_run</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">update_ui</span><span class="p">)</span>

    <span class="c1"># Initial UI setup</span>
    <span class="n">slider_columns</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([])</span>
    <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([])</span>
    <span class="n">update_ui_layout</span><span class="p">()</span>

    <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
    <span class="n">update_ui</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseTuner.stp_frequency_response" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stp_frequency_response</span><span class="p">(</span><span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span> <span class="n">delay</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Analyze synaptic response across different stimulation frequencies.</p>
<p>This method systematically tests how the synapse model responds to different
stimulation frequencies, calculating key short-term plasticity (STP) metrics
for each frequency.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>freqs : list, optional
    List of frequencies to analyze (in Hz). Default covers a wide range from 1-200 Hz.
delay : float, optional
    Delay between pulse trains in ms. Default is 250 ms.
plot : bool, optional
    Whether to plot the results. Default is True.
log_plot : bool, optional
    Whether to use logarithmic scale for frequency axis. Default is True.</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>dict
    Dictionary containing frequency-dependent metrics with keys:
    - 'frequencies': List of tested frequencies
    - 'ppr': Paired-pulse ratios at each frequency
    - 'simple_ppr': Simple paired-pulse ratios (2nd/1st pulse) at each frequency
    - 'induction': Induction values at each frequency
    - 'recovery': Recovery values at each frequency</p>
</details>

<details class="notes:" open>
  <summary>Notes:</summary>
  <p>This method is particularly useful for characterizing the frequency-dependent
behavior of synapses, such as identifying facilitating vs. depressing regimes
or the frequency at which a synapse transitions between these behaviors.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stp_frequency_response</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
    <span class="n">delay</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">log_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze synaptic response across different stimulation frequencies.</span>

<span class="sd">    This method systematically tests how the synapse model responds to different</span>
<span class="sd">    stimulation frequencies, calculating key short-term plasticity (STP) metrics</span>
<span class="sd">    for each frequency.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    freqs : list, optional</span>
<span class="sd">        List of frequencies to analyze (in Hz). Default covers a wide range from 1-200 Hz.</span>
<span class="sd">    delay : float, optional</span>
<span class="sd">        Delay between pulse trains in ms. Default is 250 ms.</span>
<span class="sd">    plot : bool, optional</span>
<span class="sd">        Whether to plot the results. Default is True.</span>
<span class="sd">    log_plot : bool, optional</span>
<span class="sd">        Whether to use logarithmic scale for frequency axis. Default is True.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing frequency-dependent metrics with keys:</span>
<span class="sd">        - &#39;frequencies&#39;: List of tested frequencies</span>
<span class="sd">        - &#39;ppr&#39;: Paired-pulse ratios at each frequency</span>
<span class="sd">        - &#39;simple_ppr&#39;: Simple paired-pulse ratios (2nd/1st pulse) at each frequency</span>
<span class="sd">        - &#39;induction&#39;: Induction values at each frequency</span>
<span class="sd">        - &#39;recovery&#39;: Recovery values at each frequency</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    This method is particularly useful for characterizing the frequency-dependent</span>
<span class="sd">    behavior of synapses, such as identifying facilitating vs. depressing regimes</span>
<span class="sd">    or the frequency at which a synapse transitions between these behaviors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="n">freqs</span><span class="p">,</span>
        <span class="s2">&quot;ppr&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;induction&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;simple_ppr&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>

    <span class="c1"># Store original state</span>
    <span class="n">original_ispk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span>

    <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Analyzing frequencies&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_model</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_amplitude</span><span class="p">()</span>
        <span class="n">ppr</span><span class="p">,</span> <span class="n">induction</span><span class="p">,</span> <span class="n">recovery</span><span class="p">,</span> <span class="n">simple_ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_ppr_induction_recovery</span><span class="p">(</span>
            <span class="n">amp</span><span class="p">,</span> <span class="n">print_math</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ppr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ppr</span><span class="p">))</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">induction</span><span class="p">))</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">recovery</span><span class="p">))</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;simple_ppr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">simple_ppr</span><span class="p">))</span>

    <span class="c1"># Restore original state</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="n">original_ispk</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_frequency_analysis</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">log_plot</span><span class="o">=</span><span class="n">log_plot</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="gap-junction-tuning">Gap Junction Tuning</h2>


<div class="doc doc-object doc-class">



<h3 id="bmtool.synapses.GapJunctionTuner" class="doc doc-heading">
            <code>bmtool.synapses.GapJunctionTuner</code>


</h3>


    <div class="doc doc-contents first">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>bmtool/synapses.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span>
<span class="normal">2271</span>
<span class="normal">2272</span>
<span class="normal">2273</span>
<span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GapJunctionTuner</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mechanisms_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">templates_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">general_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">conn_type_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hoc_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the GapJunctionTuner class.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mechanisms_dir : str</span>
<span class="sd">            Directory path containing the compiled mod files needed for NEURON mechanisms.</span>
<span class="sd">        templates_dir : str</span>
<span class="sd">            Directory path containing cell template files (.hoc or .py) loaded into NEURON.</span>
<span class="sd">        config : str</span>
<span class="sd">            Path to a BMTK config.json file. Can be used to load mechanisms, templates, and other settings.</span>
<span class="sd">        general_settings : dict</span>
<span class="sd">            General settings dictionary including parameters like simulation time step, duration, and temperature.</span>
<span class="sd">        conn_type_settings : dict</span>
<span class="sd">            A dictionary containing connection-specific settings for gap junctions.</span>
<span class="sd">        hoc_cell : object, optional</span>
<span class="sd">            An already loaded NEURON cell object. If provided, template loading and cell creation will be skipped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="o">=</span> <span class="n">hoc_cell</span>

        <span class="k">if</span> <span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mechanisms_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">templates_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Either a config file, both mechanisms_dir and templates_dir, or a hoc_cell must be provided.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">neuron</span><span class="o">.</span><span class="n">load_mechanisms</span><span class="p">(</span><span class="n">mechanisms_dir</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">templates_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this will load both mechs and templates</span>
                <span class="n">load_templates_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Use default general settings if not provided, merge with user-provided</span>
        <span class="k">if</span> <span class="n">general_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">DEFAULT_GAP_JUNCTION_GENERAL_SETTINGS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">DEFAULT_GAP_JUNCTION_GENERAL_SETTINGS</span><span class="p">,</span> <span class="o">**</span><span class="n">general_settings</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="o">=</span> <span class="n">conn_type_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;vclamp&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_syn_params_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_conn_type_settings_from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;conn_type_settings must be provided or config must be given to load gap junction connections from&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">]</span>

        <span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">100.0</span>
        <span class="n">h</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>  <span class="c1"># Time step (resolution) of the simulation in ms</span>
        <span class="n">h</span><span class="o">.</span><span class="n">steps_per_ms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">h</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">h</span><span class="o">.</span><span class="n">celsius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;celsius&quot;</span><span class="p">]</span>

        <span class="c1"># Clean up any existing parallel context before setting up gap junctions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pc_temp</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">ParallelContext</span><span class="p">()</span>
            <span class="n">pc_temp</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>  <span class="c1"># Clean up any existing parallel context</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Ignore errors if no existing context</span>

        <span class="c1"># Force cleanup</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># set up gap junctions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">ParallelContext</span><span class="p">()</span>

        <span class="c1"># Use provided hoc_cell or create new cells</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span>
            <span class="c1"># For gap junctions, we need two cells, so create a second one if using hoc_cell</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="p">)()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="p">)()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="p">)()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">icl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">IClamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell1</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">dur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;iclamp_amp&quot;</span><span class="p">]</span>  <span class="c1"># nA</span>

        <span class="n">sec1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell1</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]]</span>
        <span class="n">sec2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell2</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]]</span>

        <span class="c1"># Use unique IDs to avoid conflicts with existing parallel context setups</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

        <span class="n">unique_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10000</span>  <span class="c1"># Use timestamp as unique base ID</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">source_var</span><span class="p">(</span><span class="n">sec1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_x&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="n">sec1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Gap</span><span class="p">(</span><span class="n">sec1</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">target_var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span><span class="o">.</span><span class="n">_ref_vgap</span><span class="p">,</span> <span class="n">unique_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">source_var</span><span class="p">(</span><span class="n">sec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_x&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">,</span> <span class="n">unique_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="n">sec2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Gap</span><span class="p">(</span><span class="n">sec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">target_var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span><span class="o">.</span><span class="n">_ref_vgap</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">setup_transfer</span><span class="p">()</span>

        <span class="c1"># Now it&#39;s safe to initialize NEURON</span>
        <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_synaptic_params_from_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dynamics_params</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the synaptic models directory from config</span>
            <span class="n">synaptic_models_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;components&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synaptic_models_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">synaptic_models_dir</span><span class="p">:</span>
                <span class="c1"># Handle path variables</span>
                <span class="k">if</span> <span class="n">synaptic_models_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">):</span>
                    <span class="c1"># This is a placeholder, try to resolve it</span>
                    <span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config_path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                    <span class="n">synaptic_models_dir</span> <span class="o">=</span> <span class="n">synaptic_models_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;$COMPONENTS_DIR&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s2">&quot;components&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">synaptic_models_dir</span> <span class="o">=</span> <span class="n">synaptic_models_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$BASE_DIR&quot;</span><span class="p">,</span> <span class="n">config_dir</span><span class="p">)</span>

                <span class="n">dynamics_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">synaptic_models_dir</span><span class="p">,</span> <span class="n">dynamics_params</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dynamics_file</span><span class="p">):</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dynamics_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Dynamics params file not found: </span><span class="si">{</span><span class="n">dynamics_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Error loading synaptic parameters: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_available_networks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load available network names from the config file for the network dropdown feature.</span>

<span class="sd">        This method is automatically called during initialization when a config file is provided.</span>
<span class="sd">        It populates the available_networks list which enables the network dropdown in</span>
<span class="sd">        InteractiveTuner when multiple networks are available.</span>

<span class="sd">        Network Dropdown Behavior:</span>
<span class="sd">        -------------------------</span>
<span class="sd">        - If only one network exists: No network dropdown is shown</span>
<span class="sd">        - If multiple networks exist: Network dropdown appears next to connection dropdown</span>
<span class="sd">        - Networks are loaded from the edges data in the config file</span>
<span class="sd">        - Current network defaults to the first available if not specified during init</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">load_edges_from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Set current network to first available if not specified</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not load networks from config: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_conn_type_settings_from_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="c1"># Load configuration and get nodes and edges using util.py methods</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="c1"># Ensure the config dict knows its source path so path substitutions can be resolved</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;config_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_path</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">load_nodes_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">load_edges_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

        <span class="n">conn_type_settings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Process all edge datasets</span>
        <span class="k">for</span> <span class="n">edge_dataset_name</span><span class="p">,</span> <span class="n">edge_df</span> <span class="ow">in</span> <span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">edge_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Merging with node data to get model templates</span>
            <span class="n">source_node_df</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">target_node_df</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># First, try to deterministically parse the edge_dataset_name for patterns like &#39;&lt;src&gt;_to_&lt;tgt&gt;&#39;</span>
            <span class="k">if</span> <span class="s2">&quot;_to_&quot;</span> <span class="ow">in</span> <span class="n">edge_dataset_name</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_to_&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">src_name</span><span class="p">,</span> <span class="n">tgt_name</span> <span class="o">=</span> <span class="n">parts</span>
                    <span class="k">if</span> <span class="n">src_name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">source_node_df</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">src_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;source_&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tgt_name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">target_node_df</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">tgt_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;target_&quot;</span><span class="p">)</span>

            <span class="c1"># If not found by parsing name, fall back to inspecting a sample edge row</span>
            <span class="k">if</span> <span class="n">source_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_node_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sample_edge</span> <span class="o">=</span> <span class="n">edge_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">sample_edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">source_pop_name</span> <span class="o">=</span> <span class="n">sample_edge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_population&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">target_pop_name</span> <span class="o">=</span> <span class="n">sample_edge</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_population&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">source_pop_name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">source_node_df</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">source_pop_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;source_&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_pop_name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">target_node_df</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">target_pop_name</span><span class="p">]</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;target_&quot;</span><span class="p">)</span>

            <span class="c1"># As a last resort, attempt to heuristically match</span>
            <span class="k">if</span> <span class="n">source_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_node_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pop_name</span><span class="p">,</span> <span class="n">node_df</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">source_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pop_name</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">pop_name</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">source_node_df</span> <span class="o">=</span> <span class="n">node_df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;source_&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pop_name</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="n">edge_dataset_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">pop_name</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">target_node_df</span> <span class="o">=</span> <span class="n">node_df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;target_&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">source_node_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_node_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not find node data for edge dataset </span><span class="si">{</span><span class="n">edge_dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Merge edge data with source node info</span>
            <span class="n">edges_with_source</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">edge_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                <span class="n">source_node_df</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;source_node_id&quot;</span><span class="p">,</span>
                <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Merge with target node info</span>
            <span class="n">edges_with_nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">edges_with_source</span><span class="p">,</span>
                <span class="n">target_node_df</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;target_node_id&quot;</span><span class="p">,</span>
                <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Skip edge datasets that don&#39;t have gap junction information</span>
            <span class="k">if</span> <span class="s2">&quot;is_gap_junction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edges_with_nodes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Filter to only gap junction edges</span>
            <span class="c1"># Handle NaN values in is_gap_junction column</span>
            <span class="n">gap_junction_mask</span> <span class="o">=</span> <span class="n">edges_with_nodes</span><span class="p">[</span><span class="s2">&quot;is_gap_junction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>
            <span class="n">gap_junction_edges</span> <span class="o">=</span> <span class="n">edges_with_nodes</span><span class="p">[</span><span class="n">gap_junction_mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">gap_junction_edges</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get unique edge types from the gap junction edges</span>
            <span class="k">if</span> <span class="s2">&quot;edge_type_id&quot;</span> <span class="ow">in</span> <span class="n">gap_junction_edges</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">edge_types</span> <span class="o">=</span> <span class="n">gap_junction_edges</span><span class="p">[</span><span class="s2">&quot;edge_type_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edge_types</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  <span class="c1"># Single edge type</span>

            <span class="c1"># Process each edge type</span>
            <span class="k">for</span> <span class="n">edge_type_id</span> <span class="ow">in</span> <span class="n">edge_types</span><span class="p">:</span>
                <span class="c1"># Filter edges for this type</span>
                <span class="k">if</span> <span class="n">edge_type_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">edge_type_data</span> <span class="o">=</span> <span class="n">gap_junction_edges</span><span class="p">[</span>
                        <span class="n">gap_junction_edges</span><span class="p">[</span><span class="s2">&quot;edge_type_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">edge_type_id</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_type_data</span> <span class="o">=</span> <span class="n">gap_junction_edges</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_type_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Get representative edge for this type</span>
                <span class="n">edge_info</span> <span class="o">=</span> <span class="n">edge_type_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Process gap junction</span>
                <span class="n">source_model_template</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_model_template&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">target_model_template</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_model_template&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">source_cell_type</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">source_model_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;hoc:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">source_model_template</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;hoc:&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">source_model_template</span>
                <span class="p">)</span>
                <span class="n">target_cell_type</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">target_model_template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;hoc:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_model_template</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;hoc:&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">target_model_template</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">source_cell_type</span> <span class="o">!=</span> <span class="n">target_cell_type</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># Only process gap junctions between same cell types</span>

                <span class="n">source_pop</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_pop_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">target_pop</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_pop_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">conn_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source_pop</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">target_pop</span><span class="si">}</span><span class="s2">_gj&quot;</span>
                <span class="k">if</span> <span class="n">edge_type_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">conn_name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_type_</span><span class="si">{</span><span class="n">edge_type_id</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">conn_settings</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="n">source_cell_type</span><span class="p">,</span>
                    <span class="s2">&quot;sec_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;sec_x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s2">&quot;iclamp_amp&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span>
                    <span class="s2">&quot;spec_syn_param&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="p">}</span>

                <span class="c1"># Load dynamics params</span>
                <span class="n">dynamics_file_name</span> <span class="o">=</span> <span class="n">edge_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dynamics_params&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dynamics_file_name</span> <span class="ow">and</span> <span class="n">dynamics_file_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;NULL&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">syn_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_synaptic_params_from_config</span><span class="p">(</span>
                            <span class="n">config</span><span class="p">,</span> <span class="n">dynamics_file_name</span>
                        <span class="p">)</span>
                        <span class="n">conn_settings</span><span class="p">[</span><span class="s2">&quot;spec_syn_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">syn_params</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Warning: could not load dynamics_params file &#39;</span><span class="si">{</span><span class="n">dynamics_file_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                <span class="n">conn_type_settings</span><span class="p">[</span><span class="n">conn_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn_settings</span>

        <span class="k">return</span> <span class="n">conn_type_settings</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_switch_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_connection</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch to a different gap junction connection and update all related properties.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        new_connection : str</span>
<span class="sd">            Name of the new connection type to switch to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_connection</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection &#39;</span><span class="si">{</span><span class="n">new_connection</span><span class="si">}</span><span class="s2">&#39; not found in conn_type_settings&quot;</span><span class="p">)</span>

        <span class="c1"># Update current connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span> <span class="o">=</span> <span class="n">new_connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">[</span><span class="n">new_connection</span><span class="p">]</span>

        <span class="c1"># Check if cell type changed</span>
        <span class="n">new_cell_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span> <span class="o">!=</span> <span class="n">new_cell_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span> <span class="o">=</span> <span class="n">new_cell_name</span>

            <span class="c1"># Recreate cells</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="p">)()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="p">)()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For hoc_cell, recreate the second cell</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cell2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="p">)()</span>

            <span class="c1"># Recreate IClamp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">IClamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell1</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">dur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;iclamp_amp&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Update IClamp parameters even if same cell type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;iclamp_amp&quot;</span><span class="p">]</span>

        <span class="c1"># Always recreate gap junctions when switching connections</span>
        <span class="c1"># (even for same cell type, sec_id or sec_x might differ)</span>

        <span class="c1"># Clean up previous gap junctions and parallel context</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gap_junc_1&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gap_junc_2&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span>

        <span class="c1"># Properly clean up the existing parallel context</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>  <span class="c1"># Clean up existing parallel context</span>

        <span class="c1"># Force garbage collection and reset NEURON state</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">()</span>

        <span class="c1"># Create a fresh parallel context after cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">ParallelContext</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sec1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell1</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]]</span>
            <span class="n">sec2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell2</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]]</span>

            <span class="c1"># Use unique IDs to avoid conflicts with existing parallel context setups</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

            <span class="n">unique_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10000</span>  <span class="c1"># Use timestamp as unique base ID</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">source_var</span><span class="p">(</span><span class="n">sec1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_x&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="n">sec1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Gap</span><span class="p">(</span><span class="n">sec1</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">target_var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span><span class="o">.</span><span class="n">_ref_vgap</span><span class="p">,</span> <span class="n">unique_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">source_var</span><span class="p">(</span><span class="n">sec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_x&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">,</span> <span class="n">unique_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="n">sec2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Gap</span><span class="p">(</span><span class="n">sec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">target_var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span><span class="o">.</span><span class="n">_ref_vgap</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">setup_transfer</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error setting up gap junctions: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Try to continue with basic setup</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Gap</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell1</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]](</span><span class="mf">0.5</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Gap</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell2</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]](</span><span class="mf">0.5</span><span class="p">))</span>

        <span class="c1"># Reset NEURON state after complete setup</span>
        <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully switched to connection: </span><span class="si">{</span><span class="n">new_connection</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resistance</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a simulation with a specified gap junction resistance.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        resistance : float</span>
<span class="sd">            The gap junction resistance value (in MOhm) to use for the simulation.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method sets up the gap junction resistance, initializes recording vectors for time</span>
<span class="sd">        and membrane voltages of both cells, and runs the NEURON simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">resistance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">resistance</span>

        <span class="n">t_vec</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
        <span class="n">soma_v_1</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
        <span class="n">soma_v_2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
        <span class="n">t_vec</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">_ref_t</span><span class="p">)</span>
        <span class="n">soma_v_1</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell1</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">)</span>
        <span class="n">soma_v_2</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell2</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span> <span class="o">=</span> <span class="n">t_vec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soma_v_1</span> <span class="o">=</span> <span class="n">soma_v_1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soma_v_2</span> <span class="o">=</span> <span class="n">soma_v_2</span>

        <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span> <span class="o">*</span> <span class="n">mV</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">continuerun</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">*</span> <span class="n">ms</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the voltage traces of both cells to visualize gap junction coupling.</span>

<span class="sd">        This method creates a plot showing the membrane potential of both cells over time,</span>
<span class="sd">        highlighting the effect of gap junction coupling when a current step is applied to cell 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t_range</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">100.0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">)</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">)</span>
        <span class="n">tidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">t_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">t_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> 1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="n">v2</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> 2&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> gap junction&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (ms)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Membrane Voltage (mV)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">coupling_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the coupling coefficient between two cells connected by a gap junction.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        t : array-like</span>
<span class="sd">            Time vector.</span>
<span class="sd">        v1 : array-like</span>
<span class="sd">            Voltage trace of the cell receiving the current injection.</span>
<span class="sd">        v2 : array-like</span>
<span class="sd">            Voltage trace of the coupled cell.</span>
<span class="sd">        t_start : float</span>
<span class="sd">            Start time for calculating the steady-state voltage change.</span>
<span class="sd">        t_end : float</span>
<span class="sd">            End time for calculating the steady-state voltage change.</span>
<span class="sd">        dt : float, optional</span>
<span class="sd">            Time step of the simulation. Default is h.dt.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The coupling coefficient, defined as the ratio of voltage change in cell 2</span>
<span class="sd">            to voltage change in cell 1 (V/V).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
        <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_start</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="n">idx1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">-</span> <span class="n">v1</span><span class="p">[</span><span class="n">idx1</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">coupling_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the coupling ratio from the last simulation.</span>

<span class="sd">        Returns the coupling coefficient (dV2/dV1) using the most recent simulation data</span>
<span class="sd">        stored in self.t_vec, self.soma_v_1, and self.soma_v_2.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The coupling coefficient from the last simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
        <span class="n">t_end</span> <span class="o">=</span> <span class="n">t_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">InteractiveTuner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up interactive sliders for tuning gap junction resistance in a Jupyter Notebook.</span>

<span class="sd">        This method creates an interactive UI with:</span>
<span class="sd">        - Connection type selection dropdown</span>
<span class="sd">        - Gap junction resistance slider (logarithmic scale)</span>
<span class="sd">        - Voltage clamp toggle and amplitude input</span>
<span class="sd">        - Run button to simulate and plot the coupling</span>

<span class="sd">        The UI displays:</span>
<span class="sd">        - Voltage traces of both coupled cells</span>
<span class="sd">        - Coupling coefficient (dV2/dV1)</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        Ideal for exploratory parameter tuning and interactive visualization of</span>
<span class="sd">        gap junction coupling between two cells.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">widgets</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">clear_output</span>

        <span class="c1"># Connection dropdown</span>
        <span class="n">connection_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">w_connection</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
            <span class="n">options</span><span class="o">=</span><span class="n">connection_options</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Connection:&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Resistance slider - typical range for gap junctions</span>
        <span class="n">w_resistance</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatLogSlider</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>  <span class="c1"># 1 MOhm default</span>
            <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="nb">min</span><span class="o">=-</span><span class="mi">6</span><span class="p">,</span>  <span class="c1"># 1e-6</span>
            <span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># 1</span>
            <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Resistance (MOhm):&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Voltage clamp toggle</span>
        <span class="n">w_vclamp</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Voltage Clamp&quot;</span><span class="p">,</span>
            <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">tooltip</span><span class="o">=</span><span class="s2">&quot;Toggle voltage clamp mode&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Voltage clamp amplitude</span>
        <span class="n">default_vclamp_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.0</span><span class="p">)</span>
        <span class="n">w_vclamp_amp</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">default_vclamp_amp</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;VClamp Amp (mV):&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Output widget</span>
        <span class="n">output_widget</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>

            <span class="c1"># Update connection if changed</span>
            <span class="k">if</span> <span class="n">w_connection</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">w_connection</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># Update vclamp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span>

            <span class="k">with</span> <span class="n">output_widget</span><span class="p">:</span>
                <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">resistance</span> <span class="o">=</span> <span class="n">w_resistance</span><span class="o">.</span><span class="n">value</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running simulation with resistance = </span><span class="si">{</span><span class="n">resistance</span><span class="si">}</span><span class="s2"> MOhm&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">resistance</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_model</span><span class="p">()</span>
                <span class="c1"># Calculate and print coupling coefficient</span>
                <span class="n">coupling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_ratio</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coupling coefficient (dV2/dV1): </span><span class="si">{</span><span class="n">coupling</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">on_connection_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">w_connection</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">w_connection</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">w_connection</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_connection_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

        <span class="c1"># Run button</span>
        <span class="n">run_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run Simulation&quot;</span><span class="p">)</span>
        <span class="n">run_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">run_simulation</span><span class="p">)</span>

        <span class="c1"># Layout</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">w_connection</span><span class="p">]),</span>
                <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">w_resistance</span><span class="p">]),</span>
                <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">w_vclamp</span><span class="p">,</span> <span class="n">w_vclamp_amp</span><span class="p">]),</span>
                <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">run_button</span><span class="p">]),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stp_frequency_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
        <span class="n">delay</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">log_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze synaptic response across different stimulation frequencies.</span>

<span class="sd">        This method systematically tests how the synapse model responds to different</span>
<span class="sd">        stimulation frequencies, calculating key short-term plasticity (STP) metrics</span>
<span class="sd">        for each frequency.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        freqs : list, optional</span>
<span class="sd">            List of frequencies to analyze (in Hz). Default covers a wide range from 1-200 Hz.</span>
<span class="sd">        delay : float, optional</span>
<span class="sd">            Delay between pulse trains in ms. Default is 250 ms.</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            Whether to plot the results. Default is True.</span>
<span class="sd">        log_plot : bool, optional</span>
<span class="sd">            Whether to use logarithmic scale for frequency axis. Default is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing frequency-dependent metrics with keys:</span>
<span class="sd">            - &#39;frequencies&#39;: List of tested frequencies</span>
<span class="sd">            - &#39;ppr&#39;: Paired-pulse ratios at each frequency</span>
<span class="sd">            - &#39;simple_ppr&#39;: Simple paired-pulse ratios (2nd/1st pulse) at each frequency</span>
<span class="sd">            - &#39;induction&#39;: Induction values at each frequency</span>
<span class="sd">            - &#39;recovery&#39;: Recovery values at each frequency</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method is particularly useful for characterizing the frequency-dependent</span>
<span class="sd">        behavior of synapses, such as identifying facilitating vs. depressing regimes</span>
<span class="sd">        or the frequency at which a synapse transitions between these behaviors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="n">freqs</span><span class="p">,</span>
            <span class="s2">&quot;ppr&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;induction&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;simple_ppr&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="c1"># Store original state</span>
        <span class="n">original_ispk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span>

        <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Analyzing frequencies&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulate_model</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_amplitude</span><span class="p">()</span>
            <span class="n">ppr</span><span class="p">,</span> <span class="n">induction</span><span class="p">,</span> <span class="n">recovery</span><span class="p">,</span> <span class="n">simple_ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_ppr_induction_recovery</span><span class="p">(</span>
                <span class="n">amp</span><span class="p">,</span> <span class="n">print_math</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ppr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ppr</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">induction</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">recovery</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;simple_ppr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">simple_ppr</span><span class="p">))</span>

        <span class="c1"># Restore original state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="n">original_ispk</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_frequency_analysis</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">log_plot</span><span class="o">=</span><span class="n">log_plot</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_frequency_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">log_plot</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the frequency-dependent synaptic properties.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        results : dict</span>
<span class="sd">            Dictionary containing frequency analysis results with keys:</span>
<span class="sd">            - &#39;frequencies&#39;: List of tested frequencies</span>
<span class="sd">            - &#39;ppr&#39;: Paired-pulse ratios at each frequency</span>
<span class="sd">            - &#39;simple_ppr&#39;: Simple paired-pulse ratios at each frequency</span>
<span class="sd">            - &#39;induction&#39;: Induction values at each frequency</span>
<span class="sd">            - &#39;recovery&#39;: Recovery values at each frequency</span>
<span class="sd">        log_plot : bool</span>
<span class="sd">            Whether to use logarithmic scale for frequency axis</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        Creates a figure with three subplots showing:</span>
<span class="sd">        1. Paired-pulse ratios (both normalized and simple) vs. frequency</span>
<span class="sd">        2. Induction vs. frequency</span>
<span class="sd">        3. Recovery vs. frequency</span>

<span class="sd">        Each plot includes a horizontal reference line at y=0 or y=1 to indicate</span>
<span class="sd">        the boundary between facilitation and depression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

        <span class="c1"># Plot both PPR measures</span>
        <span class="k">if</span> <span class="n">log_plot</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ppr&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Normalized PPR&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;simple_ppr&quot;</span><span class="p">],</span> <span class="s2">&quot;s-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Simple PPR&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ppr&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Normalized PPR&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;simple_ppr&quot;</span><span class="p">],</span> <span class="s2">&quot;s-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Simple PPR&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Paired Pulse Ratio&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PPR vs Frequency&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Plot Induction</span>
        <span class="k">if</span> <span class="n">log_plot</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Induction&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Induction vs Frequency&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Plot Recovery</span>
        <span class="k">if</span> <span class="n">log_plot</span><span class="p">:</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;frequencies&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Recovery&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Recovery vs Frequency&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_synaptic_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stp_frequency</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">stp_delay</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a comprehensive table of synaptic parameters for all connections.</span>

<span class="sd">        This method iterates through all available connections, runs simulations to</span>
<span class="sd">        characterize each synapse, and compiles the results into a pandas DataFrame.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        stp_frequency : float, optional</span>
<span class="sd">            Frequency in Hz to use for STP (short-term plasticity) analysis. Default is 50.0 Hz.</span>
<span class="sd">        stp_delay : float, optional</span>
<span class="sd">            Delay in ms between pulse trains for STP analysis. Default is 250.0 ms.</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            Whether to display the resulting table. Default is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame containing synaptic parameters for each connection with columns:</span>
<span class="sd">            - connection: Connection name</span>
<span class="sd">            - rise_time: 20-80% rise time (ms)</span>
<span class="sd">            - decay_time: Decay time constant (ms)</span>
<span class="sd">            - latency: Response latency (ms)</span>
<span class="sd">            - half_width: Response half-width (ms)</span>
<span class="sd">            - peak_amplitude: Peak synaptic current amplitude (pA)</span>
<span class="sd">            - baseline: Baseline current (pA)</span>
<span class="sd">            - ppr: Paired-pulse ratio (normalized)</span>
<span class="sd">            - simple_ppr: Simple paired-pulse ratio (2nd/1st pulse)</span>
<span class="sd">            - induction: STP induction measure</span>
<span class="sd">            - recovery: STP recovery measure</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method temporarily switches between connections to characterize each one,</span>
<span class="sd">        then restores the original connection. The STP metrics are calculated at the</span>
<span class="sd">        specified frequency and delay.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store original connection to restore later</span>
        <span class="n">original_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span>

        <span class="c1"># Initialize results list</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">)</span><span class="si">}</span><span class="s2"> connections...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">conn_name</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Analyzing connections&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Switch to this connection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">conn_name</span><span class="p">)</span>

                <span class="c1"># Run single event analysis</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SingleEvent</span><span class="p">(</span><span class="n">plot_and_print</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Get synaptic properties from the single event</span>
                <span class="n">syn_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_syn_prop</span><span class="p">()</span>

                <span class="c1"># Run STP analysis at specified frequency</span>
                <span class="n">stp_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stp_frequency_response</span><span class="p">(</span>
                    <span class="n">freqs</span><span class="o">=</span><span class="p">[</span><span class="n">stp_frequency</span><span class="p">],</span> <span class="n">delay</span><span class="o">=</span><span class="n">stp_delay</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_plot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

                <span class="c1"># Extract STP metrics for this frequency</span>
                <span class="n">freq_idx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Only one frequency tested</span>
                <span class="n">ppr</span> <span class="o">=</span> <span class="n">stp_results</span><span class="p">[</span><span class="s2">&quot;ppr&quot;</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>
                <span class="n">induction</span> <span class="o">=</span> <span class="n">stp_results</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>
                <span class="n">recovery</span> <span class="o">=</span> <span class="n">stp_results</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>
                <span class="n">simple_ppr</span> <span class="o">=</span> <span class="n">stp_results</span><span class="p">[</span><span class="s2">&quot;simple_ppr&quot;</span><span class="p">][</span><span class="n">freq_idx</span><span class="p">]</span>

                <span class="c1"># Compile results for this connection</span>
                <span class="n">conn_results</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;connection&quot;</span><span class="p">:</span> <span class="n">conn_name</span><span class="p">,</span>
                    <span class="s2">&quot;rise_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rise_time</span><span class="p">),</span>
                    <span class="s2">&quot;decay_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decay_time</span><span class="p">),</span>
                    <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latency&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;half_width&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;half_width&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;peak_amplitude&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="s2">&quot;ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ppr</span><span class="p">),</span>
                    <span class="s2">&quot;simple_ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">simple_ppr</span><span class="p">),</span>
                    <span class="s2">&quot;induction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">induction</span><span class="p">),</span>
                    <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">recovery</span><span class="p">),</span>
                <span class="p">}</span>

                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn_results</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to analyze connection &#39;</span><span class="si">{</span><span class="n">conn_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Add partial results if possible</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;connection&quot;</span><span class="p">:</span> <span class="n">conn_name</span><span class="p">,</span>
                        <span class="s2">&quot;rise_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;decay_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;half_width&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;peak_amplitude&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;simple_ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;induction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="c1"># Restore original connection</span>
        <span class="k">if</span> <span class="n">original_connection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">original_connection</span><span class="p">)</span>

        <span class="c1"># Create DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># Set connection as index for better display</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="c1"># Display the table</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Synaptic Parameters Table:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

            <span class="c1"># Optional: Create a simple bar plot for key metrics</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Synaptic Parameters Across Connections (STP at </span><span class="si">{</span><span class="n">stp_frequency</span><span class="si">}</span><span class="s2">Hz)&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Plot rise/decay times</span>
                <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;rise_time&quot;</span><span class="p">,</span> <span class="s2">&quot;decay_time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rise and Decay Times&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time (ms)&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

                <span class="c1"># Plot PPR metrics</span>
                <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;ppr&quot;</span><span class="p">,</span> <span class="s2">&quot;simple_ppr&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Paired-Pulse Ratios&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

                <span class="c1"># Plot induction</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;STP Induction&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Induction&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

                <span class="c1"># Plot recovery</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;recovery&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;STP Recovery&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Recovery&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not create plots: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionTuner.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">mechanisms_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">templates_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">general_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conn_type_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hoc_cell</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the GapJunctionTuner class.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>mechanisms_dir : str
    Directory path containing the compiled mod files needed for NEURON mechanisms.
templates_dir : str
    Directory path containing cell template files (.hoc or .py) loaded into NEURON.
config : str
    Path to a BMTK config.json file. Can be used to load mechanisms, templates, and other settings.
general_settings : dict
    General settings dictionary including parameters like simulation time step, duration, and temperature.
conn_type_settings : dict
    A dictionary containing connection-specific settings for gap junctions.
hoc_cell : object, optional
    An already loaded NEURON cell object. If provided, template loading and cell creation will be skipped.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mechanisms_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">templates_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">general_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">conn_type_settings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hoc_cell</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the GapJunctionTuner class.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    mechanisms_dir : str</span>
<span class="sd">        Directory path containing the compiled mod files needed for NEURON mechanisms.</span>
<span class="sd">    templates_dir : str</span>
<span class="sd">        Directory path containing cell template files (.hoc or .py) loaded into NEURON.</span>
<span class="sd">    config : str</span>
<span class="sd">        Path to a BMTK config.json file. Can be used to load mechanisms, templates, and other settings.</span>
<span class="sd">    general_settings : dict</span>
<span class="sd">        General settings dictionary including parameters like simulation time step, duration, and temperature.</span>
<span class="sd">    conn_type_settings : dict</span>
<span class="sd">        A dictionary containing connection-specific settings for gap junctions.</span>
<span class="sd">    hoc_cell : object, optional</span>
<span class="sd">        An already loaded NEURON cell object. If provided, template loading and cell creation will be skipped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="o">=</span> <span class="n">hoc_cell</span>

    <span class="k">if</span> <span class="n">hoc_cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mechanisms_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">templates_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Either a config file, both mechanisms_dir and templates_dir, or a hoc_cell must be provided.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">neuron</span><span class="o">.</span><span class="n">load_mechanisms</span><span class="p">(</span><span class="n">mechanisms_dir</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">templates_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this will load both mechs and templates</span>
            <span class="n">load_templates_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Use default general settings if not provided, merge with user-provided</span>
    <span class="k">if</span> <span class="n">general_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">DEFAULT_GAP_JUNCTION_GENERAL_SETTINGS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">DEFAULT_GAP_JUNCTION_GENERAL_SETTINGS</span><span class="p">,</span> <span class="o">**</span><span class="n">general_settings</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="o">=</span> <span class="n">conn_type_settings</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;vclamp&quot;</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_syn_params_cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">available_networks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_network</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_conn_type_settings_from_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;conn_type_settings must be provided or config must be given to load gap junction connections from&quot;</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">]</span>

    <span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">100.0</span>
    <span class="n">h</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>  <span class="c1"># Time step (resolution) of the simulation in ms</span>
    <span class="n">h</span><span class="o">.</span><span class="n">steps_per_ms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">h</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">h</span><span class="o">.</span><span class="n">celsius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;celsius&quot;</span><span class="p">]</span>

    <span class="c1"># Clean up any existing parallel context before setting up gap junctions</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pc_temp</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">ParallelContext</span><span class="p">()</span>
        <span class="n">pc_temp</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>  <span class="c1"># Clean up any existing parallel context</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># Ignore errors if no existing context</span>

    <span class="c1"># Force cleanup</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>

    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># set up gap junctions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">ParallelContext</span><span class="p">()</span>

    <span class="c1"># Use provided hoc_cell or create new cells</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hoc_cell</span>
        <span class="c1"># For gap junctions, we need two cells, so create a second one if using hoc_cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="p">)()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="p">)()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="p">)()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">icl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">IClamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell1</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">dur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">icl</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;iclamp_amp&quot;</span><span class="p">]</span>  <span class="c1"># nA</span>

    <span class="n">sec1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell1</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]]</span>
    <span class="n">sec2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell2</span><span class="o">.</span><span class="n">all</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_id&quot;</span><span class="p">]]</span>

    <span class="c1"># Use unique IDs to avoid conflicts with existing parallel context setups</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

    <span class="n">unique_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10000</span>  <span class="c1"># Use timestamp as unique base ID</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">source_var</span><span class="p">(</span><span class="n">sec1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_x&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="n">sec1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Gap</span><span class="p">(</span><span class="n">sec1</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">target_var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span><span class="o">.</span><span class="n">_ref_vgap</span><span class="p">,</span> <span class="n">unique_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">source_var</span><span class="p">(</span><span class="n">sec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="s2">&quot;sec_x&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">,</span> <span class="n">unique_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="n">sec2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Gap</span><span class="p">(</span><span class="n">sec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">target_var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span><span class="o">.</span><span class="n">_ref_vgap</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">setup_transfer</span><span class="p">()</span>

    <span class="c1"># Now it&#39;s safe to initialize NEURON</span>
    <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionTuner.model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">model</span><span class="p">(</span><span class="n">resistance</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Run a simulation with a specified gap junction resistance.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>resistance : float
    The gap junction resistance value (in MOhm) to use for the simulation.</p>
</details>

<details class="notes:" open>
  <summary>Notes:</summary>
  <p>This method sets up the gap junction resistance, initializes recording vectors for time
and membrane voltages of both cells, and runs the NEURON simulation.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resistance</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a simulation with a specified gap junction resistance.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    resistance : float</span>
<span class="sd">        The gap junction resistance value (in MOhm) to use for the simulation.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    This method sets up the gap junction resistance, initializes recording vectors for time</span>
<span class="sd">    and membrane voltages of both cells, and runs the NEURON simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_1</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">resistance</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gap_junc_2</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">resistance</span>

    <span class="n">t_vec</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
    <span class="n">soma_v_1</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
    <span class="n">soma_v_2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
    <span class="n">t_vec</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">_ref_t</span><span class="p">)</span>
    <span class="n">soma_v_1</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell1</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">)</span>
    <span class="n">soma_v_2</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell2</span><span class="o">.</span><span class="n">soma</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span> <span class="o">=</span> <span class="n">t_vec</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">soma_v_1</span> <span class="o">=</span> <span class="n">soma_v_1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">soma_v_2</span> <span class="o">=</span> <span class="n">soma_v_2</span>

    <span class="n">h</span><span class="o">.</span><span class="n">finitialize</span><span class="p">(</span><span class="o">-</span><span class="mi">70</span> <span class="o">*</span> <span class="n">mV</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">continuerun</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">*</span> <span class="n">ms</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionTuner.plot_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_model</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot the voltage traces of both cells to visualize gap junction coupling.</p>
<p>This method creates a plot showing the membrane potential of both cells over time,
highlighting the effect of gap junction coupling when a current step is applied to cell 1.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the voltage traces of both cells to visualize gap junction coupling.</span>

<span class="sd">    This method creates a plot showing the membrane potential of both cells over time,</span>
<span class="sd">    highlighting the effect of gap junction coupling when a current step is applied to cell 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t_range</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">)</span>
    <span class="n">tidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">t_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">t_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> 1&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="n">v2</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> 2&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> gap junction&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (ms)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Membrane Voltage (mV)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionTuner.coupling_coefficient" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">coupling_coefficient</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the coupling coefficient between two cells connected by a gap junction.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>t : array-like
    Time vector.
v1 : array-like
    Voltage trace of the cell receiving the current injection.
v2 : array-like
    Voltage trace of the coupled cell.
t_start : float
    Start time for calculating the steady-state voltage change.
t_end : float
    End time for calculating the steady-state voltage change.
dt : float, optional
    Time step of the simulation. Default is h.dt.</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>float
    The coupling coefficient, defined as the ratio of voltage change in cell 2
    to voltage change in cell 1 (V/V).</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">coupling_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">h</span><span class="o">.</span><span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the coupling coefficient between two cells connected by a gap junction.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    t : array-like</span>
<span class="sd">        Time vector.</span>
<span class="sd">    v1 : array-like</span>
<span class="sd">        Voltage trace of the cell receiving the current injection.</span>
<span class="sd">    v2 : array-like</span>
<span class="sd">        Voltage trace of the coupled cell.</span>
<span class="sd">    t_start : float</span>
<span class="sd">        Start time for calculating the steady-state voltage change.</span>
<span class="sd">    t_end : float</span>
<span class="sd">        End time for calculating the steady-state voltage change.</span>
<span class="sd">    dt : float, optional</span>
<span class="sd">        Time step of the simulation. Default is h.dt.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        The coupling coefficient, defined as the ratio of voltage change in cell 2</span>
<span class="sd">        to voltage change in cell 1 (V/V).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_start</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">-</span> <span class="n">v2</span><span class="p">[</span><span class="n">idx1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">-</span> <span class="n">v1</span><span class="p">[</span><span class="n">idx1</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionTuner.InteractiveTuner" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">InteractiveTuner</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Sets up interactive sliders for tuning gap junction resistance in a Jupyter Notebook.</p>
<p>This method creates an interactive UI with:
- Connection type selection dropdown
- Gap junction resistance slider (logarithmic scale)
- Voltage clamp toggle and amplitude input
- Run button to simulate and plot the coupling</p>
<p>The UI displays:
- Voltage traces of both coupled cells
- Coupling coefficient (dV2/dV1)</p>


<details class="notes:" open>
  <summary>Notes:</summary>
  <p>Ideal for exploratory parameter tuning and interactive visualization of
gap junction coupling between two cells.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span>
<span class="normal">2646</span>
<span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">InteractiveTuner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up interactive sliders for tuning gap junction resistance in a Jupyter Notebook.</span>

<span class="sd">    This method creates an interactive UI with:</span>
<span class="sd">    - Connection type selection dropdown</span>
<span class="sd">    - Gap junction resistance slider (logarithmic scale)</span>
<span class="sd">    - Voltage clamp toggle and amplitude input</span>
<span class="sd">    - Run button to simulate and plot the coupling</span>

<span class="sd">    The UI displays:</span>
<span class="sd">    - Voltage traces of both coupled cells</span>
<span class="sd">    - Coupling coefficient (dV2/dV1)</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    Ideal for exploratory parameter tuning and interactive visualization of</span>
<span class="sd">    gap junction coupling between two cells.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">widgets</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">clear_output</span>

    <span class="c1"># Connection dropdown</span>
    <span class="n">connection_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn_type_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">w_connection</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
        <span class="n">options</span><span class="o">=</span><span class="n">connection_options</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Connection:&quot;</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Resistance slider - typical range for gap junctions</span>
    <span class="n">w_resistance</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatLogSlider</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>  <span class="c1"># 1 MOhm default</span>
        <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=-</span><span class="mi">6</span><span class="p">,</span>  <span class="c1"># 1e-6</span>
        <span class="nb">max</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># 1</span>
        <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Resistance (MOhm):&quot;</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Voltage clamp toggle</span>
    <span class="n">w_vclamp</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Voltage Clamp&quot;</span><span class="p">,</span>
        <span class="n">button_style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">tooltip</span><span class="o">=</span><span class="s2">&quot;Toggle voltage clamp mode&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Voltage clamp amplitude</span>
    <span class="n">default_vclamp_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vclamp_amp&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.0</span><span class="p">)</span>
    <span class="n">w_vclamp_amp</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatText</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">default_vclamp_amp</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;VClamp Amp (mV):&quot;</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;description_width&quot;</span><span class="p">:</span> <span class="s2">&quot;initial&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Output widget</span>
    <span class="n">output_widget</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_simulation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>

        <span class="c1"># Update connection if changed</span>
        <span class="k">if</span> <span class="n">w_connection</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">w_connection</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Update vclamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vclamp</span> <span class="o">=</span> <span class="n">w_vclamp</span><span class="o">.</span><span class="n">value</span>

        <span class="k">with</span> <span class="n">output_widget</span><span class="p">:</span>
            <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">resistance</span> <span class="o">=</span> <span class="n">w_resistance</span><span class="o">.</span><span class="n">value</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running simulation with resistance = </span><span class="si">{</span><span class="n">resistance</span><span class="si">}</span><span class="s2"> MOhm&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">resistance</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_model</span><span class="p">()</span>
            <span class="c1"># Calculate and print coupling coefficient</span>
            <span class="n">coupling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_ratio</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coupling coefficient (dV2/dV1): </span><span class="si">{</span><span class="n">coupling</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_connection_change</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">w_connection</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_switch_connection</span><span class="p">(</span><span class="n">w_connection</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">w_connection</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_connection_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

    <span class="c1"># Run button</span>
    <span class="n">run_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run Simulation&quot;</span><span class="p">)</span>
    <span class="n">run_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">run_simulation</span><span class="p">)</span>

    <span class="c1"># Layout</span>
    <span class="n">ui</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">w_connection</span><span class="p">]),</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">w_resistance</span><span class="p">]),</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">w_vclamp</span><span class="p">,</span> <span class="n">w_vclamp_amp</span><span class="p">]),</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">run_button</span><span class="p">]),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">output_widget</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="optimization-results">Optimization Results</h2>


<div class="doc doc-object doc-class">



<h3 id="bmtool.synapses.SynapseOptimizationResult" class="doc doc-heading">
            <code>bmtool.synapses.SynapseOptimizationResult</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">



        <p>Container for synaptic parameter optimization results</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>bmtool/synapses.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span>
<span class="normal">2973</span>
<span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SynapseOptimizationResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Container for synaptic parameter optimization results&quot;&quot;&quot;</span>

    <span class="n">optimal_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">achieved_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">target_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">error</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">optimization_path</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div><h2 id="synapse-optimization">Synapse Optimization</h2>


<div class="doc doc-object doc-class">



<h3 id="bmtool.synapses.SynapseOptimizer" class="doc doc-heading">
            <code>bmtool.synapses.SynapseOptimizer</code>


</h3>


    <div class="doc doc-contents first">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>bmtool/synapses.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SynapseOptimizer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuner</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the synapse optimizer with parameter scaling</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        tuner : SynapseTuner</span>
<span class="sd">            Instance of the SynapseTuner class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="n">tuner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">param_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalize parameters to similar scales for better optimization performance.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        params : np.ndarray</span>
<span class="sd">            Original parameter values.</span>
<span class="sd">        param_names : List[str]</span>
<span class="sd">            Names of the parameters corresponding to the values.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Normalized parameter values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">)])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_denormalize_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">normalized_params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">param_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert normalized parameters back to original scale.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        normalized_params : np.ndarray</span>
<span class="sd">            Normalized parameter values.</span>
<span class="sd">        param_names : List[str]</span>
<span class="sd">            Names of the parameters corresponding to the normalized values.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Denormalized parameter values in their original scale.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">normalized_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate standard metrics from the current simulation.</span>

<span class="sd">        This method runs either a single event simulation, a train input simulation,</span>
<span class="sd">        or both based on configuration flags, and calculates relevant synaptic metrics.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        Dict[str, float]</span>
<span class="sd">            Dictionary of calculated metrics including:</span>
<span class="sd">            - induction: measure of synaptic facilitation/depression</span>
<span class="sd">            - ppr: paired-pulse ratio</span>
<span class="sd">            - recovery: recovery from facilitation/depression</span>
<span class="sd">            - max_amplitude: maximum synaptic response amplitude</span>
<span class="sd">            - rise_time: time for synaptic response to rise from 20% to 80% of peak</span>
<span class="sd">            - decay_time: time constant of synaptic response decay</span>
<span class="sd">            - latency: synaptic response latency</span>
<span class="sd">            - half_width: synaptic response half-width</span>
<span class="sd">            - baseline: baseline current</span>
<span class="sd">            - amp: peak amplitude from syn_props</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set these to 0 for when we return the dict</span>
        <span class="n">induction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ppr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">recovery</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">simple_ppr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rise_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">decay_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">half_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">syn_amp</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_single_event</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">SingleEvent</span><span class="p">(</span><span class="n">plot_and_print</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Use the attributes set by SingleEvent method</span>
            <span class="n">rise_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="p">,</span> <span class="s2">&quot;rise_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">decay_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="p">,</span> <span class="s2">&quot;decay_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Get additional syn_props directly</span>
            <span class="n">syn_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_get_syn_prop</span><span class="p">()</span>
            <span class="n">latency</span> <span class="o">=</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latency&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">half_width</span> <span class="o">=</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;half_width&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">syn_amp</span> <span class="o">=</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_train_input</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_simulate_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_delay</span><span class="p">)</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_response_amplitude</span><span class="p">()</span>
            <span class="n">ppr</span><span class="p">,</span> <span class="n">induction</span><span class="p">,</span> <span class="n">recovery</span><span class="p">,</span> <span class="n">simple_ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_calc_ppr_induction_recovery</span><span class="p">(</span>
                <span class="n">amp</span><span class="p">,</span> <span class="n">print_math</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_find_max_amp</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;induction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">induction</span><span class="p">),</span>
            <span class="s2">&quot;ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ppr</span><span class="p">),</span>
            <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">recovery</span><span class="p">),</span>
            <span class="s2">&quot;simple_ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">simple_ppr</span><span class="p">),</span>
            <span class="s2">&quot;max_amplitude&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">amp</span><span class="p">),</span>
            <span class="s2">&quot;rise_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">rise_time</span><span class="p">),</span>
            <span class="s2">&quot;decay_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">decay_time</span><span class="p">),</span>
            <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">latency</span><span class="p">),</span>
            <span class="s2">&quot;half_width&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">half_width</span><span class="p">),</span>
            <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">baseline</span><span class="p">),</span>
            <span class="s2">&quot;amp&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_amp</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_default_cost_function</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">target_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Default cost function that minimizes the squared difference between achieved and target induction.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        metrics : Dict[str, float]</span>
<span class="sd">            Dictionary of calculated metrics from the current simulation.</span>
<span class="sd">        target_metrics : Dict[str, float]</span>
<span class="sd">            Dictionary of target metrics to optimize towards.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float</span>
<span class="sd">            The squared error between achieved and target induction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_metrics</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_objective_function</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">normalized_params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">param_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">cost_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">target_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate error using provided cost function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Denormalize parameters</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_params</span><span class="p">(</span><span class="n">normalized_params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">)</span>

        <span class="c1"># Set parameters</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># just do this and have the SingleEvent handle it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_single_event</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">using_optimizer</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">param_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

        <span class="c1"># Calculate metrics and error</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cost_function</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">target_metrics</span><span class="p">))</span>  <span class="c1"># Ensure error is scalar</span>

        <span class="c1"># Store history with denormalized values</span>
        <span class="n">history_entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">params</span><span class="p">)),</span>
            <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_entry</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">error</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">target_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">param_bounds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">run_single_event</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">run_train_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">train_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">train_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
        <span class="n">cost_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span>
        <span class="n">init_guess</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SynapseOptimizationResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize synaptic parameters to achieve target metrics.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        target_metrics : Dict[str, float]</span>
<span class="sd">            Target values for synaptic metrics (e.g., {&#39;induction&#39;: 0.2, &#39;rise_time&#39;: 0.5})</span>
<span class="sd">        param_bounds : Dict[str, Tuple[float, float]]</span>
<span class="sd">            Bounds for each parameter to optimize (e.g., {&#39;tau_d&#39;: (5, 50), &#39;Use&#39;: (0.1, 0.9)})</span>
<span class="sd">        run_single_event : bool, optional</span>
<span class="sd">            Whether to run single event simulations during optimization (default: False)</span>
<span class="sd">        run_train_input : bool, optional</span>
<span class="sd">            Whether to run train input simulations during optimization (default: True)</span>
<span class="sd">        train_frequency : float, optional</span>
<span class="sd">            Frequency of the stimulus train in Hz (default: 50)</span>
<span class="sd">        train_delay : float, optional</span>
<span class="sd">            Delay between pulse trains in ms (default: 250)</span>
<span class="sd">        cost_function : Optional[Callable]</span>
<span class="sd">            Custom cost function for optimization. If None, uses default cost function</span>
<span class="sd">            that optimizes induction.</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            Optimization method to use (default: &#39;SLSQP&#39;)</span>
<span class="sd">        init_guess : str, optional</span>
<span class="sd">            Method for initial parameter guess (&#39;random&#39; or &#39;middle_guess&#39;)</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        SynapseOptimizationResult</span>
<span class="sd">            Results of the optimization including optimal parameters, achieved metrics,</span>
<span class="sd">            target metrics, final error, and optimization path.</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This function uses scipy.optimize.minimize to find the optimal parameter values</span>
<span class="sd">        that minimize the difference between achieved and target metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_frequency</span> <span class="o">=</span> <span class="n">train_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_delay</span> <span class="o">=</span> <span class="n">train_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_single_event</span> <span class="o">=</span> <span class="n">run_single_event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_train_input</span> <span class="o">=</span> <span class="n">run_train_input</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_bounds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cost_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cost_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_cost_function</span>

        <span class="c1"># Calculate scaling factors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Normalize bounds</span>
        <span class="n">normalized_bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># picks with method of init value we want to use</span>
        <span class="k">if</span> <span class="n">init_guess</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">init_guess</span> <span class="o">==</span> <span class="s2">&quot;middle_guess&quot;</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="p">[(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Pick a valid init guess method: either &#39;random&#39; or &#39;middle_guess&#39;&quot;</span><span class="p">)</span>
        <span class="n">normalized_x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_params</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span> <span class="n">param_names</span><span class="p">)</span>

        <span class="c1"># Run optimization</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_objective_function</span><span class="p">,</span>
            <span class="n">normalized_x0</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">cost_function</span><span class="p">,</span> <span class="n">target_metrics</span><span class="p">),</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">normalized_bounds</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Get final parameters and metrics</span>
        <span class="n">final_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_params</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">param_names</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">final_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">final_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">SynapseOptimizationResult</span><span class="p">(</span>
            <span class="n">optimal_params</span><span class="o">=</span><span class="n">final_params</span><span class="p">,</span>
            <span class="n">achieved_metrics</span><span class="o">=</span><span class="n">final_metrics</span><span class="p">,</span>
            <span class="n">target_metrics</span><span class="o">=</span><span class="n">target_metrics</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span>
            <span class="n">optimization_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_optimization_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">SynapseOptimizationResult</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot optimization results including convergence and final traces.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        result : SynapseOptimizationResult</span>
<span class="sd">            Results from optimization as returned by optimize_parameters()</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method generates three plots:</span>
<span class="sd">        1. Error convergence plot showing how the error decreased over iterations</span>
<span class="sd">        2. Parameter convergence plots showing how each parameter changed</span>
<span class="sd">        3. Final model response with the optimal parameters</span>

<span class="sd">        It also prints a summary of the optimization results including target vs. achieved</span>
<span class="sd">        metrics and the optimal parameter values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure errors are properly shaped for plotting</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">))</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># Plot error convergence</span>
        <span class="n">fig1</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Error Convergence&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Plot parameter convergence</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">optimal_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">num_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span>
        <span class="n">fig2</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">num_params</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">num_params</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">num_params</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">param_names</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">])</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Parameter Value&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Convergence of </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Print final results</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimization Results:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Error: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="p">)</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Target Metrics:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">target_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">achieved</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">achieved_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">achieved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s2">&quot;amplitudes&quot;</span><span class="p">:</span>  <span class="c1"># Skip amplitude array</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">achieved</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (target: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimal Parameters:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimal_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Plot final model response</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_train_input</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_plot_model</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">tstop</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_response_amplitude</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_calc_ppr_induction_recovery</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_single_event</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">SingleEvent</span><span class="p">(</span><span class="n">plot_and_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseOptimizer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">tuner</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the synapse optimizer with parameter scaling</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>tuner : SynapseTuner
    Instance of the SynapseTuner class</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the synapse optimizer with parameter scaling</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    tuner : SynapseTuner</span>
<span class="sd">        Instance of the SynapseTuner class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="n">tuner</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseOptimizer._normalize_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_normalize_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Normalize parameters to similar scales for better optimization performance.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>params : np.ndarray
    Original parameter values.
param_names : List[str]
    Names of the parameters corresponding to the values.</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>np.ndarray
    Normalized parameter values.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_normalize_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">param_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize parameters to similar scales for better optimization performance.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    params : np.ndarray</span>
<span class="sd">        Original parameter values.</span>
<span class="sd">    param_names : List[str]</span>
<span class="sd">        Names of the parameters corresponding to the values.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Normalized parameter values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">)])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseOptimizer._denormalize_params" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_denormalize_params</span><span class="p">(</span><span class="n">normalized_params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Convert normalized parameters back to original scale.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>normalized_params : np.ndarray
    Normalized parameter values.
param_names : List[str]
    Names of the parameters corresponding to the normalized values.</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>np.ndarray
    Denormalized parameter values in their original scale.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_denormalize_params</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">normalized_params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">param_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert normalized parameters back to original scale.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    normalized_params : np.ndarray</span>
<span class="sd">        Normalized parameter values.</span>
<span class="sd">    param_names : List[str]</span>
<span class="sd">        Names of the parameters corresponding to the normalized values.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Denormalized parameter values in their original scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">normalized_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">)]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseOptimizer._calculate_metrics" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_calculate_metrics</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate standard metrics from the current simulation.</p>
<p>This method runs either a single event simulation, a train input simulation,
or both based on configuration flags, and calculates relevant synaptic metrics.</p>


<details class="returns:" open>
  <summary>Returns:</summary>
  <p>Dict[str, float]
    Dictionary of calculated metrics including:
    - induction: measure of synaptic facilitation/depression
    - ppr: paired-pulse ratio
    - recovery: recovery from facilitation/depression
    - max_amplitude: maximum synaptic response amplitude
    - rise_time: time for synaptic response to rise from 20% to 80% of peak
    - decay_time: time constant of synaptic response decay
    - latency: synaptic response latency
    - half_width: synaptic response half-width
    - baseline: baseline current
    - amp: peak amplitude from syn_props</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate standard metrics from the current simulation.</span>

<span class="sd">    This method runs either a single event simulation, a train input simulation,</span>
<span class="sd">    or both based on configuration flags, and calculates relevant synaptic metrics.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    Dict[str, float]</span>
<span class="sd">        Dictionary of calculated metrics including:</span>
<span class="sd">        - induction: measure of synaptic facilitation/depression</span>
<span class="sd">        - ppr: paired-pulse ratio</span>
<span class="sd">        - recovery: recovery from facilitation/depression</span>
<span class="sd">        - max_amplitude: maximum synaptic response amplitude</span>
<span class="sd">        - rise_time: time for synaptic response to rise from 20% to 80% of peak</span>
<span class="sd">        - decay_time: time constant of synaptic response decay</span>
<span class="sd">        - latency: synaptic response latency</span>
<span class="sd">        - half_width: synaptic response half-width</span>
<span class="sd">        - baseline: baseline current</span>
<span class="sd">        - amp: peak amplitude from syn_props</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set these to 0 for when we return the dict</span>
    <span class="n">induction</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ppr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">recovery</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">simple_ppr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rise_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">decay_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">latency</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">half_width</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">baseline</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">syn_amp</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_single_event</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">SingleEvent</span><span class="p">(</span><span class="n">plot_and_print</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Use the attributes set by SingleEvent method</span>
        <span class="n">rise_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="p">,</span> <span class="s2">&quot;rise_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">decay_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="p">,</span> <span class="s2">&quot;decay_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Get additional syn_props directly</span>
        <span class="n">syn_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_get_syn_prop</span><span class="p">()</span>
        <span class="n">latency</span> <span class="o">=</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;latency&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">half_width</span> <span class="o">=</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;half_width&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">syn_amp</span> <span class="o">=</span> <span class="n">syn_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_train_input</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_simulate_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_delay</span><span class="p">)</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_response_amplitude</span><span class="p">()</span>
        <span class="n">ppr</span><span class="p">,</span> <span class="n">induction</span><span class="p">,</span> <span class="n">recovery</span><span class="p">,</span> <span class="n">simple_ppr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_calc_ppr_induction_recovery</span><span class="p">(</span>
            <span class="n">amp</span><span class="p">,</span> <span class="n">print_math</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_find_max_amp</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;induction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">induction</span><span class="p">),</span>
        <span class="s2">&quot;ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">ppr</span><span class="p">),</span>
        <span class="s2">&quot;recovery&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">recovery</span><span class="p">),</span>
        <span class="s2">&quot;simple_ppr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">simple_ppr</span><span class="p">),</span>
        <span class="s2">&quot;max_amplitude&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">amp</span><span class="p">),</span>
        <span class="s2">&quot;rise_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">rise_time</span><span class="p">),</span>
        <span class="s2">&quot;decay_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">decay_time</span><span class="p">),</span>
        <span class="s2">&quot;latency&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">latency</span><span class="p">),</span>
        <span class="s2">&quot;half_width&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">half_width</span><span class="p">),</span>
        <span class="s2">&quot;baseline&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">baseline</span><span class="p">),</span>
        <span class="s2">&quot;amp&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">syn_amp</span><span class="p">),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseOptimizer._default_cost_function" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_default_cost_function</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">target_metrics</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Default cost function that minimizes the squared difference between achieved and target induction.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>metrics : Dict[str, float]
    Dictionary of calculated metrics from the current simulation.
target_metrics : Dict[str, float]
    Dictionary of target metrics to optimize towards.</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>float
    The squared error between achieved and target induction.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_default_cost_function</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">target_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Default cost function that minimizes the squared difference between achieved and target induction.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    metrics : Dict[str, float]</span>
<span class="sd">        Dictionary of calculated metrics from the current simulation.</span>
<span class="sd">    target_metrics : Dict[str, float]</span>
<span class="sd">        Dictionary of target metrics to optimize towards.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float</span>
<span class="sd">        The squared error between achieved and target induction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_metrics</span><span class="p">[</span><span class="s2">&quot;induction&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseOptimizer._objective_function" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_objective_function</span><span class="p">(</span><span class="n">normalized_params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">,</span> <span class="n">cost_function</span><span class="p">,</span> <span class="n">target_metrics</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate error using provided cost function</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_objective_function</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">normalized_params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">param_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">cost_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">target_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate error using provided cost function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Denormalize parameters</span>
    <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_params</span><span class="p">(</span><span class="n">normalized_params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">)</span>

    <span class="c1"># Set parameters</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># just do this and have the SingleEvent handle it</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_single_event</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">using_optimizer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">param_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

    <span class="c1"># Calculate metrics and error</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
    <span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cost_function</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">target_metrics</span><span class="p">))</span>  <span class="c1"># Ensure error is scalar</span>

    <span class="c1"># Store history with denormalized values</span>
    <span class="n">history_entry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">params</span><span class="p">)),</span>
        <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">,</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history_entry</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">error</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseOptimizer.optimize_parameters" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_parameters</span><span class="p">(</span><span class="n">target_metrics</span><span class="p">,</span> <span class="n">param_bounds</span><span class="p">,</span> <span class="n">run_single_event</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">run_train_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">train_frequency</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">train_delay</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">cost_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">init_guess</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Optimize synaptic parameters to achieve target metrics.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>target_metrics : Dict[str, float]
    Target values for synaptic metrics (e.g., {'induction': 0.2, 'rise_time': 0.5})
param_bounds : Dict[str, Tuple[float, float]]
    Bounds for each parameter to optimize (e.g., {'tau_d': (5, 50), 'Use': (0.1, 0.9)})
run_single_event : bool, optional
    Whether to run single event simulations during optimization (default: False)
run_train_input : bool, optional
    Whether to run train input simulations during optimization (default: True)
train_frequency : float, optional
    Frequency of the stimulus train in Hz (default: 50)
train_delay : float, optional
    Delay between pulse trains in ms (default: 250)
cost_function : Optional[Callable]
    Custom cost function for optimization. If None, uses default cost function
    that optimizes induction.
method : str, optional
    Optimization method to use (default: 'SLSQP')
init_guess : str, optional
    Method for initial parameter guess ('random' or 'middle_guess')</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>SynapseOptimizationResult
    Results of the optimization including optimal parameters, achieved metrics,
    target metrics, final error, and optimization path.</p>
</details>

<details class="notes:" open>
  <summary>Notes:</summary>
  <p>This function uses scipy.optimize.minimize to find the optimal parameter values
that minimize the difference between achieved and target metrics.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span>
<span class="normal">3213</span>
<span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_parameters</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">target_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">param_bounds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
    <span class="n">run_single_event</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">run_train_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">train_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">train_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
    <span class="n">cost_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span>
    <span class="n">init_guess</span><span class="o">=</span><span class="s2">&quot;random&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SynapseOptimizationResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize synaptic parameters to achieve target metrics.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    target_metrics : Dict[str, float]</span>
<span class="sd">        Target values for synaptic metrics (e.g., {&#39;induction&#39;: 0.2, &#39;rise_time&#39;: 0.5})</span>
<span class="sd">    param_bounds : Dict[str, Tuple[float, float]]</span>
<span class="sd">        Bounds for each parameter to optimize (e.g., {&#39;tau_d&#39;: (5, 50), &#39;Use&#39;: (0.1, 0.9)})</span>
<span class="sd">    run_single_event : bool, optional</span>
<span class="sd">        Whether to run single event simulations during optimization (default: False)</span>
<span class="sd">    run_train_input : bool, optional</span>
<span class="sd">        Whether to run train input simulations during optimization (default: True)</span>
<span class="sd">    train_frequency : float, optional</span>
<span class="sd">        Frequency of the stimulus train in Hz (default: 50)</span>
<span class="sd">    train_delay : float, optional</span>
<span class="sd">        Delay between pulse trains in ms (default: 250)</span>
<span class="sd">    cost_function : Optional[Callable]</span>
<span class="sd">        Custom cost function for optimization. If None, uses default cost function</span>
<span class="sd">        that optimizes induction.</span>
<span class="sd">    method : str, optional</span>
<span class="sd">        Optimization method to use (default: &#39;SLSQP&#39;)</span>
<span class="sd">    init_guess : str, optional</span>
<span class="sd">        Method for initial parameter guess (&#39;random&#39; or &#39;middle_guess&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    SynapseOptimizationResult</span>
<span class="sd">        Results of the optimization including optimal parameters, achieved metrics,</span>
<span class="sd">        target metrics, final error, and optimization path.</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    This function uses scipy.optimize.minimize to find the optimal parameter values</span>
<span class="sd">    that minimize the difference between achieved and target metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_frequency</span> <span class="o">=</span> <span class="n">train_frequency</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_delay</span> <span class="o">=</span> <span class="n">train_delay</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run_single_event</span> <span class="o">=</span> <span class="n">run_single_event</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run_train_input</span> <span class="o">=</span> <span class="n">run_train_input</span>

    <span class="n">param_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_bounds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cost_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cost_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_cost_function</span>

    <span class="c1"># Calculate scaling factors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Normalize bounds</span>
    <span class="n">normalized_bounds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># picks with method of init value we want to use</span>
    <span class="k">if</span> <span class="n">init_guess</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">init_guess</span> <span class="o">==</span> <span class="s2">&quot;middle_guess&quot;</span><span class="p">:</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="p">[(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Pick a valid init guess method: either &#39;random&#39; or &#39;middle_guess&#39;&quot;</span><span class="p">)</span>
    <span class="n">normalized_x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_params</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span> <span class="n">param_names</span><span class="p">)</span>

    <span class="c1"># Run optimization</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objective_function</span><span class="p">,</span>
        <span class="n">normalized_x0</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">cost_function</span><span class="p">,</span> <span class="n">target_metrics</span><span class="p">),</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">normalized_bounds</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get final parameters and metrics</span>
    <span class="n">final_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_params</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">param_names</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">final_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">final_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">SynapseOptimizationResult</span><span class="p">(</span>
        <span class="n">optimal_params</span><span class="o">=</span><span class="n">final_params</span><span class="p">,</span>
        <span class="n">achieved_metrics</span><span class="o">=</span><span class="n">final_metrics</span><span class="p">,</span>
        <span class="n">target_metrics</span><span class="o">=</span><span class="n">target_metrics</span><span class="p">,</span>
        <span class="n">error</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span>
        <span class="n">optimization_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.SynapseOptimizer.plot_optimization_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_optimization_results</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot optimization results including convergence and final traces.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>result : SynapseOptimizationResult
    Results from optimization as returned by optimize_parameters()</p>
</details>

<details class="notes:" open>
  <summary>Notes:</summary>
  <p>This method generates three plots:
1. Error convergence plot showing how the error decreased over iterations
2. Parameter convergence plots showing how each parameter changed
3. Final model response with the optimal parameters</p>
<p>It also prints a summary of the optimization results including target vs. achieved
metrics and the optimal parameter values.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span>
<span class="normal">3280</span>
<span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_optimization_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">SynapseOptimizationResult</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot optimization results including convergence and final traces.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    result : SynapseOptimizationResult</span>
<span class="sd">        Results from optimization as returned by optimize_parameters()</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    This method generates three plots:</span>
<span class="sd">    1. Error convergence plot showing how the error decreased over iterations</span>
<span class="sd">    2. Parameter convergence plots showing how each parameter changed</span>
<span class="sd">    3. Final model response with the optimal parameters</span>

<span class="sd">    It also prints a summary of the optimization results including target vs. achieved</span>
<span class="sd">    metrics and the optimal parameter values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure errors are properly shaped for plotting</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">))</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Plot error convergence</span>
    <span class="n">fig1</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Error Convergence&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Plot parameter convergence</span>
    <span class="n">param_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">optimal_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">num_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span>
    <span class="n">fig2</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">num_params</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">num_params</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">num_params</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">param_names</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="n">param</span><span class="p">])</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Parameter Value&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Convergence of </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Print final results</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimization Results:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Error: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="p">)</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Target Metrics:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">target_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">achieved</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">achieved_metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">achieved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s2">&quot;amplitudes&quot;</span><span class="p">:</span>  <span class="c1"># Skip amplitude array</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">achieved</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> (target: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimal Parameters:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimal_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Plot final model response</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_train_input</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_plot_model</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">nstim</span><span class="o">.</span><span class="n">interval</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">tstop</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_response_amplitude</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">_calc_ppr_induction_recovery</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_single_event</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">ispk</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">SingleEvent</span><span class="p">(</span><span class="n">plot_and_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="gap-junction-optimization-results">Gap Junction Optimization Results</h2>


<div class="doc doc-object doc-class">



<h3 id="bmtool.synapses.GapOptimizationResult" class="doc doc-heading">
            <code>bmtool.synapses.GapOptimizationResult</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents first">



        <p>Container for gap junction optimization results</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>bmtool/synapses.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3345</span>
<span class="normal">3346</span>
<span class="normal">3347</span>
<span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GapOptimizationResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Container for gap junction optimization results&quot;&quot;&quot;</span>

    <span class="n">optimal_resistance</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">achieved_cc</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">target_cc</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">error</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">optimization_path</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div><h2 id="gap-junction-optimization">Gap Junction Optimization</h2>


<div class="doc doc-object doc-class">



<h3 id="bmtool.synapses.GapJunctionOptimizer" class="doc doc-heading">
            <code>bmtool.synapses.GapJunctionOptimizer</code>


</h3>


    <div class="doc doc-contents first">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>bmtool/synapses.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span>
<span class="normal">3368</span>
<span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span>
<span class="normal">3385</span>
<span class="normal">3386</span>
<span class="normal">3387</span>
<span class="normal">3388</span>
<span class="normal">3389</span>
<span class="normal">3390</span>
<span class="normal">3391</span>
<span class="normal">3392</span>
<span class="normal">3393</span>
<span class="normal">3394</span>
<span class="normal">3395</span>
<span class="normal">3396</span>
<span class="normal">3397</span>
<span class="normal">3398</span>
<span class="normal">3399</span>
<span class="normal">3400</span>
<span class="normal">3401</span>
<span class="normal">3402</span>
<span class="normal">3403</span>
<span class="normal">3404</span>
<span class="normal">3405</span>
<span class="normal">3406</span>
<span class="normal">3407</span>
<span class="normal">3408</span>
<span class="normal">3409</span>
<span class="normal">3410</span>
<span class="normal">3411</span>
<span class="normal">3412</span>
<span class="normal">3413</span>
<span class="normal">3414</span>
<span class="normal">3415</span>
<span class="normal">3416</span>
<span class="normal">3417</span>
<span class="normal">3418</span>
<span class="normal">3419</span>
<span class="normal">3420</span>
<span class="normal">3421</span>
<span class="normal">3422</span>
<span class="normal">3423</span>
<span class="normal">3424</span>
<span class="normal">3425</span>
<span class="normal">3426</span>
<span class="normal">3427</span>
<span class="normal">3428</span>
<span class="normal">3429</span>
<span class="normal">3430</span>
<span class="normal">3431</span>
<span class="normal">3432</span>
<span class="normal">3433</span>
<span class="normal">3434</span>
<span class="normal">3435</span>
<span class="normal">3436</span>
<span class="normal">3437</span>
<span class="normal">3438</span>
<span class="normal">3439</span>
<span class="normal">3440</span>
<span class="normal">3441</span>
<span class="normal">3442</span>
<span class="normal">3443</span>
<span class="normal">3444</span>
<span class="normal">3445</span>
<span class="normal">3446</span>
<span class="normal">3447</span>
<span class="normal">3448</span>
<span class="normal">3449</span>
<span class="normal">3450</span>
<span class="normal">3451</span>
<span class="normal">3452</span>
<span class="normal">3453</span>
<span class="normal">3454</span>
<span class="normal">3455</span>
<span class="normal">3456</span>
<span class="normal">3457</span>
<span class="normal">3458</span>
<span class="normal">3459</span>
<span class="normal">3460</span>
<span class="normal">3461</span>
<span class="normal">3462</span>
<span class="normal">3463</span>
<span class="normal">3464</span>
<span class="normal">3465</span>
<span class="normal">3466</span>
<span class="normal">3467</span>
<span class="normal">3468</span>
<span class="normal">3469</span>
<span class="normal">3470</span>
<span class="normal">3471</span>
<span class="normal">3472</span>
<span class="normal">3473</span>
<span class="normal">3474</span>
<span class="normal">3475</span>
<span class="normal">3476</span>
<span class="normal">3477</span>
<span class="normal">3478</span>
<span class="normal">3479</span>
<span class="normal">3480</span>
<span class="normal">3481</span>
<span class="normal">3482</span>
<span class="normal">3483</span>
<span class="normal">3484</span>
<span class="normal">3485</span>
<span class="normal">3486</span>
<span class="normal">3487</span>
<span class="normal">3488</span>
<span class="normal">3489</span>
<span class="normal">3490</span>
<span class="normal">3491</span>
<span class="normal">3492</span>
<span class="normal">3493</span>
<span class="normal">3494</span>
<span class="normal">3495</span>
<span class="normal">3496</span>
<span class="normal">3497</span>
<span class="normal">3498</span>
<span class="normal">3499</span>
<span class="normal">3500</span>
<span class="normal">3501</span>
<span class="normal">3502</span>
<span class="normal">3503</span>
<span class="normal">3504</span>
<span class="normal">3505</span>
<span class="normal">3506</span>
<span class="normal">3507</span>
<span class="normal">3508</span>
<span class="normal">3509</span>
<span class="normal">3510</span>
<span class="normal">3511</span>
<span class="normal">3512</span>
<span class="normal">3513</span>
<span class="normal">3514</span>
<span class="normal">3515</span>
<span class="normal">3516</span>
<span class="normal">3517</span>
<span class="normal">3518</span>
<span class="normal">3519</span>
<span class="normal">3520</span>
<span class="normal">3521</span>
<span class="normal">3522</span>
<span class="normal">3523</span>
<span class="normal">3524</span>
<span class="normal">3525</span>
<span class="normal">3526</span>
<span class="normal">3527</span>
<span class="normal">3528</span>
<span class="normal">3529</span>
<span class="normal">3530</span>
<span class="normal">3531</span>
<span class="normal">3532</span>
<span class="normal">3533</span>
<span class="normal">3534</span>
<span class="normal">3535</span>
<span class="normal">3536</span>
<span class="normal">3537</span>
<span class="normal">3538</span>
<span class="normal">3539</span>
<span class="normal">3540</span>
<span class="normal">3541</span>
<span class="normal">3542</span>
<span class="normal">3543</span>
<span class="normal">3544</span>
<span class="normal">3545</span>
<span class="normal">3546</span>
<span class="normal">3547</span>
<span class="normal">3548</span>
<span class="normal">3549</span>
<span class="normal">3550</span>
<span class="normal">3551</span>
<span class="normal">3552</span>
<span class="normal">3553</span>
<span class="normal">3554</span>
<span class="normal">3555</span>
<span class="normal">3556</span>
<span class="normal">3557</span>
<span class="normal">3558</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GapJunctionOptimizer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuner</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the gap junction optimizer</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        tuner : GapJunctionTuner</span>
<span class="sd">            Instance of the GapJunctionTuner class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="n">tuner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_objective_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resistance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">target_cc</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate error between achieved and target coupling coefficient</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        resistance : float</span>
<span class="sd">            Gap junction resistance to try</span>
<span class="sd">        target_cc : float</span>
<span class="sd">            Target coupling coefficient to match</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        float : Error between achieved and target coupling coefficient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Run model with current resistance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">resistance</span><span class="p">)</span>

        <span class="c1"># Calculate coupling coefficient</span>
        <span class="n">achieved_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">coupling_coefficient</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Calculate error</span>
        <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">achieved_cc</span> <span class="o">-</span> <span class="n">target_cc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># MSE</span>

        <span class="c1"># Store history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;resistance&quot;</span><span class="p">:</span> <span class="n">resistance</span><span class="p">,</span> <span class="s2">&quot;achieved_cc&quot;</span><span class="p">:</span> <span class="n">achieved_cc</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">error</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_resistance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">target_cc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">resistance_bounds</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">),</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bounded&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GapOptimizationResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize gap junction resistance to achieve a target coupling coefficient.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        target_cc : float</span>
<span class="sd">            Target coupling coefficient to achieve (between 0 and 1)</span>
<span class="sd">        resistance_bounds : tuple, optional</span>
<span class="sd">            (min, max) bounds for resistance search in MOhm. Default is (1e-4, 1e-2).</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            Optimization method to use. Default is &#39;bounded&#39; which works well</span>
<span class="sd">            for single-parameter optimization.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        GapOptimizationResult</span>
<span class="sd">            Container with optimization results including:</span>
<span class="sd">            - optimal_resistance: The optimized resistance value</span>
<span class="sd">            - achieved_cc: The coupling coefficient achieved with the optimal resistance</span>
<span class="sd">            - target_cc: The target coupling coefficient</span>
<span class="sd">            - error: The final error (squared difference between target and achieved)</span>
<span class="sd">            - optimization_path: List of all values tried during optimization</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        Uses scipy.optimize.minimize_scalar with bounded method, which is</span>
<span class="sd">        appropriate for this single-parameter optimization problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Run optimization</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize_scalar</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_objective_function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">target_cc</span><span class="p">,),</span> <span class="n">bounds</span><span class="o">=</span><span class="n">resistance_bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span>
        <span class="p">)</span>

        <span class="c1"># Run final model with optimal resistance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">final_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">coupling_coefficient</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Package up our results</span>
        <span class="n">optimization_result</span> <span class="o">=</span> <span class="n">GapOptimizationResult</span><span class="p">(</span>
            <span class="n">optimal_resistance</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">achieved_cc</span><span class="o">=</span><span class="n">final_cc</span><span class="p">,</span>
            <span class="n">target_cc</span><span class="o">=</span><span class="n">target_cc</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span>
            <span class="n">optimization_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">optimization_result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_optimization_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">GapOptimizationResult</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot optimization results including convergence and final voltage traces</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        result : GapOptimizationResult</span>
<span class="sd">            Results from optimization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># Plot voltage traces</span>
        <span class="n">t_range</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">100.0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">t_vec</span><span class="p">)</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">)</span>
        <span class="n">tidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">t_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">t_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> 1&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="n">v2</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> 2&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (ms)&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Membrane Voltage (mV)&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Optimized Voltage Traces&quot;</span><span class="p">)</span>

        <span class="c1"># Plot error convergence</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">]</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Error Convergence&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

        <span class="c1"># Plot resistance convergence</span>
        <span class="n">resistances</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;resistance&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">]</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">resistances</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Resistance&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Resistance Convergence&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

        <span class="c1"># Print final results</span>
        <span class="n">result_text</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Optimal Resistance: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">optimal_resistance</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Target CC: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">target_cc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Achieved CC: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">achieved_cc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Final Error: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">result_text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parameter_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resistance_range</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a parameter sweep across different resistance values.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        resistance_range : np.ndarray</span>
<span class="sd">            Array of resistance values to test.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing the results of the parameter sweep, with keys:</span>
<span class="sd">            - &#39;resistance&#39;: List of resistance values tested</span>
<span class="sd">            - &#39;coupling_coefficient&#39;: Corresponding coupling coefficients</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method is useful for understanding the relationship between gap junction</span>
<span class="sd">        resistance and coupling coefficient before attempting optimization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;resistance&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;coupling_coefficient&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">resistance</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">resistance_range</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Sweeping resistance values&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">resistance</span><span class="p">)</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">coupling_coefficient</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;resistance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resistance</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;coupling_coefficient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionOptimizer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">tuner</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the gap junction optimizer</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>tuner : GapJunctionTuner
    Instance of the GapJunctionTuner class</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the gap junction optimizer</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    tuner : GapJunctionTuner</span>
<span class="sd">        Instance of the GapJunctionTuner class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="n">tuner</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionOptimizer._objective_function" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_objective_function</span><span class="p">(</span><span class="n">resistance</span><span class="p">,</span> <span class="n">target_cc</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate error between achieved and target coupling coefficient</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>resistance : float
    Gap junction resistance to try
target_cc : float
    Target coupling coefficient to match</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>float : Error between achieved and target coupling coefficient</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span>
<span class="normal">3385</span>
<span class="normal">3386</span>
<span class="normal">3387</span>
<span class="normal">3388</span>
<span class="normal">3389</span>
<span class="normal">3390</span>
<span class="normal">3391</span>
<span class="normal">3392</span>
<span class="normal">3393</span>
<span class="normal">3394</span>
<span class="normal">3395</span>
<span class="normal">3396</span>
<span class="normal">3397</span>
<span class="normal">3398</span>
<span class="normal">3399</span>
<span class="normal">3400</span>
<span class="normal">3401</span>
<span class="normal">3402</span>
<span class="normal">3403</span>
<span class="normal">3404</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_objective_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resistance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">target_cc</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate error between achieved and target coupling coefficient</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    resistance : float</span>
<span class="sd">        Gap junction resistance to try</span>
<span class="sd">    target_cc : float</span>
<span class="sd">        Target coupling coefficient to match</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    float : Error between achieved and target coupling coefficient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Run model with current resistance</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">resistance</span><span class="p">)</span>

    <span class="c1"># Calculate coupling coefficient</span>
    <span class="n">achieved_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">coupling_coefficient</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Calculate error</span>
    <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">achieved_cc</span> <span class="o">-</span> <span class="n">target_cc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># MSE</span>

    <span class="c1"># Store history</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;resistance&quot;</span><span class="p">:</span> <span class="n">resistance</span><span class="p">,</span> <span class="s2">&quot;achieved_cc&quot;</span><span class="p">:</span> <span class="n">achieved_cc</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">error</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionOptimizer.optimize_resistance" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_resistance</span><span class="p">(</span><span class="n">target_cc</span><span class="p">,</span> <span class="n">resistance_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bounded&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Optimize gap junction resistance to achieve a target coupling coefficient.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>target_cc : float
    Target coupling coefficient to achieve (between 0 and 1)
resistance_bounds : tuple, optional
    (min, max) bounds for resistance search in MOhm. Default is (1e-4, 1e-2).
method : str, optional
    Optimization method to use. Default is 'bounded' which works well
    for single-parameter optimization.</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>GapOptimizationResult
    Container with optimization results including:
    - optimal_resistance: The optimized resistance value
    - achieved_cc: The coupling coefficient achieved with the optimal resistance
    - target_cc: The target coupling coefficient
    - error: The final error (squared difference between target and achieved)
    - optimization_path: List of all values tried during optimization</p>
</details>

<details class="notes:" open>
  <summary>Notes:</summary>
  <p>Uses scipy.optimize.minimize_scalar with bounded method, which is
appropriate for this single-parameter optimization problem.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3406</span>
<span class="normal">3407</span>
<span class="normal">3408</span>
<span class="normal">3409</span>
<span class="normal">3410</span>
<span class="normal">3411</span>
<span class="normal">3412</span>
<span class="normal">3413</span>
<span class="normal">3414</span>
<span class="normal">3415</span>
<span class="normal">3416</span>
<span class="normal">3417</span>
<span class="normal">3418</span>
<span class="normal">3419</span>
<span class="normal">3420</span>
<span class="normal">3421</span>
<span class="normal">3422</span>
<span class="normal">3423</span>
<span class="normal">3424</span>
<span class="normal">3425</span>
<span class="normal">3426</span>
<span class="normal">3427</span>
<span class="normal">3428</span>
<span class="normal">3429</span>
<span class="normal">3430</span>
<span class="normal">3431</span>
<span class="normal">3432</span>
<span class="normal">3433</span>
<span class="normal">3434</span>
<span class="normal">3435</span>
<span class="normal">3436</span>
<span class="normal">3437</span>
<span class="normal">3438</span>
<span class="normal">3439</span>
<span class="normal">3440</span>
<span class="normal">3441</span>
<span class="normal">3442</span>
<span class="normal">3443</span>
<span class="normal">3444</span>
<span class="normal">3445</span>
<span class="normal">3446</span>
<span class="normal">3447</span>
<span class="normal">3448</span>
<span class="normal">3449</span>
<span class="normal">3450</span>
<span class="normal">3451</span>
<span class="normal">3452</span>
<span class="normal">3453</span>
<span class="normal">3454</span>
<span class="normal">3455</span>
<span class="normal">3456</span>
<span class="normal">3457</span>
<span class="normal">3458</span>
<span class="normal">3459</span>
<span class="normal">3460</span>
<span class="normal">3461</span>
<span class="normal">3462</span>
<span class="normal">3463</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">optimize_resistance</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">target_cc</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">resistance_bounds</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">),</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bounded&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GapOptimizationResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize gap junction resistance to achieve a target coupling coefficient.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    target_cc : float</span>
<span class="sd">        Target coupling coefficient to achieve (between 0 and 1)</span>
<span class="sd">    resistance_bounds : tuple, optional</span>
<span class="sd">        (min, max) bounds for resistance search in MOhm. Default is (1e-4, 1e-2).</span>
<span class="sd">    method : str, optional</span>
<span class="sd">        Optimization method to use. Default is &#39;bounded&#39; which works well</span>
<span class="sd">        for single-parameter optimization.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    GapOptimizationResult</span>
<span class="sd">        Container with optimization results including:</span>
<span class="sd">        - optimal_resistance: The optimized resistance value</span>
<span class="sd">        - achieved_cc: The coupling coefficient achieved with the optimal resistance</span>
<span class="sd">        - target_cc: The target coupling coefficient</span>
<span class="sd">        - error: The final error (squared difference between target and achieved)</span>
<span class="sd">        - optimization_path: List of all values tried during optimization</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    Uses scipy.optimize.minimize_scalar with bounded method, which is</span>
<span class="sd">    appropriate for this single-parameter optimization problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Run optimization</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">minimize_scalar</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objective_function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">target_cc</span><span class="p">,),</span> <span class="n">bounds</span><span class="o">=</span><span class="n">resistance_bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span>
    <span class="p">)</span>

    <span class="c1"># Run final model with optimal resistance</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">final_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">coupling_coefficient</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Package up our results</span>
    <span class="n">optimization_result</span> <span class="o">=</span> <span class="n">GapOptimizationResult</span><span class="p">(</span>
        <span class="n">optimal_resistance</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
        <span class="n">achieved_cc</span><span class="o">=</span><span class="n">final_cc</span><span class="p">,</span>
        <span class="n">target_cc</span><span class="o">=</span><span class="n">target_cc</span><span class="p">,</span>
        <span class="n">error</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span>
        <span class="n">optimization_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimization_history</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">optimization_result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionOptimizer.plot_optimization_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_optimization_results</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot optimization results including convergence and final voltage traces</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>result : GapOptimizationResult
    Results from optimization</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3465</span>
<span class="normal">3466</span>
<span class="normal">3467</span>
<span class="normal">3468</span>
<span class="normal">3469</span>
<span class="normal">3470</span>
<span class="normal">3471</span>
<span class="normal">3472</span>
<span class="normal">3473</span>
<span class="normal">3474</span>
<span class="normal">3475</span>
<span class="normal">3476</span>
<span class="normal">3477</span>
<span class="normal">3478</span>
<span class="normal">3479</span>
<span class="normal">3480</span>
<span class="normal">3481</span>
<span class="normal">3482</span>
<span class="normal">3483</span>
<span class="normal">3484</span>
<span class="normal">3485</span>
<span class="normal">3486</span>
<span class="normal">3487</span>
<span class="normal">3488</span>
<span class="normal">3489</span>
<span class="normal">3490</span>
<span class="normal">3491</span>
<span class="normal">3492</span>
<span class="normal">3493</span>
<span class="normal">3494</span>
<span class="normal">3495</span>
<span class="normal">3496</span>
<span class="normal">3497</span>
<span class="normal">3498</span>
<span class="normal">3499</span>
<span class="normal">3500</span>
<span class="normal">3501</span>
<span class="normal">3502</span>
<span class="normal">3503</span>
<span class="normal">3504</span>
<span class="normal">3505</span>
<span class="normal">3506</span>
<span class="normal">3507</span>
<span class="normal">3508</span>
<span class="normal">3509</span>
<span class="normal">3510</span>
<span class="normal">3511</span>
<span class="normal">3512</span>
<span class="normal">3513</span>
<span class="normal">3514</span>
<span class="normal">3515</span>
<span class="normal">3516</span>
<span class="normal">3517</span>
<span class="normal">3518</span>
<span class="normal">3519</span>
<span class="normal">3520</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_optimization_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">GapOptimizationResult</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot optimization results including convergence and final voltage traces</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    result : GapOptimizationResult</span>
<span class="sd">        Results from optimization</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Plot voltage traces</span>
    <span class="n">t_range</span> <span class="o">=</span> <span class="p">[</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">100.0</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">t_vec</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">)</span>
    <span class="n">tidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">t_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">t_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> 1&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="n">v2</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">cell_name</span><span class="si">}</span><span class="s2"> 2&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (ms)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Membrane Voltage (mV)&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Optimized Voltage Traces&quot;</span><span class="p">)</span>

    <span class="c1"># Plot error convergence</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">]</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Error Convergence&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

    <span class="c1"># Plot resistance convergence</span>
    <span class="n">resistances</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;resistance&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">optimization_path</span><span class="p">]</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">resistances</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Resistance&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Resistance Convergence&quot;</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

    <span class="c1"># Print final results</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Optimal Resistance: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">optimal_resistance</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Target CC: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">target_cc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Achieved CC: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">achieved_cc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Final Error: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">result_text</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="bmtool.synapses.GapJunctionOptimizer.parameter_sweep" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parameter_sweep</span><span class="p">(</span><span class="n">resistance_range</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Perform a parameter sweep across different resistance values.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>resistance_range : np.ndarray
    Array of resistance values to test.</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>dict
    Dictionary containing the results of the parameter sweep, with keys:
    - 'resistance': List of resistance values tested
    - 'coupling_coefficient': Corresponding coupling coefficients</p>
</details>

<details class="notes:" open>
  <summary>Notes:</summary>
  <p>This method is useful for understanding the relationship between gap junction
resistance and coupling coefficient before attempting optimization.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>bmtool/synapses.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3522</span>
<span class="normal">3523</span>
<span class="normal">3524</span>
<span class="normal">3525</span>
<span class="normal">3526</span>
<span class="normal">3527</span>
<span class="normal">3528</span>
<span class="normal">3529</span>
<span class="normal">3530</span>
<span class="normal">3531</span>
<span class="normal">3532</span>
<span class="normal">3533</span>
<span class="normal">3534</span>
<span class="normal">3535</span>
<span class="normal">3536</span>
<span class="normal">3537</span>
<span class="normal">3538</span>
<span class="normal">3539</span>
<span class="normal">3540</span>
<span class="normal">3541</span>
<span class="normal">3542</span>
<span class="normal">3543</span>
<span class="normal">3544</span>
<span class="normal">3545</span>
<span class="normal">3546</span>
<span class="normal">3547</span>
<span class="normal">3548</span>
<span class="normal">3549</span>
<span class="normal">3550</span>
<span class="normal">3551</span>
<span class="normal">3552</span>
<span class="normal">3553</span>
<span class="normal">3554</span>
<span class="normal">3555</span>
<span class="normal">3556</span>
<span class="normal">3557</span>
<span class="normal">3558</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parameter_sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resistance_range</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a parameter sweep across different resistance values.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    resistance_range : np.ndarray</span>
<span class="sd">        Array of resistance values to test.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing the results of the parameter sweep, with keys:</span>
<span class="sd">        - &#39;resistance&#39;: List of resistance values tested</span>
<span class="sd">        - &#39;coupling_coefficient&#39;: Corresponding coupling coefficients</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    This method is useful for understanding the relationship between gap junction</span>
<span class="sd">    resistance and coupling coefficient before attempting optimization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;resistance&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;coupling_coefficient&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">for</span> <span class="n">resistance</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">resistance_range</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Sweeping resistance values&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">resistance</span><span class="p">)</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">coupling_coefficient</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">soma_v_2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuner</span><span class="o">.</span><span class="n">general_settings</span><span class="p">[</span><span class="s2">&quot;tdur&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;resistance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resistance</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;coupling_coefficient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/cyneuro/bmtool" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "content.code.copy", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/collapse-nav.js"></script>
      
        <script src="../../javascripts/notebook-download.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>